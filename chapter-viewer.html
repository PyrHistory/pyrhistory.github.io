<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heritage Historyâ„¢ - Digital Book Reader</title>
    <!-- PDF.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.css">
    <style>
        /* --- Base Styles (Keep your existing styles) --- */
        :root{--primary:#4a90e2;--secondary:#50e3c2;--accent:#f5a623;--lab-blue:#080e1c;--page:#fff;--text-on-dark:rgba(255,255,255,.9);--text-on-page:#333;--header-h:60px;--page-w:650px;--page-h:842px;--page-padding:15px}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Georgia',serif;background-color:var(--lab-blue);color:var(--text-on-dark);height:100vh;width:100vw;overflow:hidden;display:flex;flex-direction:column;position:fixed;line-height:1.6}
        body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background-image:radial-gradient(circle at 15% 15%,rgba(249,115,22,.12) 0,transparent 45%),radial-gradient(circle at 85% 85%,rgba(197,83,235,.12) 0,transparent 45%),radial-gradient(circle at 85% 15%,rgba(56,189,248,.05) 0,transparent 40%),radial-gradient(circle at 15% 85%,rgba(251,191,36,.08) 0,transparent 40%);animation:ambient-shift 30s ease infinite alternate}
        @keyframes ambient-shift{0%{background-position:0 0,0 0,0 0,0 0}100%{background-position:5% 10%,-5% -5%,10% -5%,-10% 5%}}
        @media (prefers-reduced-motion:reduce){body::before{animation:none!important}}
        #new-toolbar{position:fixed!important;top:15px!important;right:-60px!important;z-index:9999!important;display:flex!important;flex-direction:column!important;gap:10px!important;transition:right .3s ease,bottom .3s ease,transform .3s ease!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);padding:5px!important;border-radius:8px 0 0 8px!important;box-shadow:-2px 2px 10px rgba(0,0,0,.4)!important;width:58px;border:1px solid rgba(255,255,255,.1)}
        #new-toolbar::before{content:"â‰¡";position:absolute;left:-25px;top:50%;transform:translateY(-50%);background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);width:25px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;color:var(--text-on-dark);font-size:20px;box-shadow:-2px 2px 5px rgba(0,0,0,.3);transition:all .3s ease;border:1px solid rgba(255,255,255,.1);border-right:none;cursor:pointer}
        .toolbar-trigger-area{position:fixed;top:0;right:0;width:30px;height:100%;z-index:9998;transition:all .3s ease}
        #new-toolbar.visible{right:0!important;transform:none!important}
        .new-btn{background:rgba(44,62,80,.8)!important;border:1px solid rgba(255,255,255,.15)!important;color:var(--text-on-dark)!important;width:48px!important;height:48px!important;border-radius:4px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:25px!important;cursor:pointer!important;transition:all .2s!important;box-shadow:0 2px 5px rgba(0,0,0,.2)!important;user-select:none!important;flex-shrink:0}
        .new-btn:hover{background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;transform:translateY(-2px)!important}
        .new-btn:active{transform:translateY(1px)!important}
        .new-btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
        .rotated-mode #new-toolbar{top:auto!important;right:50%!important;bottom:-60px!important;transform:translateX(50%)!important;flex-direction:row!important;width:auto!important;height:58px!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:8px 8px 0 0!important;padding:5px 10px!important;box-shadow:0 -2px 10px rgba(0,0,0,.4)!important;border:1px solid rgba(255,255,255,.1);border-bottom:none}
        .rotated-mode #new-toolbar.visible{bottom:0!important;transform:translateX(50%)!important}
        .rotated-mode #new-toolbar::before{left:50%!important;transform:translateX(-50%)!important;top:-25px!important;width:40px!important;height:25px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:4px 4px 0 0!important;content:"â‰¡";padding-bottom:5px;color:var(--text-on-dark);border:1px solid rgba(255,255,255,.1);border-bottom:none;cursor:pointer}
        .rotated-mode .toolbar-trigger-area{top:auto!important;bottom:0!important;left:0!important;transform:none!important;right:auto!important;width:100%!important;height:30px!important}
        .rotated-mode #new-toolbar .new-btn{width:40px!important;height:40px!important;font-size:20px!important;transform: rotate(90deg)}
        .rotated-mode .new-btn:hover {transform: rotate(90deg) scale(1.1);background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}
        .rotated-mode .new-btn:active {transform: rotate(90deg) scale(0.95)}
        .main-container{flex:1;display:flex;justify-content:center!important;align-items:center!important;padding:0;height:100%;width:100%;overflow:hidden;position:relative;background:transparent}
        .book-spread{display:flex;box-shadow:0 10px 35px rgba(0,0,0,.5);position:fixed!important;top:50%!important;left:50%!important;transform-origin:center center;width:auto!important;height:auto!important;transition:transform .3s ease; transform: translate(-50%, -50%)}
        .book-page{width:var(--page-w);height:var(--page-h);background-color:var(--page);position:relative;overflow:hidden; flex-shrink:0;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08);padding:0;}
        .book-page.left{border-right:1px solid rgba(255,255,255,.15);border-radius:3px 0 0 3px}
        .book-page.right{border-left:1px solid rgba(255,255,255,.15);border-radius:0 3px 3px 0}
        .fullscreen-mode:not(.rotated-mode) .book-page.left{border-right:1px solid rgba(255,255,255,.08)!important}

        /* --- START: Modified Page Structure --- */
        /* Container for PDFPageView */
        .page-view-container {
            position: relative;
            width: calc(100% - 2 * var(--page-padding));
            height: calc(100% - 2 * var(--page-padding));
            margin: var(--page-padding);
            overflow: hidden; /* Clip contents */
        }
        /* PDFPageView will create canvas, textLayer, annotationLayer inside this */
        /* --- END: Modified Page Structure --- */

        .page-number{display:none}
        .page-loading-overlay{position:absolute;inset:var(--page-padding);background:rgba(255,255,255,.6);z-index:50;display:none;justify-content:center;align-items:center;border-radius:3px}
        .page-loading-spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(0,0,0,.1);border-top-color:var(--primary);animation:spin 1s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .page-edge-nav{position:absolute;top:0;height:100%;width:50px;cursor:pointer;z-index:10;transition:background-color .2s;-webkit-tap-highlight-color:transparent}
        .page-edge-nav:hover{background-color:rgba(0,0,0,.03)}
        .page-edge-left{left:0;border-radius:3px 0 0 3px}
        .page-edge-right{right:0;border-radius:0 3px 3px 0}
        .page-edge-left:hover::after,.page-edge-right:hover::after{content:"";position:absolute;top:50%;width:12px;height:12px;border-style:solid;border-color:rgba(0,0,0,.6);border-width:2px 2px 0 0;opacity:.8}
        .page-edge-left:hover::after{left:18px;transform:translateY(-50%) rotate(-135deg)}
        .page-edge-right:hover::after{right:18px;transform:translateY(-50%) rotate(45deg)}
        .fullscreen-mode .book-page.right{display:none!important}
        .fullscreen-mode .book-page.left{max-width:95vw;max-height:95vh;width:auto;height:auto;border-radius:5px!important;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08)!important;padding:0;}
        .fullscreen-mode .page-view-container { margin: var(--page-padding); } /* Keep padding */
        .rotated-mode .book-page.left{width:var(--page-w)!important;height:var(--page-h)!important;border-radius:0!important;border:none!important;padding:0 !important;background-color:var(--page);display:flex;justify-content:center;align-items:center}
        .rotated-mode .page-view-container { margin: 10px !important; width: calc(100% - 20px); height: calc(100% - 20px); }
        .rotated-mode .book-page.right{display:none!important}
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page{width:var(--page-w);height:var(--page-h)}
        .book-page.right.placeholder-page{background-color:var(--page)!important;border-left:1px solid rgba(0,0,0,.1);position:relative;display:flex!important;justify-content:center;align-items:center}
        .book-page.right.placeholder-page::after{content:"End of document";font-size:14px;font-style:italic;color:rgba(0,0,0,.5)}
        .book-page.right.placeholder-page .page-view-container,.book-page.right.placeholder-page .page-edge-nav,.book-page.right.placeholder-page .page-loading-overlay{display:none}
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left,
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) { position: relative; }
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left { border-right: none !important; }
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) { border-left: none !important; }
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left .page-view-container::after { content: ''; position: absolute; top: 0; right: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to left, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 0 2px 2px 0; }
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) .page-view-container::before { content: ''; position: absolute; top: 0; left: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to right, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 2px 0 0 2px; }
        body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right.placeholder-page { border-left: 1px solid rgba(0,0,0,.1) !important; }
        .toc-panel{position:fixed;z-index:10000;display:none;color:var(--text-on-page); left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;height:80vh;background:#f0f4f8;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,.5);flex-direction:column;overflow:hidden}
        .toc-panel.visible,.loading-overlay.visible{display:flex!important}
        .toc-header{padding:15px 20px;background:var(--primary);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
        .toc-header .notes-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0 5px;line-height:1}
        .toc-content{flex:1;padding:10px 20px;overflow-y:auto}
        .toc-chapter{padding:8px 0;border-bottom:1px solid #d8dfe6}
        .toc-chapter-title{font-weight:700;color:var(--primary);cursor:pointer;padding:5px 0}
        .toc-chapter-title:hover,.toc-section:hover{color:var(--accent)}
        .toc-sections{padding-left:20px;margin-top:5px}
        .toc-section{padding:4px 0;cursor:pointer;color:#4a5568;font-size:.95em}
        .loading-overlay{position:fixed;inset:0;background:rgba(8,14,28,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:10001;display:none;justify-content:center;align-items:center;flex-direction:column}
        .loading-spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:15px}
        .loading-message{font-size:16px;color:var(--text-on-dark)}
        #status-indicator{display:none}
        .page-slider-container{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:700px;padding:14px 20px;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-bottom:none;box-shadow:0 -4px 20px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;z-index:9998;transition:bottom .35s cubic-bezier(.2,.9,.3,1),transform .35s cubic-bezier(.2,.9,.3,1), left .35s cubic-bezier(.2,.9,.3,1);border-radius:16px 16px 0 0}
        .page-slider-container.visible{bottom:0}
        .page-slider-track{width:100%;margin-bottom:8px;padding:0 10px}
        .page-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);outline:none;border-radius:3px;overflow:visible;cursor:pointer;transition:height .2s}
        .page-slider:hover{height:8px}
        .page-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition:all .2s ease;margin-top:-7px}
        .page-slider::-webkit-slider-thumb:hover{width:24px;height:24px;margin-top:-8px}
        .page-slider::-webkit-slider-runnable-track{height:100%;background:linear-gradient(to right,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%));border-radius:3px}
        .page-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4)}
        .page-slider::-moz-range-thumb:hover{width:24px;height:24px}
        .page-slider::-moz-range-progress{background-color:var(--accent);height:100%;border-radius:3px}
        .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);height:100%;border-radius:3px}
        .page-slider-info{font-size:12px;color:var(--text-on-dark);font-weight:500;letter-spacing:.3px;opacity:.8}
        .rotated-mode .page-slider-container{bottom:50%!important;left:-80px!important;top:auto!important;transform:translateY(50%)!important;width:60px!important;height:70vh!important;max-width:none!important;max-height:500px;flex-direction:column-reverse!important;padding:10px 5px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 12px 12px 0!important;box-shadow:2px 0 20px rgba(0,0,0,.4)!important}
        .rotated-mode .page-slider-container.visible{left:0!important}
        .rotated-mode .page-slider-track{width:100%!important;height:100%!important;margin-bottom:0!important;padding:10px 0!important;display:flex;align-items:center;flex:1}
        .rotated-mode .page-slider{width:6px!important;height:100%!important;writing-mode:vertical-lr!important;-webkit-appearance:slider-vertical!important;appearance:slider-vertical;margin:0 auto!important;padding:0!important;background:rgba(255,255,255,.1)!important;border-radius:3px}
        .rotated-mode .page-slider::-webkit-slider-runnable-track{width:6px!important;height:100%;background:linear-gradient(to top,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%))!important;border-radius:3px}
        .rotated-mode .page-slider::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width:20px!important;height:20px!important;border-radius: 50%;background: var(--accent);cursor: pointer;border: 3px solid rgba(28,37,54,.9)!important;box-shadow: 0 1px 6px rgba(0,0,0,.4);transition: all .2s ease;margin-top:0!important;margin-left:-7px!important}
        .rotated-mode .page-slider:hover::-webkit-slider-thumb {width: 24px !important;height: 24px !important;margin-left: -9px !important}
        .rotated-mode .page-slider::-moz-range-thumb{width: 20px;height: 20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition: all .2s ease}
        .rotated-mode .page-slider:hover::-moz-range-thumb {width: 24px;height: 24px}
        .rotated-mode .page-slider::-moz-range-progress{background-color:var(--accent)!important;width:6px!important;border-radius:3px}
        .rotated-mode .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);width:6px!important;border-radius:3px}
        .rotated-mode .page-slider-info{transform:rotate(90deg);white-space:nowrap;margin-bottom:15px;padding-top:10px;color:var(--text-on-dark)}
        #page-slider-trigger-zone {position: fixed;bottom: 0;left: 0;width: 100%;height: 30px;z-index: 9997;pointer-events: auto}
        .rotated-mode #page-slider-trigger-zone {bottom: auto;top: 50%;left: 0;width: 60px;height: 50%}

        /* --- START: Layer Styles (Provided by PDFPageView) --- */
        /* These styles ensure layers created by PDFPageView are positioned correctly */
        .page .canvasWrapper { /* Container for canvas */
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; /* Important for clipping canvas */
            z-index: 1;
        }
        .page canvas { /* Canvas itself */
            display: block;
            position: absolute; /* Ensure positioning within wrapper */
            top: 0; left: 0;
            width: 100%; height: 100%;
            /* object-fit: contain; /* Handled by viewport scaling */
        }
        .page .textLayer {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            color: transparent; /* Hide original text */
            font-family: sans-serif;
            line-height: 1;
            text-align: initial; /* Reset text alignment */
            overflow: hidden;
            opacity: 1; /* Make visible for interactions */
            user-select: none;
            -webkit-user-select: none;
            pointer-events: none; /* Layer doesn't capture events */
            z-index: 2; /* Above canvas */
        }
        .page .textLayer > span { /* Spans created by TextLayerBuilder */
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
            /* font-size, transform set by PDFPageView */
            pointer-events: none; /* Individual spans off by default */
            color: transparent; /* Ensure text remains hidden */
            border-radius: 2px; /* Optional styling */
        }
        .page .annotationLayer {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            overflow: hidden;
            pointer-events: none; /* Layer doesn't capture events */
            z-index: 3; /* Above text layer */
        }
        .page .annotationLayer section { /* Styles from pdf_viewer.css */
            position: absolute;
            pointer-events: auto; /* Annotations ARE interactive */
        }
        .page .annotationLayer .linkAnnotation > a { /* Styles from pdf_viewer.css, slightly adapted */
            position: absolute;
            font-size: 1em; top: 0; left: 0; width: 100%; height: 100%;
            border: 1px solid transparent;
            transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
        }
        .page .annotationLayer .linkAnnotation > a:hover {
            cursor: pointer;
            background-color: rgba(255, 255, 0, 0.2); /* Standard yellow highlight */
            border: 1px solid rgba(255, 255, 0, 0.5);
            box-shadow: 0px 0px 2px rgba(255, 255, 0, 0.5);
        }
        /* --- END: Layer Styles --- */

        /* --- START: Keyword Interaction Styles --- */
        .textLayer .keyword-interactive {
            pointer-events: auto !important; /* Keywords ARE interactive */
            cursor: pointer;
            transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            /* Ensure spans don't inherit transparency */
            color: transparent; /* Keep base text transparent */
            background: transparent; /* Default background */
        }
        .textLayer .keyword-hover-highlight {
            background: linear-gradient(to right, rgba(255, 100, 0, 0.4), rgba(255, 191, 36, 0.4)) !important;
            box-shadow: 0 0 3px rgba(255, 165, 0, 0.5);
        }
        /* --- END: Keyword Interaction Styles --- */

        /* --- START: Dictionary Pop-up Styles --- */
        #definition-popup { display: none; position: fixed; z-index: 10002; background: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 10px 15px; max-width: 300px; min-width: 150px; font-family: sans-serif; font-size: 14px; color: #333; line-height: 1.4; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; transform: scale(0.95); opacity: 0; pointer-events: none; }
        #definition-popup.visible { display: block; transform: scale(1); opacity: 1; pointer-events: auto; }
        #close-popup-btn { position: absolute; top: 3px; right: 3px; background: none; border: none; font-size: 18px; cursor: pointer; color: #888; padding: 0 5px; line-height: 1; }
        #close-popup-btn:hover { color: #333; }
        #popup-word { display: block; margin-bottom: 5px; color: var(--primary); font-weight: bold; }
        #popup-definition { max-height: 150px; overflow-y: auto; }
        #popup-definition i { color: #777; }
        #popup-definition span.error-message { color: #e74c3c; }
        /* --- END: Dictionary Pop-up Styles --- */
    </style>
</head>
<body>
    <div id="new-toolbar"></div>
    <div class="toolbar-trigger-area" id="toolbar-trigger-area"></div>
    <div id="status-indicator">Status: Initializing...</div>
    <div class="main-container">
        <div class="book-spread">
            <div class="book-page left">
                <!-- Container for PDFPageView -->
                <div class="page-view-container" id="left-page-container">
                    <!-- PDFPageView creates canvas, textLayer, annotationLayer here -->
                </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="left-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
            <div class="book-page right placeholder-page">
                 <!-- Container for PDFPageView -->
                 <div class="page-view-container" id="right-page-container">
                     <!-- PDFPageView creates canvas, textLayer, annotationLayer here -->
                 </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="right-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
        </div>
    </div>
    <div class="toc-panel" id="toc-panel"></div>
    <div class="loading-overlay" id="loading-overlay"></div>
    <div class="page-slider-container" id="page-slider-container"></div>
    <div id="page-slider-trigger-zone"></div>

    <div id="definition-popup">
        <button id="close-popup-btn">Ã—</button>
        <strong id="popup-word">Word</strong>
        <div id="popup-definition">Definition</div>
    </div>

    <script>
        // Populate Inner HTML directly (Toolbar, TOC, Loading, Slider)
        document.getElementById('new-toolbar').innerHTML = `<button class="new-btn" id="single-page-btn" title="Single Page View">â˜°</button><button class="new-btn" id="double-page-btn" title="Double Page View">â—«</button><button class="new-btn" id="rotate-btn" title="Rotate View">ðŸ“±</button><button class="new-btn" id="toc-btn" title="Table of Contents" disabled>ðŸ“‘</button>`;
        document.getElementById('toc-panel').innerHTML = `<div class="toc-header"><span>Table of Contents</span><button class="notes-close" id="close-toc-btn">Ã—</button></div><div class="toc-content"><div id="toc-list">Loading...</div></div>`;
        document.getElementById('loading-overlay').innerHTML = `<div class="loading-spinner"></div><div class="loading-message">Processing...</div>`;
        document.getElementById('page-slider-container').innerHTML = `<div class="page-slider-track"><input type="range" id="page-slider" class="page-slider" min="1" max="1" value="1" style="--slider-percent: 0%"></div><div class="page-slider-info"><span id="current-page-display">Page 1</span> of <span id="total-pages-display">1</span></div>`;
    </script>
    <script>
        'use strict'; // Enable strict mode

        // --- UI Elements ---
        const definitionPopup = document.getElementById('definition-popup');
        const popupWord = document.getElementById('popup-word');
        const popupDefinition = document.getElementById('popup-definition');
        const closePopupBtn = document.getElementById('close-popup-btn');

        // --- State Variables ---
        let keywordDefinitions = {}; // Stores { keyword_lowercase: definition }
        let pageKeywords = {}; // Stores { pageNum: [keywordOriginalCase1, ...] }
        let leftPageView = null; // Holds the PDFPageView instance for the left page
        let rightPageView = null; // Holds the PDFPageView instance for the right page
        let currentScale = 1.0; // Initial scale factor (will be adjusted by fit)

        // Use the pdfjs library namespaces
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        const pdfjsViewer = window['pdfjs-dist/web/pdf_viewer'];

        // Set worker source - IMPORTANT!
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const book={title:"No Document",totalPages:0,currentPage:1,isDoublePageView:true,pdfDocument:null,outline:[]};
        const user={readingProgress:{furthestPage:1}};
        let toolbarTimer=null;
        let toolbarHover=!1;
        // Note: Page cache using ImageData is removed as PDFPageView handles rendering internally
        let PAGE_PADDING=15;
        let resizeTimer;
        let sliderHideTimeout=null;
        const updateStatus=m=>console.log("Status:",m);

        // --- PDF.js Viewer Components ---
        const linkService = new pdfjsViewer.SimpleLinkService();
        const eventBus = new pdfjsViewer.EventBus();
        linkService.setViewer(eventBus); // Connect link service to event bus

        // --- Toolbar Logic (Keep existing) ---
        function manageToolbar(s=null){const t=document.getElementById('new-toolbar');if(!t)return;clearTimeout(toolbarTimer);const show=s??toolbarHover;if(show){t.classList.add('visible')}else{toolbarTimer=setTimeout(()=>{if(!toolbarHover)t.classList.remove('visible')},500)}}
        function setupToolbarHover(){const t=document.getElementById('new-toolbar'),a=document.getElementById('toolbar-trigger-area'),h=t;if(!t||!a){console.error("Toolbar/trigger missing");return}const enter=()=>{toolbarHover=true;manageToolbar(true)};const leave=()=>{toolbarHover=false;manageToolbar(false)};a.addEventListener('mouseenter',enter);t.addEventListener('mouseenter',enter);a.addEventListener('mouseleave',leave);t.addEventListener('mouseleave',leave);h.addEventListener('click',e=>{if(e.target.closest('.new-btn'))return;const r=h.getBoundingClientRect(),i=document.body.classList.contains('rotated-mode');let c=false;const w=25,rh=25;if(i){if(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY<r.top&&e.clientY>=r.top-rh)c=true}else{if(e.clientY>=r.top&&e.clientY<=r.bottom&&e.clientX<r.left&&e.clientX>=r.left-w)c=true}if(c){toolbarHover=!t.classList.contains('visible');manageToolbar()}});updateStatus("Toolbar setup.")}

        // --- Page Loading Utility ---
        function showPageLoading(pageSide){ // 'left' or 'right'
            const containerId = `${pageSide}-page-container`;
            document.getElementById(containerId)?.closest('.book-page')?.querySelector('.page-loading-overlay')?.style.setProperty('display','flex');
        }
        function hidePageLoading(pageSide){
             const containerId = `${pageSide}-page-container`;
             document.getElementById(containerId)?.closest('.book-page')?.querySelector('.page-loading-overlay')?.style.setProperty('display','none');
        }

        // --- Keyword Enhancement Function ---
        function enhanceTextLayerWithKeywords(pageNum, textLayerDiv) {
            if (!textLayerDiv) {
                // console.warn(`enhanceTextLayer: No textLayerDiv provided for page ${pageNum}`);
                return;
            }
            // Determine if it's a glossary page
            const maxKeywordPage = Math.max(0, ...Object.keys(pageKeywords).map(Number));
            const isGlossaryPage = maxKeywordPage > 0 && pageNum > maxKeywordPage;
            const keywordsForPage = !isGlossaryPage ? (pageKeywords[pageNum] || []) : [];

            if (keywordsForPage.length > 0 && Object.keys(keywordDefinitions).length > 0) {
                // Spans are direct children or nested within divs in PDF.js v3+ text layers
                const renderedSpans = textLayerDiv.querySelectorAll('span');

                renderedSpans.forEach(span => {
                    if (!span.textContent.trim()) return;
                    const spanText = span.textContent;

                    for (const keyword /* original case */ of keywordsForPage) {
                        const escapedKeyword = keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const regex = new RegExp(`\\b(${escapedKeyword})\\b`, 'gi');

                        if (regex.test(spanText)) {
                            const keywordLower = keyword.toLowerCase();
                            const definition = keywordDefinitions[keywordLower];

                            if (definition) {
                                span.classList.add('keyword-interactive');
                                span.dataset.keyword = keyword;
                                span.dataset.definition = definition;
                                span.style.pointerEvents = 'auto'; // Crucial: Make the span clickable
                                span.title = "Click for definition"; // Basic tooltip

                                // Attach event listeners directly to this span
                                // (Event delegation is an alternative for performance with many keywords)
                                span.addEventListener('mouseover', handleKeywordMouseOver);
                                span.addEventListener('mouseout', handleKeywordMouseOut);
                                span.addEventListener('click', handleKeywordClick);

                                // If a keyword match is found for this span, no need to check others for the same span
                                break;
                            }
                        }
                    }
                });
                // updateStatus(`Keyword enhancement complete for page ${pageNum}. Found ${textLayerDiv.querySelectorAll('.keyword-interactive').length} interactive keywords.`);
            } else {
                 // updateStatus(`No keywords to enhance for page ${pageNum}`);
            }
        }

        // --- Keyword Event Handlers ---
        function handleKeywordMouseOver(event) {
            if (event.target.classList.contains('keyword-interactive')) {
                event.target.classList.add('keyword-hover-highlight');
            }
        }
        function handleKeywordMouseOut(event) {
            if (event.target.classList.contains('keyword-interactive')) {
                event.target.classList.remove('keyword-hover-highlight');
            }
        }
        function handleKeywordClick(event) {
             if (event.target.classList.contains('keyword-interactive')) {
                event.stopPropagation(); // Prevent page turn clicks etc.
                const keyword = event.target.dataset.keyword;
                const definition = event.target.dataset.definition;
                if (keyword && definition) {
                    const rect = event.target.getBoundingClientRect();
                    showDefinitionPopup(keyword, definition, rect.left, rect.bottom);
                } else {
                    console.warn("Clicked interactive keyword but data attributes missing:", event.target);
                }
            }
        }

        // --- PDFPageView Rendering ---
        async function renderPageUsingView(pageNum, pageSide) { // pageSide is 'left' or 'right'
            const containerId = `${pageSide}-page-container`;
            const container = document.getElementById(containerId);
            const pageElement = container?.closest('.book-page');
            let pageView = (pageSide === 'left') ? leftPageView : rightPageView;

             // Clear previous content and destroy old view if it exists
            if (pageView) {
                try {
                    pageView.destroy();
                    updateStatus(`Destroyed previous PageView for ${pageSide}`);
                } catch (destroyErr) {
                    console.warn(`Error destroying ${pageSide} PageView:`, destroyErr);
                }
                pageView = null;
                if (pageSide === 'left') leftPageView = null; else rightPageView = null;
            }
             if (container) container.innerHTML = ''; // Clear container manually

            if (!book.pdfDocument || !container || !pageElement || pageNum < 1 || pageNum > book.totalPages) {
                if (pageElement) pageElement.style.visibility = 'hidden';
                hidePageLoading(pageSide);
                return; // Nothing to render
            }

            pageElement.style.visibility = 'visible';
            showPageLoading(pageSide);
            pageElement.classList.remove('placeholder-page');

            try {
                const page = await book.pdfDocument.getPage(pageNum);
                 // Calculate scale to fit container (respecting padding)
                const availableWidth = container.clientWidth;
                const availableHeight = container.clientHeight;
                if (availableWidth <= 0 || availableHeight <= 0) throw new Error("Invalid container dimensions for scaling");

                const defaultViewport = page.getViewport({ scale: 1 });
                const scale = Math.min(availableWidth / defaultViewport.width, availableHeight / defaultViewport.height);
                currentScale = scale; // Store current scale if needed elsewhere
                const viewport = page.getViewport({ scale: currentScale });

                 // Create new PDFPageView instance
                pageView = new pdfjsViewer.PDFPageView({
                    container: container,
                    id: pageNum,
                    scale: currentScale,
                    defaultViewport: viewport,
                    eventBus: eventBus,
                    linkService: linkService,
                    textLayerMode: pdfjsViewer.TextLayerMode.ENABLE, // Enable text layer
                    annotationMode: pdfjsViewer.AnnotationMode.ENABLE_FORMS | pdfjsViewer.AnnotationMode.ENABLE_STORAGE, // Enable annotations (adjust modes as needed)
                    renderer: 'canvas', // Use canvas rendering
                    l10n: pdfjsViewer.NullL10n, // No localization needed
                 });

                 // Store the new instance
                if (pageSide === 'left') leftPageView = pageView; else rightPageView = pageView;

                pageView.setPdfPage(page);
                await pageView.draw(); // Renders canvas, text, annotations

                updateStatus(`PDFPageView rendered page ${pageNum} on ${pageSide} side`);

                // --- Enhancement Step ---
                const textLayerDiv = pageView.textLayer?.textLayerDiv;
                enhanceTextLayerWithKeywords(pageNum, textLayerDiv);


            } catch (e) {
                 console.error(`Error rendering page ${pageNum} using PDFPageView on ${pageSide}:`, e);
                 if(container) container.innerHTML = `<div style="color:red; padding:10px;">Error rendering page ${pageNum}.</div>`; // Show error in container
            } finally {
                 hidePageLoading(pageSide);
            }
        }

        // --- Preload Logic (Simplified - just fetches pages, no rendering needed) ---
        function preloadAdjacentPages(cp) {
            const pagesToPreload = [];
            if (book.isDoublePageView) {
                if (cp > 2) pagesToPreload.push(cp - 2, cp - 1);
                if (cp + 2 <= book.totalPages) pagesToPreload.push(cp + 2);
                if (cp + 3 <= book.totalPages) pagesToPreload.push(cp + 3);
            } else {
                if (cp > 1) pagesToPreload.push(cp - 1);
                if (cp + 1 <= book.totalPages) pagesToPreload.push(cp + 1);
            }

            const uniquePages = [...new Set(pagesToPreload)].filter(p => p > 0 && p <= book.totalPages);
            if (uniquePages.length === 0) return;

            uniquePages.forEach(pageNum => {
                book.pdfDocument?.getPage(pageNum).catch(err => {
                    console.warn(`Preload failed for page ${pageNum}:`, err);
                });
            });
            // updateStatus(`Preloading pages: ${uniquePages.join(', ')}`);
        }


        // --- Update Display Logic (Uses PDFPageView rendering) ---
        async function updateDisplay() {
            if (!book.pdfDocument) { updateStatus("UpdateDisplay: No PDF document."); return; }

            const lpNum = book.currentPage;
            const rpNum = book.isDoublePageView ? book.currentPage + 1 : 0;
            updateStatus(`Updating display for page(s): ${lpNum}${rpNum > 0 ? ', ' + rpNum : ''}`);

            const lDiv = document.querySelector('.book-page.left');
            const rDiv = document.querySelector('.book-page.right');
            const lNumSpan = document.getElementById('left-page-number');
            const rNumSpan = document.getElementById('right-page-number');

            if (!lDiv || !rDiv || !lNumSpan || !rNumSpan) {
                 console.error("Critical page elements missing for updateDisplay");
                 return;
            }

            // Reset right page initially
            rDiv.style.display = 'none';
            rDiv.classList.remove('placeholder-page');
            if (rightPageView) { rightPageView.destroy(); rightPageView = null; } // Destroy previous right view
            document.getElementById('right-page-container').innerHTML = ''; // Clear container

             // Render Left Page
            if (lpNum >= 1 && lpNum <= book.totalPages) {
                 lNumSpan.textContent = lpNum;
                 await renderPageUsingView(lpNum, 'left'); // Use new rendering function
            } else {
                 lNumSpan.textContent = '';
                 lDiv.style.visibility = 'hidden';
                 if (leftPageView) { leftPageView.destroy(); leftPageView = null; } // Destroy if page num invalid
                  document.getElementById('left-page-container').innerHTML = ''; // Clear container
            }

             // Render Right Page (if applicable)
            if (book.isDoublePageView) {
                 if (rpNum >= 1 && rpNum <= book.totalPages) {
                    rDiv.style.display = 'flex';
                    rNumSpan.textContent = rpNum;
                    await renderPageUsingView(rpNum, 'right');
                 } else if (lpNum >= 1 && lpNum <= book.totalPages) {
                    // Show placeholder if left page is valid but right is not
                    rDiv.style.display = 'flex';
                    rDiv.classList.add('placeholder-page');
                    rNumSpan.textContent = '';
                 }
            }

            updateSliderPosition();
            preloadAdjacentPages(book.currentPage);
            updateStatus("Display update complete.");
        }

        // --- Navigation (Keep existing) ---
        function nextPage(){const i=book.isDoublePageView?2:1;if(book.currentPage+i<=book.totalPages){jumpToPage(book.currentPage+i)}}
        function prevPage(){const d=book.isDoublePageView?2:1;if(book.currentPage-d>=1){jumpToPage(book.currentPage-d)}}
        function jumpToPage(pn){if(!book.pdfDocument||pn<1||pn>book.totalPages)return;let tp=pn;if(book.isDoublePageView&&tp>1&&tp%2!==1)tp--;if(tp<1)tp=1;if(tp===book.currentPage)return;book.currentPage=tp;if(tp>user.readingProgress.furthestPage)user.readingProgress.furthestPage=tp;hideDefinitionPopup();updateDisplay();showPageSlider();manageToolbar(false)}

        // --- View Modes (Keep existing, ensure updateDisplay is called) ---
        function setSinglePageView(){if(!book.isDoublePageView&&!document.body.classList.contains('rotated-mode'))return;updateStatus("Single page view");book.isDoublePageView=false;document.body.classList.remove('rotated-mode');document.body.classList.add('fullscreen-mode');document.querySelector('.book-spread').style.transform='translate(-50%, -50%)';hideDefinitionPopup();updateDisplay();manageToolbar();updateSliderTotalPages();updateSliderPosition()}
        function setDoublePageView(){if(book.isDoublePageView&&!document.body.classList.contains('rotated-mode'))return;updateStatus("Double page view");book.isDoublePageView=true;document.body.classList.remove('rotated-mode','fullscreen-mode');document.querySelector('.book-spread').style.transform='translate(-50%, -50%)';if(book.currentPage>1&&book.currentPage%2===0)book.currentPage--;hideDefinitionPopup();updateDisplay();manageToolbar();updateSliderTotalPages();updateSliderPosition()}
        function setRotatedView() {
            updateStatus("Rotated view"); book.isDoublePageView=false;
            document.body.classList.remove('fullscreen-mode'); document.body.classList.add('rotated-mode');
            hideDefinitionPopup();
            updateDisplay().then(() => { // Ensure updateDisplay finishes before scaling
                const sp = document.querySelector('.book-spread');
                if (!sp) return;
                const vpW = window.innerWidth; const vpH = window.innerHeight;
                const baseW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-w'));
                const baseH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-h'));
                // Calculate scale based on rotated dimensions
                const availableWidthForRotated = vpW;
                const availableHeightForRotated = vpH;
                const scaleX = availableWidthForRotated / baseH; // Page height becomes width
                const scaleY = availableHeightForRotated / baseW; // Page width becomes height
                const scale = Math.min(scaleX, scaleY) * 0.95; // Apply padding factor
                sp.style.transformOrigin='center center';
                sp.style.transform=`translate(-50%, -50%) rotate(90deg) scale(${scale})`;
            }).catch(err => console.error("Error during rotated view update/scaling:", err));
            manageToolbar(); updateSliderTotalPages(); updateSliderPosition();
        }

        // --- UI Toggles (Keep existing) ---
        function toggleElement(id,show){document.getElementById(id)?.classList.toggle('visible',show)}
        function showTableOfContents(){if(!document.getElementById('toc-btn')?.hasAttribute('disabled')){toggleElement('toc-panel',true);manageToolbar(false)}}
        function hideTableOfContents(){toggleElement('toc-panel',false)}
        function showLoading(msg='Processing...'){const lo=document.getElementById('loading-overlay'),lm=lo?.querySelector('.loading-message');if(lo&&lm){lm.textContent=msg;lo.classList.add('visible')}}
        function hideLoading(){toggleElement('loading-overlay',false)}

        // --- Slider Logic (Keep existing) ---
        function showPageSlider(){const s=document.getElementById('page-slider-container');if(s&&book.totalPages>0){s.classList.add('visible');resetSliderHideTimer()}}
        function hidePageSlider(){document.getElementById('page-slider-container')?.classList.remove('visible')}
        function resetSliderHideTimer(){clearTimeout(sliderHideTimeout);sliderHideTimeout=setTimeout(hidePageSlider,3000)}
        function initPageSlider(){const s=document.getElementById('page-slider'),sc=document.getElementById('page-slider-container');if(!s||!sc)return;s.addEventListener('input',()=>{const pn=parseInt(s.value,10),d=document.getElementById('current-page-display');if(d){let pt=`Page ${pn}`;if(book.isDoublePageView&&pn+1<=book.totalPages)pt+=`-${pn+1}`;d.textContent=pt}updateSliderStyle(s,pn);resetSliderHideTimer()});s.addEventListener('change',()=>{jumpToPage(parseInt(s.value,10));resetSliderHideTimer()});sc.addEventListener('mouseenter',()=>clearTimeout(sliderHideTimeout));sc.addEventListener('mouseleave',resetSliderHideTimer);updateSliderTotalPages();updateSliderPosition()}
        function updateSliderTotalPages(){const s=document.getElementById('page-slider'),d=document.getElementById('total-pages-display');if(s&&d){const t=book.totalPages>0?book.totalPages:1;s.max=t;d.textContent=t;updateSliderStyle(s,s.value)}}
        function updateSliderPosition(){const s=document.getElementById('page-slider'),d=document.getElementById('current-page-display');if(s&&d){const cp=book.currentPage>0?book.currentPage:1,tt=book.totalPages>0?book.totalPages:1;s.value=cp;let pt=`Page ${cp}`;if(book.isDoublePageView&&cp+1<=tt)pt+=`-${cp+1}`;d.textContent=pt;updateSliderStyle(s,cp)}}
        function updateSliderStyle(sEl,val){const min=parseInt(sEl.min||1),max=parseInt(sEl.max||1),range=(max>min)?(max-min):1,p=((val-min)/range)*100;sEl.style.setProperty('--slider-percent',`${Math.max(0,Math.min(100,p))}%`)}

        // --- Load PDF & Overlay (Adjusted for PDFPageView cleanup) ---
        async function loadPdf(source) {
            updateStatus("loadPdf started using PDFPageView approach");
            showLoading("Initializing PDF...");

            // --- Cleanup Previous State ---
            if (leftPageView) { leftPageView.destroy(); leftPageView = null; }
            if (rightPageView) { rightPageView.destroy(); rightPageView = null; }
            if (book.pdfDocument) { try { await book.pdfDocument.destroy(); } catch(e){} } // Use await
            book.pdfDocument = null;
            keywordDefinitions = {}; pageKeywords = {};

            document.getElementById('left-page-container').innerHTML = '';
            document.getElementById('right-page-container').innerHTML = '';
            hideDefinitionPopup();
            // --- End Cleanup ---

            let filename = "Document";
            try { filename = decodeURIComponent(source.split('/').pop() || filename); } catch(e){}

            try {
                const loadTask = pdfjsLib.getDocument(source);
                // Fetch overlay *concurrently*
                const overlayUrl = source.replace(/\.pdf$/i, '.overlay.json');
                updateStatus(`Attempting to fetch overlay: ${overlayUrl}`);
                const overlayPromise = fetch(overlayUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status} fetching overlay`);
                        return response.json();
                    })
                    .then(data => {
                         if (!data||typeof data.keywords!=='object'||typeof data.pages!=='object') throw new Error("Invalid overlay structure");
                         keywordDefinitions=data.keywords||{}; pageKeywords=data.pages||{};
                         updateStatus(`Overlay loaded: ${Object.keys(keywordDefinitions).length} keywords, ${Object.keys(pageKeywords).length} pages mapped.`);
                         return true; // Indicate success
                    })
                    .catch(err => {
                         console.warn(`Overlay fetch/parse failed: ${err.message}`);
                         keywordDefinitions={}; pageKeywords={};
                         return false; // Indicate failure
                    });

                // Wait for PDF loading
                book.pdfDocument = await loadTask.promise;
                book.totalPages = book.pdfDocument.numPages; book.currentPage = 1; user.readingProgress.furthestPage = 1;
                book.title = filename.replace(/\.pdf$/i, '');
                updateStatus(`PDF loaded: ${book.title}, Pages: ${book.totalPages}`);
                document.title = `${book.title} - Heritage Historyâ„¢`;
                updateSliderTotalPages(); showLoading("Processing metadata...");

                // Wait for overlay fetch attempt to finish
                const overlayLoaded = await overlayPromise;
                 if (!overlayLoaded) {
                    console.warn(`Warning: Overlay file (${overlayUrl}) could not be loaded or parsed. Definitions/Highlighting will not work.`);
                 }

                try { book.outline = await book.pdfDocument.getOutline(); populateTOC(); }
                catch (oe) { book.outline = []; populateTOC(); }

                if (window.innerWidth < 1000) setSinglePageView(); else setDoublePageView(); // This calls updateDisplay internally

            } catch (e) {
                console.error("Error loading PDF:", e); alert(`Failed to load PDF: ${e.message||e}`);
                book.pdfDocument=null; book.totalPages=0; book.currentPage=1; book.title="No Document"; book.outline=[];
                keywordDefinitions={}; pageKeywords={}; document.title="Heritage Historyâ„¢ Reader";
                updateSliderTotalPages(); updateSliderPosition(); populateTOC();
                 document.querySelector('.main-container .book-spread').innerHTML = `<div style="color: var(--text-on-page); padding: 30px; text-align: center; width: 100%;">Failed to load document: ${e.message}</div>`;
            } finally { hideLoading(); }
        }

        // --- TOC population (Keep existing) ---
        function populateTOC(){const tl=document.getElementById('toc-list'),tb=document.getElementById('toc-btn');if(!tl||!tb)return;tl.innerHTML='';tb.disabled=true;if(!book.outline||book.outline.length===0){tl.innerHTML='<em>No table of contents.</em>';return}tb.disabled=false;const createItem=(item,level=0)=>{const d=document.createElement('div');d.className=level===0?'toc-chapter':'toc-section';d.style.marginLeft=`${level*15}px`;const ts=document.createElement('span');ts.className=level===0?'toc-chapter-title':'';ts.textContent=item.title||'Untitled';ts.style.cursor='pointer';ts.onclick=async()=>{try{let dest=item.dest,pi=-1;if(typeof dest==='string'){dest=await book.pdfDocument.getDestination(dest)}if(Array.isArray(dest)&&typeof dest[0]==='object'){pi=await book.pdfDocument.getPageIndex(dest[0])}else if(Array.isArray(dest)&&typeof dest[0]==='number'){pi=dest[0]-1}else{console.warn("Unknown TOC dest:",item.dest)}if(pi>=0){jumpToPage(pi+1);hideTableOfContents()}else{throw new Error('Failed to resolve page')}}catch(e){alert(`Nav failed: ${e.message}`)}};d.appendChild(ts);if(item.items?.length>0){const sl=document.createElement('div');if(level===0)sl.className='toc-sections';item.items.forEach(si=>{const se=createItem(si,level+1);if(se)sl.appendChild(se)});if(sl.hasChildNodes())d.appendChild(sl)}return d};book.outline.forEach(item=>{const ie=createItem(item);if(ie)tl.appendChild(ie)});if(!tl.hasChildNodes()){tl.innerHTML='<em>Error processing TOC.</em>';tb.disabled=true}}

        // --- Event Setup (Minor adjustments for keyword listeners if needed) ---
        function setupEvents() {
            updateStatus("Setting up events");
            const tbar = document.getElementById('new-toolbar');
            tbar?.addEventListener('click', e => {
                const btn = e.target.closest('.new-btn'); if (!btn || btn.disabled) return;
                const id = btn.id; updateStatus(`Toolbar: ${id}`);
                switch (id) {
                    case 'single-page-btn': setSinglePageView(); break;
                    case 'double-page-btn': setDoublePageView(); break;
                    case 'rotate-btn': setRotatedView(); break;
                    case 'toc-btn': showTableOfContents(); break;
                }
                resetSliderHideTimer(); manageToolbar(true); toolbarHover = false; manageToolbar(false);
            });
            document.getElementById('close-toc-btn')?.addEventListener('click', hideTableOfContents);
            document.getElementById('close-popup-btn')?.addEventListener('click', hideDefinitionPopup);

            // Keyword listeners are now added directly in `enhanceTextLayerWithKeywords`
            // No need for event delegation setup here for keywords specifically,
            // unless you prefer that approach for performance.

            // Page turn navigation (Keep existing)
             document.querySelectorAll('.page-edge-nav').forEach(el=>{el.addEventListener('click',e=>{const pp=e.target.closest('.book-page');if(!pp||pp.classList.contains('placeholder-page'))return;const ir=document.body.classList.contains('rotated-mode'),ilp=pp.classList.contains('left'),ice=e.target.classList.contains('page-edge-left'),ispv=!book.isDoublePageView;if(ir){if(ice)prevPage();else nextPage()}else if(ispv){if(ice)prevPage();else nextPage()}else{if(ice&&ilp)prevPage();else if(!ice&&!ilp)nextPage()}})});

            // Keyboard navigation (Keep existing)
            document.addEventListener('keydown', e => {
                if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||document.querySelector('.toc-panel.visible')||definitionPopup.classList.contains('visible')) return;
                if (e.ctrlKey||e.altKey||e.metaKey) return;
                let navAct=false;
                switch(e.key){case'ArrowRight':case'PageDown':nextPage();navAct=true;break;case'ArrowLeft':case'PageUp':prevPage();navAct=true;break;case'Home':if(book.totalPages>0)jumpToPage(1);navAct=true;break;case'End':if(book.totalPages>0)jumpToPage(book.totalPages);navAct=true;break;case'Escape':hideDefinitionPopup();navAct=true;break}
                if(navAct){e.preventDefault();showPageSlider();manageToolbar(false)}
            });

            // Resize handling (Keep existing)
            window.addEventListener('resize', ()=>{clearTimeout(resizeTimer);resizeTimer=setTimeout(()=>{updateStatus("Resize detected.");hideDefinitionPopup();if(document.body.classList.contains('rotated-mode'))setRotatedView();else if(document.body.classList.contains('fullscreen-mode'))setSinglePageView();else setDoublePageView();manageToolbar()},250)});

            // Double-click view toggle (Keep existing)
             document.querySelector('.main-container').addEventListener('dblclick',e=>{if(e.target===e.currentTarget&&!document.body.classList.contains('rotated-mode')){if(document.body.classList.contains('fullscreen-mode'))setDoublePageView();else setSinglePageView()}});

            // Touch swipe navigation (Keep existing)
             let tsX=0,tsY=0,tst=0;const SW_TH=50,SW_TL=500,SW_A=35;
             document.body.addEventListener('touchstart',e=>{if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .toc-panel, .page-edge-nav, .new-btn, button, input, a, #page-slider-trigger-zone, #definition-popup, .keyword-interactive, .annotationLayer'))return; if(e.touches.length===1){tsX=e.touches[0].screenX;tsY=e.touches[0].screenY;tst=Date.now()}else{tsX=0;tsY=0}},{passive:true});
             document.body.addEventListener('touchend',e=>{if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .toc-panel, .page-edge-nav, .new-btn, button, input, a, #page-slider-trigger-zone, #definition-popup, .keyword-interactive, .annotationLayer'))return; if(tsX===0&&tsY===0)return;if(e.changedTouches.length===1){const teX=e.changedTouches[0].screenX,teY=e.changedTouches[0].screenY;if(Date.now()-tst<SW_TL){handleSwipe(tsX,tsY,teX,teY)}}tsX=0;tsY=0;tst=0});
             function handleSwipe(sx,sy,ex,ey){const dx=ex-sx,dy=ey-sy,adx=Math.abs(dx),ady=Math.abs(dy);if(adx<SW_TH&&ady<SW_TH)return;if(Math.atan2(ady,adx)*180/Math.PI<=SW_A){if(dx>SW_TH)prevPage();else if(dx<-SW_TH)nextPage();showPageSlider();manageToolbar(false)}}

            // Slider trigger zone (Keep existing)
            const sliderTrigger=document.getElementById('page-slider-trigger-zone'),sliderCont=document.getElementById('page-slider-container');
            if(sliderTrigger&&sliderCont){sliderTrigger.addEventListener('mouseenter',()=>{if(book.pdfDocument&&book.totalPages>0){showPageSlider();clearTimeout(sliderHideTimeout)}});sliderTrigger.addEventListener('mouseleave',e=>{if(!sliderCont.contains(e.relatedTarget))resetSliderHideTimer()});sliderCont.addEventListener('mouseenter',()=>clearTimeout(sliderHideTimeout));sliderCont.addEventListener('mouseleave',e=>{if(!sliderTrigger.contains(e.relatedTarget))resetSliderHideTimer()})}

            // Close popup on outside click (Keep existing)
            document.addEventListener('click',e=>{if(definitionPopup.classList.contains('visible')&&!definitionPopup.contains(e.target)&&!e.target.closest('.keyword-interactive'))hideDefinitionPopup()},true); // Use closest to handle clicks inside keyword spans

            updateStatus("Events setup complete");
        }


        // --- Definition Popup (Keep existing) ---
        function showDefinitionPopup(word, definition, clickLeft, clickBottom) {
            if (!definitionPopup || !popupWord || !popupDefinition) return;
            popupWord.textContent = word.charAt(0).toUpperCase() + word.slice(1); // Display original case word
            popupDefinition.innerHTML = definition;

            let popupLeft = clickLeft; let popupTop = clickBottom + 5;
            definitionPopup.style.left = `${popupLeft}px`; definitionPopup.style.top = `${popupTop}px`;
            definitionPopup.style.display = 'block'; definitionPopup.style.opacity = '0';
            definitionPopup.style.transform = 'scale(0.95)'; definitionPopup.style.pointerEvents = 'none';

            setTimeout(() => {
                const popupRect = definitionPopup.getBoundingClientRect();
                const winWidth = window.innerWidth, winHeight = window.innerHeight;
                if (popupLeft + popupRect.width > winWidth - 10) popupLeft = winWidth - popupRect.width - 10;
                if (popupTop + popupRect.height > winHeight - 10) popupTop = clickBottom - popupRect.height - 15; // Move above
                if (popupLeft < 10) popupLeft = 10; if (popupTop < 10) popupTop = 10;
                definitionPopup.style.left = `${popupLeft}px`; definitionPopup.style.top = `${popupTop}px`;
                definitionPopup.classList.add('visible'); definitionPopup.style.pointerEvents = 'auto';
            }, 0);
        }
        function hideDefinitionPopup() {
            if (definitionPopup) { definitionPopup.classList.remove('visible'); definitionPopup.style.pointerEvents = 'none'; }
        }

        // --- Initialization ---
        async function init() {
            updateStatus("Initializing app");
            try {
                try { PAGE_PADDING = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-padding')) || 15; }
                catch (ce) { PAGE_PADDING = 15; }
                setupEvents(); setupToolbarHover(); initPageSlider(); hideLoading();
                const urlParams = new URLSearchParams(window.location.search);
                const pdfUrlParam = urlParams.get('pdf');
                if (pdfUrlParam) { await loadPdf(pdfUrlParam); }
                else {
                    updateStatus("No PDF specified in URL.");
                    document.querySelector('.main-container .book-spread').innerHTML = `<div style="color:var(--text-on-page);padding:30px;text-align:center;width:100%;">Load using ?pdf=... URL parameter.</div>`;
                    document.querySelector('.book-page.left')?.style.setProperty('visibility','hidden');
                    document.querySelector('.book-page.right')?.style.setProperty('display','none');
                }
                 // Add cleanup for page views on unload
                window.addEventListener('beforeunload', () => {
                    if (leftPageView) { leftPageView.destroy(); }
                    if (rightPageView) { rightPageView.destroy(); }
                    if (book.pdfDocument) { book.pdfDocument.destroy(); }
                });
                updateStatus("Init complete.");
            } catch (e) { console.error("Init failed:", e); document.body.innerHTML = `<pre>Init Error: ${e.stack||e}</pre>`; }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
