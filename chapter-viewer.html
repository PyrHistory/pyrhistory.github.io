<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heritage Historyâ„¢ - Digital Book Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <!-- Removed incorrect pdf_viewer.component.min.js script tag -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.min.css">
    <style>
        /* --- CSS styles remain unchanged, assuming they are correct --- */
:root{--primary:#4a90e2;--secondary:#50e3c2;--accent:#f5a623;--lab-blue:#080e1c;--page:#fff;--text-on-dark:rgba(255,255,255,.9);--text-on-page:#333;--header-h:60px;--page-w:650px;--page-h:842px;--page-padding:15px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Georgia',serif;background-color:var(--lab-blue);color:var(--text-on-dark);height:100vh;width:100vw;overflow:hidden;display:flex;flex-direction:column;position:fixed;line-height:1.6}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background-image:radial-gradient(circle at 15% 15%,rgba(249,115,22,.12) 0,transparent 45%),radial-gradient(circle at 85% 85%,rgba(197,83,235,.12) 0,transparent 45%),radial-gradient(circle at 85% 15%,rgba(56,189,248,.05) 0,transparent 40%),radial-gradient(circle at 15% 85%,rgba(251,191,36,.08) 0,transparent 40%);animation:ambient-shift 30s ease infinite alternate}
@keyframes ambient-shift{0%{background-position:0 0,0 0,0 0,0 0}100%{background-position:5% 10%,-5% -5%,10% -5%,-10% 5%}}
@media (prefers-reduced-motion:reduce){body::before{animation:none!important}}
#new-toolbar{position:fixed!important;top:15px!important;right:-60px!important;z-index:9999!important;display:flex!important;flex-direction:column!important;gap:10px!important;transition:right .3s ease,bottom .3s ease,transform .3s ease!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);padding:5px!important;border-radius:8px 0 0 8px!important;box-shadow:-2px 2px 10px rgba(0,0,0,.4)!important;width:58px;border:1px solid rgba(255,255,255,.1)}
#new-toolbar::before{content:"â‰¡";position:absolute;left:-25px;top:50%;transform:translateY(-50%);background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);width:25px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;color:var(--text-on-dark);font-size:20px;box-shadow:-2px 2px 5px rgba(0,0,0,.3);transition:all .3s ease;border:1px solid rgba(255,255,255,.1);border-right:none;cursor:pointer}
.toolbar-trigger-area{position:fixed;top:0;right:0;width:30px;height:100%;z-index:9998;transition:all .3s ease}
#new-toolbar.visible{right:0!important;transform:none!important}
.new-btn{background:rgba(44,62,80,.8)!important;border:1px solid rgba(255,255,255,.15)!important;color:var(--text-on-dark)!important;width:48px!important;height:48px!important;border-radius:4px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:25px!important;cursor:pointer!important;transition:all .2s!important;box-shadow:0 2px 5px rgba(0,0,0,.2)!important;user-select:none!important;flex-shrink:0}
.new-btn:hover{background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;transform:translateY(-2px)!important}
.new-btn:active{transform:translateY(1px)!important}
.new-btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
.rotated-mode #new-toolbar{top:auto!important;right:50%!important;bottom:-60px!important;transform:translateX(50%)!important;flex-direction:row!important;width:auto!important;height:58px!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:8px 8px 0 0!important;padding:5px 10px!important;box-shadow:0 -2px 10px rgba(0,0,0,.4)!important;border:1px solid rgba(255,255,255,.1);border-bottom:none}
.rotated-mode #new-toolbar.visible{bottom:0!important;transform:translateX(50%)!important}
.rotated-mode #new-toolbar::before{left:50%!important;transform:translateX(-50%)!important;top:-25px!important;width:40px!important;height:25px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:4px 4px 0 0!important;content:"â‰¡";padding-bottom:5px;color:var(--text-on-dark);border:1px solid rgba(255,255,255,.1);border-bottom:none;cursor:pointer}
.rotated-mode .toolbar-trigger-area{top:auto!important;bottom:0!important;left:0!important;transform:none!important;right:auto!important;width:100%!important;height:30px!important}
.rotated-mode #new-toolbar .new-btn{width:40px!important;height:40px!important;font-size:20px!important;transform: rotate(90deg)}
.rotated-mode .new-btn:hover {transform: rotate(90deg) scale(1.1);background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}
.rotated-mode .new-btn:active {transform: rotate(90deg) scale(0.95)}
.main-container{flex:1;display:flex;justify-content:center!important;align-items:center!important;padding:0;height:100%;width:100%;overflow:hidden;position:relative;background:transparent}
.book-spread{display:flex;box-shadow:0 10px 35px rgba(0,0,0,.5);position:fixed!important;top:50%!important;left:50%!important;transform-origin:center center;width:auto!important;height:auto!important;transition:transform .3s ease; transform: translate(-50%, -50%)}
.book-page{width:var(--page-w);height:var(--page-h);background-color:var(--page);position:relative;overflow:hidden; flex-shrink:0;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08);padding:0;}
.book-page.left{border-right:1px solid rgba(255,255,255,.15);border-radius:3px 0 0 3px}
.book-page.right{border-left:1px solid rgba(255,255,255,.15);border-radius:0 3px 3px 0}
.fullscreen-mode:not(.rotated-mode) .book-page.left{border-right:1px solid rgba(255,255,255,.08)!important}
.canvas-container {
    position: relative;
    width: calc(100% - 2 * var(--page-padding));
    height: calc(100% - 2 * var(--page-padding));
    margin: var(--page-padding);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* Clip layers */
}
.pdf-canvas{max-width:100%;max-height:100%;display:block;object-fit:contain;box-shadow: none; position: absolute; top: 0; left: 0; z-index: 1; } /* Canvas sits at the bottom */
.page-number{display:none}
.page-loading-overlay{position:absolute;inset:var(--page-padding);background:rgba(255,255,255,.6);z-index:50;display:none;justify-content:center;align-items:center;border-radius:3px}
.page-loading-spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(0,0,0,.1);border-top-color:var(--primary);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-edge-nav{position:absolute;top:0;height:100%;width:50px;cursor:pointer;z-index:10;transition:background-color .2s;-webkit-tap-highlight-color:transparent}
.page-edge-nav:hover{background-color:rgba(0,0,0,.03)}
.page-edge-left{left:0;border-radius:3px 0 0 3px}
.page-edge-right{right:0;border-radius:0 3px 3px 0}
.page-edge-left:hover::after,.page-edge-right:hover::after{content:"";position:absolute;top:50%;width:12px;height:12px;border-style:solid;border-color:rgba(0,0,0,.6);border-width:2px 2px 0 0;opacity:.8}
.page-edge-left:hover::after{left:18px;transform:translateY(-50%) rotate(-135deg)}
.page-edge-right:hover::after{right:18px;transform:translateY(-50%) rotate(45deg)}
.fullscreen-mode .book-page.right{display:none!important}
.fullscreen-mode .book-page.left{max-width:95vw;max-height:95vh;width:auto;height:auto;border-radius:5px!important;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08)!important;padding:0;}
.fullscreen-mode .canvas-container { margin: var(--page-padding); }
.fullscreen-mode .pdf-canvas{max-width:100%;max-height:100%;object-fit:contain; position:relative; /* Reset position for single view */ }
.rotated-mode .book-page.left{width:var(--page-w)!important;height:var(--page-h)!important;border-radius:0!important;border:none!important;padding:0 !important;background-color:var(--page);display:flex;justify-content:center;align-items:center}
.rotated-mode .canvas-container { margin: 10px !important; width: calc(100% - 20px); height: calc(100% - 20px); }
.rotated-mode .book-page.right{display:none!important}
.rotated-mode .pdf-canvas{box-shadow:none;max-width:100%;max-height:100%;object-fit:contain; position: relative; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page{width:var(--page-w);height:var(--page-h)}
.book-page.right.placeholder-page{background-color:var(--page)!important;border-left:1px solid rgba(0,0,0,.1);position:relative;display:flex!important;justify-content:center;align-items:center}
.book-page.right.placeholder-page::after{content:"End of document";font-size:14px;font-style:italic;color:rgba(0,0,0,.5)}
.book-page.right.placeholder-page .canvas-container,.book-page.right.placeholder-page .page-edge-nav,.book-page.right.placeholder-page .page-loading-overlay{display:none}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left,
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) {
    position: relative;
}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left { border-right: none !important; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) { border-left: none !important; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left .canvas-container::after { content: ''; position: absolute; top: 0; right: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to left, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 0 2px 2px 0; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) .canvas-container::before { content: ''; position: absolute; top: 0; left: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to right, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 2px 0 0 2px; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right.placeholder-page { border-left: 1px solid rgba(0,0,0,.1) !important; }
.toc-panel{position:fixed;z-index:10000;display:none;color:var(--text-on-page); left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;height:80vh;background:#f0f4f8;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,.5);flex-direction:column;overflow:hidden}
.toc-panel.visible,.loading-overlay.visible{display:flex!important}
.toc-header{padding:15px 20px;background:var(--primary);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.toc-header .notes-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0 5px;line-height:1}
.toc-content{flex:1;padding:10px 20px;overflow-y:auto}
.toc-chapter{padding:8px 0;border-bottom:1px solid #d8dfe6}
.toc-chapter-title{font-weight:700;color:var(--primary);cursor:pointer;padding:5px 0}
.toc-chapter-title:hover,.toc-section:hover{color:var(--accent)}
.toc-sections{padding-left:20px;margin-top:5px}
.toc-section{padding:4px 0;cursor:pointer;color:#4a5568;font-size:.95em}
/* Remove Upload Modal Styles */
.loading-overlay{position:fixed;inset:0;background:rgba(8,14,28,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:10001;display:none;justify-content:center;align-items:center;flex-direction:column}
.loading-spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:15px}
.loading-message{font-size:16px;color:var(--text-on-dark)}
#status-indicator{display:none}
.page-slider-container{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:700px;padding:14px 20px;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-bottom:none;box-shadow:0 -4px 20px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;z-index:9998;transition:bottom .35s cubic-bezier(.2,.9,.3,1),transform .35s cubic-bezier(.2,.9,.3,1), left .35s cubic-bezier(.2,.9,.3,1);border-radius:16px 16px 0 0}
.page-slider-container.visible{bottom:0}
.page-slider-track{width:100%;margin-bottom:8px;padding:0 10px}
.page-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);outline:none;border-radius:3px;overflow:visible;cursor:pointer;transition:height .2s}
.page-slider:hover{height:8px}
.page-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition:all .2s ease;margin-top:-7px}
.page-slider::-webkit-slider-thumb:hover{width:24px;height:24px;margin-top:-8px}
.page-slider::-webkit-slider-runnable-track{height:100%;background:linear-gradient(to right,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%));border-radius:3px}
.page-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4)}
.page-slider::-moz-range-thumb:hover{width:24px;height:24px}
.page-slider::-moz-range-progress{background-color:var(--accent);height:100%;border-radius:3px}
.page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);height:100%;border-radius:3px}
.page-slider-info{font-size:12px;color:var(--text-on-dark);font-weight:500;letter-spacing:.3px;opacity:.8}
.rotated-mode .page-slider-container{bottom:50%!important;left:-80px!important;top:auto!important;transform:translateY(50%)!important;width:60px!important;height:70vh!important;max-width:none!important;max-height:500px;flex-direction:column-reverse!important;padding:10px 5px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 12px 12px 0!important;box-shadow:2px 0 20px rgba(0,0,0,.4)!important}
.rotated-mode .page-slider-container.visible{left:0!important}
.rotated-mode .page-slider-track{width:100%!important;height:100%!important;margin-bottom:0!important;padding:10px 0!important;display:flex;align-items:center;flex:1}
.rotated-mode .page-slider{width:6px!important;height:100%!important;writing-mode:vertical-lr!important;-webkit-appearance:slider-vertical!important;appearance:slider-vertical;margin:0 auto!important;padding:0!important;background:rgba(255,255,255,.1)!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-runnable-track{width:6px!important;height:100%;background:linear-gradient(to top,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%))!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width:20px!important;height:20px!important;border-radius: 50%;background: var(--accent);cursor: pointer;border: 3px solid rgba(28,37,54,.9)!important;box-shadow: 0 1px 6px rgba(0,0,0,.4);transition: all .2s ease;margin-top:0!important;margin-left:-7px!important}
.rotated-mode .page-slider:hover::-webkit-slider-thumb {width: 24px !important;height: 24px !important;margin-left: -9px !important}
.rotated-mode .page-slider::-moz-range-thumb{width: 20px;height: 20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition: all .2s ease}
.rotated-mode .page-slider:hover::-moz-range-thumb {width: 24px;height: 24px}
.rotated-mode .page-slider::-moz-range-progress{background-color:var(--accent)!important;width:6px!important;border-radius:3px}
.rotated-mode .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);width:6px!important;border-radius:3px}
.rotated-mode .page-slider-info{transform:rotate(90deg);white-space:nowrap;margin-bottom:15px;padding-top:10px;color:var(--text-on-dark)}
#page-slider-trigger-zone {position: fixed;bottom: 0;left: 0;width: 100%;height: 30px;z-index: 9997;pointer-events: auto}
.rotated-mode #page-slider-trigger-zone {bottom: auto;top: 50%;left: 0;width: 60px;height: 50%}


/* --- START: Text Layer & Keyword Styles --- */
.textLayer {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    opacity: 1; /* Make visible */
    line-height: 1.0;
    color: transparent; /* Make base text invisible */
    user-select: none;
    -webkit-user-select: none;
    pointer-events: none; /* Layer doesn't capture events */
    z-index: 2; /* Above canvas, below annotation */
}

.textLayer > span {
    position: absolute;
    white-space: pre;
    cursor: text;
    transform-origin: 0% 0%;
    pointer-events: none; /* Individual spans off by default */
    border-radius: 2px;
}

.textLayer .keyword-interactive {
    pointer-events: auto; /* Keywords ARE interactive */
    cursor: pointer;
    transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.textLayer .keyword-hover-highlight {
    background: linear-gradient(to right, rgba(255, 100, 0, 0.4), rgba(255, 191, 36, 0.4));
    box-shadow: 0 0 3px rgba(255, 165, 0, 0.5);
}
/* --- END: Text Layer & Keyword Styles --- */

/* --- START: Annotation Layer Styles (for Links) --- */
.annotationLayer {
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    pointer-events: none; /* Layer itself doesn't capture */
    z-index: 3; /* Above text layer */
}

.annotationLayer section { /* General annotation container */
    position: absolute;
    pointer-events: auto; /* Annotations ARE interactive */
}

.annotationLayer .linkAnnotation > a {
    position: absolute;
    font-size: 1em;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    /* Style links */
    border: 1px solid transparent; /* Add border space */
    transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}

.annotationLayer .linkAnnotation > a:hover {
    cursor: pointer;
    background-color: rgba(var(--accent), 0.2); /* Use accent color with alpha */
    border: 1px solid rgba(var(--accent), 0.5);
}
/* --- END: Annotation Layer Styles --- */


/* --- START: Dictionary Pop-up Styles --- */
#definition-popup { display: none; position: fixed; z-index: 10002; background: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 10px 15px; max-width: 300px; min-width: 150px; font-family: sans-serif; font-size: 14px; color: #333; line-height: 1.4; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; transform: scale(0.95); opacity: 0; pointer-events: none; }
#definition-popup.visible { display: block; transform: scale(1); opacity: 1; pointer-events: auto; }
#close-popup-btn { position: absolute; top: 3px; right: 3px; background: none; border: none; font-size: 18px; cursor: pointer; color: #888; padding: 0 5px; line-height: 1; }
#close-popup-btn:hover { color: #333; }
#popup-word { display: block; margin-bottom: 5px; color: var(--primary); font-weight: bold; }
#popup-definition { max-height: 150px; overflow-y: auto; }
#popup-definition i { color: #777; }
#popup-definition span.error-message { color: #e74c3c; }
/* --- END: Dictionary Pop-up Styles --- */

    </style>
</head>
<body>
    <div id="new-toolbar"></div>
    <div class="toolbar-trigger-area" id="toolbar-trigger-area"></div>
    <div id="status-indicator">Status: Initializing...</div>
    <div class="main-container">
        <div class="book-spread">
            <div class="book-page left">
                <div class="canvas-container">
                    <canvas id="left-page-canvas" class="pdf-canvas"></canvas>
                    <div class="textLayer" id="left-text-layer"></div> <!-- Text Layer Placeholder Div -->
                    <div class="annotationLayer" id="left-annotation-layer"></div> <!-- Annotation Layer Placeholder Div -->
                </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="left-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
            <div class="book-page right placeholder-page">
                 <div class="canvas-container">
                    <canvas id="right-page-canvas" class="pdf-canvas"></canvas>
                     <div class="textLayer" id="right-text-layer"></div> <!-- Text Layer Placeholder Div -->
                     <div class="annotationLayer" id="right-annotation-layer"></div> <!-- Annotation Layer Placeholder Div -->
                 </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="right-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
        </div>
    </div>
    <div class="toc-panel" id="toc-panel"></div>
    <!-- Upload modal removed -->
    <div class="loading-overlay" id="loading-overlay"></div>
    <div class="page-slider-container" id="page-slider-container"></div>
    <div id="page-slider-trigger-zone"></div>

    <!-- Definition Pop-up -->
    <div id="definition-popup">
        <button id="close-popup-btn">Ã—</button>
        <strong id="popup-word">Word</strong>
        <div id="popup-definition">Definition</div>
    </div>


    <script>
        // Populate Inner HTML directly (Toolbar, TOC, Loading, Slider)
        document.getElementById('new-toolbar').innerHTML = `<button class="new-btn" id="single-page-btn" title="Single Page View">â˜°</button><button class="new-btn" id="double-page-btn" title="Double Page View">â—«</button><button class="new-btn" id="rotate-btn" title="Rotate View">ðŸ“±</button><button class="new-btn" id="toc-btn" title="Table of Contents" disabled>ðŸ“‘</button>`;
        document.getElementById('toc-panel').innerHTML = `<div class="toc-header"><span>Table of Contents</span><button class="notes-close" id="close-toc-btn">Ã—</button></div><div class="toc-content"><div id="toc-list">Loading...</div></div>`;
        document.getElementById('loading-overlay').innerHTML = `<div class="loading-spinner"></div><div class="loading-message">Processing...</div>`;
        document.getElementById('page-slider-container').innerHTML = `<div class="page-slider-track"><input type="range" id="page-slider" class="page-slider" min="1" max="1" value="1" style="--slider-percent: 0%"></div><div class="page-slider-info"><span id="current-page-display">Page 1</span> of <span id="total-pages-display">1</span></div>`;
    </script>
    <script>
        // --- UI Elements ---
        const definitionPopup = document.getElementById('definition-popup');
        const popupWord = document.getElementById('popup-word');
        const popupDefinition = document.getElementById('popup-definition');
        const closePopupBtn = document.getElementById('close-popup-btn');

        // --- State Variables ---
        let currentViewports = {};
        let keywordDefinitions = {};
        let pageKeywords = {};

        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const book={title:"No Document",totalPages:0,currentPage:1,isDoublePageView:true,pdfDocument:null,outline:[]};
        const user={readingProgress:{furthestPage:1}};
        let toolbarTimer=null;
        let toolbarHover=!1;
        const pageCache=new Map();
        const MAX_CACHE_SIZE=15;
        let PAGE_PADDING=15;
        let resizeTimer;
        let sliderHideTimeout=null;
        const updateStatus=m=>console.log("Status:",m);

        // --- Basic Link Service for Annotations ---
        class SimpleLinkService {
  constructor() {
    // Removed: this.externalLinkTarget = pdfjsLib.LinkTarget.BLANK;
    // We can rely on default browser behavior or AnnotationLayer defaults
    // for external links for now. Keep rel for security/SEO best practice.
    this.externalLinkRel = "noopener noreferrer nofollow";
  }
          get page() { return book.currentPage; }
          set page(val) { jumpToPage(val); }
          navigateTo(dest) {
             if (typeof dest === 'string') { console.warn("Named destination navigation not fully implemented:", dest); }
             else if (Array.isArray(dest) && typeof dest[0] === 'object' && dest[0] !== null && Number.isInteger(dest[0].num)) { const pageIndex = dest[0].num; jumpToPage(pageIndex + 1); }
             else if (Number.isInteger(dest)) { jumpToPage(dest); }
             else { console.warn("Unhandled navigation destination type:", dest); }
          }
          getDestinationHash(dest) { return "#"; }
          getAnchorUrl(hash) { return hash; }
          setHash(hash) { /* Implement if needed for history */ }
          executeNamedAction(action) { console.warn("Named actions not implemented:", action); }
          cachePageRef(pageNum, pageRef) {}
        }
        const linkService = new SimpleLinkService(); // Instantiate it

        // --- Toolbar Logic (unchanged) ---
        function manageToolbar(s=null){const t=document.getElementById("new-toolbar"),a=document.getElementById("toolbar-trigger-area"),d=document.body;null!==s?d.classList.toggle("toolbar-visible",s):d.classList.toggle("toolbar-visible"),t.classList.toggle("visible",d.classList.contains("toolbar-visible")),a.style.pointerEvents=d.classList.contains("toolbar-visible")?"none":"auto";clearTimeout(toolbarTimer);toolbarTimer=setTimeout(()=>{d.classList.remove("toolbar-visible");t.classList.remove("visible");a.style.pointerEvents="auto"},5e3)}
        function setupToolbarHover(){const t=document.getElementById("new-toolbar"),a=document.getElementById("toolbar-trigger-area");t.addEventListener("mouseenter",()=>(toolbarHover=!0,clearTimeout(toolbarTimer)));t.addEventListener("mouseleave",()=>(toolbarHover=!1,resetToolbarTimer()));a.addEventListener("mouseenter",()=>manageToolbar(!0));a.addEventListener("mouseleave",()=>resetToolbarTimer());function resetToolbarTimer(){toolbarHover||(clearTimeout(toolbarTimer),toolbarTimer=setTimeout(()=>manageToolbar(!1),1500))}}

        // --- Caching and Page Loading (unchanged) ---
        function trimCache(){while(pageCache.size>MAX_CACHE_SIZE){const[k]=pageCache.keys();pageCache.delete(k);updateStatus(`Cache trimmed: Removed page ${k}`)}updateStatus(`Cache size: ${pageCache.size}/${MAX_CACHE_SIZE}`)}
        function showPageLoading(cId){const c=document.getElementById(cId);c?.closest(".book-page")?.querySelector(".page-loading-overlay")?.style.setProperty("display","flex")}
        function hidePageLoading(cId){const c=document.getElementById(cId);c?.closest(".book-page")?.querySelector(".page-loading-overlay")?.style.setProperty("display","none")}

        async function renderPage(pageNum, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas?.getContext('2d');
            const canvasContainer = canvas?.closest('.canvas-container');
            const textLayerContainer = canvasContainer?.querySelector('.textLayer');
            const annotationLayerContainer = canvasContainer?.querySelector('.annotationLayer');
            const pageElement = canvas?.closest('.book-page');

            // Clear previous state safely
            delete currentViewports[canvasId];
            if (textLayerContainer) textLayerContainer.innerHTML = '';
            if (annotationLayerContainer) annotationLayerContainer.innerHTML = '';

            if (!book.pdfDocument || !canvas || !ctx || !canvasContainer || !textLayerContainer || !annotationLayerContainer || !pageElement || pageNum < 1 || pageNum > book.totalPages) {
                if (canvas) ctx.clearRect(0, 0, canvas.width, canvas.height);
                hidePageLoading(canvasId);
                return;
            }
            showPageLoading(canvasId);
            pageElement.classList.remove('placeholder-page');

            let page;

            // --- Canvas Rendering ---
             if (pageCache.has(pageNum)) {
                 const d = pageCache.get(pageNum);
                 canvas.width = d.width; canvas.height = d.height;
                 canvas.style.width = `${d.styleWidth}px`; canvas.style.height = `${d.styleHeight}px`;
                 ctx.putImageData(d.imageData, 0, 0);
                 pageCache.delete(pageNum); pageCache.set(pageNum, d);
                 currentViewports[canvasId] = d.viewport;
                 updateStatus(`Rendered canvas page ${pageNum} from cache`);
                 try { page = await book.pdfDocument.getPage(pageNum); } catch (e) { console.error("Failed to get page object for layers:", e); hidePageLoading(canvasId); return; }
                 await renderAndEnhanceTextLayer(page, textLayerContainer, d.viewport);
                 await renderAnnotationLayer(page, annotationLayerContainer, d.viewport);
                 hidePageLoading(canvasId);

             } else {
                 try {
                     page = await book.pdfDocument.getPage(pageNum);
                     const containerStyle = getComputedStyle(canvasContainer);
                     const availableWidth = parseFloat(containerStyle.width);
                     const availableHeight = parseFloat(containerStyle.height);
                     if (availableWidth <= 0 || availableHeight <= 0) { hidePageLoading(canvasId); return; }

                     const viewport = page.getViewport({ scale: 1 });
                     const scale = Math.min(availableWidth / viewport.width, availableHeight / viewport.height);
                     const scaledViewport = page.getViewport({ scale: scale });
                     currentViewports[canvasId] = scaledViewport;

                     const dpr = window.devicePixelRatio || 1;
                     canvas.width = Math.floor(scaledViewport.width * dpr); canvas.height = Math.floor(scaledViewport.height * dpr);
                     canvas.style.width = `${Math.floor(scaledViewport.width)}px`; canvas.style.height = `${Math.floor(scaledViewport.height)}px`;
                     ctx.scale(dpr, dpr);

                     const renderContext = { canvasContext: ctx, viewport: scaledViewport };
                     await page.render(renderContext).promise;

                     const iData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                     pageCache.set(pageNum, { imageData: iData, width: canvas.width, height: canvas.height, styleWidth: Math.floor(scaledViewport.width), styleHeight: Math.floor(scaledViewport.height), viewport: scaledViewport });
                     trimCache();
                     updateStatus(`Rendered canvas page ${pageNum} and cached`);

                     // Render layers AFTER canvas is done
                     await renderAndEnhanceTextLayer(page, textLayerContainer, scaledViewport);
                     await renderAnnotationLayer(page, annotationLayerContainer, scaledViewport);

                 } catch (e) {
                     console.error(`Error rendering page ${pageNum}:`, e);
                     if(ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
                 } finally {
                     hidePageLoading(canvasId);
                 }
             }
         }

        // --- Text Layer Rendering and Enhancement (unchanged) ---
        async function renderAndEnhanceTextLayer(page, container, viewport) {
             if (!page || !container || !viewport) return;
             const pageNum = page.pageNumber;
             const keywordsForPage = pageKeywords[pageNum] || [];
             try {
                 const textContent = await page.getTextContent({ normalizeWhitespace: true });
                 container.innerHTML = '';
                 const textLayerFrag = document.createDocumentFragment();
                 await pdfjsLib.renderTextLayer({ textContentSource: textContent, container: textLayerFrag, viewport: viewport, enhanceTextSelection: true }).promise;
                 if (keywordsForPage.length > 0) {
                     const renderedSpans = textLayerFrag.querySelectorAll('span');
                     renderedSpans.forEach(span => {
                         if (!span.textContent.trim()) { span.remove(); return; }
                         const spanText = span.textContent;
                         for (const keyword of keywordsForPage) {
                              const escapedKeyword = keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                              const regex = new RegExp(`\\b(${escapedKeyword})\\b`, 'gi');
                              if (regex.test(spanText)) {
                                  const definition = keywordDefinitions[keyword];
                                  if (definition) { span.classList.add('keyword-interactive'); span.dataset.keyword = keyword; span.dataset.definition = definition; break; }
                              }
                         }
                     });
                 }
                 container.appendChild(textLayerFrag);
             } catch (error) { console.error(`Error rendering text layer for page ${pageNum}:`, error); container.innerHTML = ''; }
         }

        // --- Annotation Layer Rendering (unchanged) ---
        async function renderAnnotationLayer(page, container, viewport) {
             if (!page || !container || !viewport) return;
             try {
                 const annotations = await page.getAnnotations();
                 container.innerHTML = '';
                 const parameters = { viewport: viewport.clone({ dontFlip: true }), div: container, annotations: annotations, page: page, linkService: linkService, renderForms: false, annotationEditorUIManager: null };
                 pdfjsLib.AnnotationLayer.render(parameters);
             } catch (error) { console.error(`Error rendering annotation layer for page ${page.pageNumber}:`, error); container.innerHTML = ''; }
         }

        // --- Preload Adjacent Pages (unchanged) ---
        function preloadAdjacentPages(cp){if(!book.pdfDocument)return;const pgsToPreload=[cp-2,cp-1,cp+1,cp+2].filter(p=>p>=1&&p<=book.totalPages&&!pageCache.has(p));if(book.isDoublePageView){const rp=cp%2===0?cp-1:cp;const lpp=rp-2,rpp=rp+1;[lpp,lpp+1,rpp,rpp+1].filter(p=>p>=1&&p<=book.totalPages&&!pageCache.has(p)).forEach(p=>pgsToPreload.includes(p)||pgsToPreload.push(p))}pgsToPreload.forEach(async pNum=>{if(!pageCache.has(pNum))try{const pg=await book.pdfDocument.getPage(pNum),vp=pg.getViewport({scale:1}),cv=document.createElement("canvas"),cx=cv.getContext("2d"),containerStyle=getComputedStyle(document.querySelector(".canvas-container")),availableWidth=parseFloat(containerStyle.width),availableHeight=parseFloat(containerStyle.height);if(availableWidth<=0||availableHeight<=0)return;const sc=Math.min(availableWidth/vp.width,availableHeight/vp.height),sVp=pg.getViewport({scale:sc}),dpr=window.devicePixelRatio||1;cv.width=Math.floor(sVp.width*dpr);cv.height=Math.floor(sVp.height*dpr);cx.scale(dpr,dpr);const rc={canvasContext:cx,viewport:sVp};await pg.render(rc).promise;const iD=cx.getImageData(0,0,cv.width,cv.height);pageCache.set(pNum,{imageData:iD,width:cv.width,height:cv.height,styleWidth:Math.floor(sVp.width),styleHeight:Math.floor(sVp.height),viewport:sVp});trimCache();updateStatus(`Preloaded page ${pNum}`)}catch(e){console.error(`Error preloading page ${pNum}:`,e)}})}

        // --- Update Display (Corrected Layer Clearing) ---
        async function updateDisplay() {
            if (!book.pdfDocument) { updateStatus("UpdateDisplay skipped: No PDF doc"); return; }
            updateStatus("Starting display update...");
            const lDiv = document.querySelector('.book-page.left');
            const rDiv = document.querySelector('.book-page.right');
            const lNum = document.getElementById('left-page-number');
            const rNum = document.getElementById('right-page-number');
            const lCanvas = document.getElementById('left-page-canvas');
            const rCanvas = document.getElementById('right-page-canvas');
            const lCtx = lCanvas?.getContext('2d');
            const rCtx = rCanvas?.getContext('2d');

            // **FIXED:** Safely clear text/annotation layers
            const lTextLayerElement = document.getElementById('left-text-layer');
            if (lTextLayerElement) lTextLayerElement.innerHTML = '';
            const rTextLayerElement = document.getElementById('right-text-layer');
            if (rTextLayerElement) rTextLayerElement.innerHTML = '';
            const lAnnotationLayerElement = document.getElementById('left-annotation-layer');
            if (lAnnotationLayerElement) lAnnotationLayerElement.innerHTML = '';
            const rAnnotationLayerElement = document.getElementById('right-annotation-layer');
            if (rAnnotationLayerElement) rAnnotationLayerElement.innerHTML = '';

            if (!lDiv || !rDiv || !lNum || !rNum || !lCanvas || !rCanvas || !lCtx || !rCtx) {
                console.error("UpdateDisplay failed: Missing essential page elements."); return;
            }

            lDiv.style.visibility = 'hidden';
            rDiv.style.display = 'none';
            rDiv.classList.remove('placeholder-page');

            let lpNum = book.isDoublePageView && book.currentPage % 2 === 0 ? book.currentPage - 1 : book.currentPage;
            if (book.isDoublePageView && lpNum <= 0) lpNum = 1; // Handle edge case

            let rpNum = book.isDoublePageView ? lpNum + 1 : -1;
            if (!book.isDoublePageView) { lpNum = book.currentPage; rpNum = -1; }
            if (lpNum > book.totalPages) lpNum = -1;
            if (rpNum > book.totalPages) rpNum = -1;

            // Clear canvases
            lCtx.clearRect(0, 0, lCanvas.width, lCanvas.height);
            rCtx.clearRect(0, 0, rCanvas.width, rCanvas.height);

            // Render Left Page
            if (lpNum >= 1 && lpNum <= book.totalPages) {
                lNum.textContent = lpNum;
                lDiv.style.visibility = 'visible';
                await renderPage(lpNum, 'left-page-canvas');
            } else {
                lDiv.style.visibility = 'hidden';
            }

            // Render Right Page or Placeholder
            if (book.isDoublePageView) {
                if (rpNum >= 1 && rpNum <= book.totalPages) {
                    rDiv.style.display = 'flex';
                    rDiv.classList.remove('placeholder-page');
                    rNum.textContent = rpNum;
                    await renderPage(rpNum, 'right-page-canvas');
                } else if (lpNum >= 1 && lpNum <= book.totalPages) {
                    rDiv.style.display = 'flex';
                    rDiv.classList.add('placeholder-page');
                    rNum.textContent = '';
                } else {
                    rDiv.style.display = 'none';
                }
            } else {
                rDiv.style.display = 'none';
            }

            updateSliderPosition();
            preloadAdjacentPages(book.currentPage);
            user.readingProgress.furthestPage = Math.max(user.readingProgress.furthestPage, book.currentPage);
            updateStatus(`Display updated. Current page: ${book.currentPage}, Left: ${lpNum}, Right: ${rpNum}`);
        }


        // --- Navigation (unchanged) ---
        function nextPage(){if(book.isDoublePageView){const n=book.currentPage%2===0?book.currentPage+1:book.currentPage+2;n<=book.totalPages&&jumpToPage(n)}else book.currentPage<book.totalPages&&jumpToPage(book.currentPage+1)}
        function prevPage(){if(book.isDoublePageView){const n=book.currentPage%2===0?book.currentPage-2:book.currentPage-1;n>=1&&jumpToPage(n)}else book.currentPage>1&&jumpToPage(book.currentPage-1)}
        function jumpToPage(pn){const n=Math.max(1,Math.min(pn,book.totalPages));if(n!==book.currentPage){book.currentPage=n;updateStatus(`Jumping to page ${n}`);requestAnimationFrame(updateDisplay)}else updateStatus(`Already on page ${n}`)}

        // --- View Modes (unchanged) ---
        function setSinglePageView(){if(!book.isDoublePageView&&!document.body.classList.contains("rotated-mode"))return;updateStatus("Switching to Single Page View");book.isDoublePageView=!1;document.body.classList.add("fullscreen-mode");document.body.classList.remove("rotated-mode");document.getElementById("single-page-btn")?.classList.add("active");document.getElementById("double-page-btn")?.classList.remove("active");document.getElementById("rotate-btn")?.classList.remove("active");requestAnimationFrame(updateDisplay)}
        function setDoublePageView(){if(book.isDoublePageView&&!document.body.classList.contains("rotated-mode")&&!document.body.classList.contains("fullscreen-mode"))return;updateStatus("Switching to Double Page View");book.isDoublePageView=!0;document.body.classList.remove("fullscreen-mode","rotated-mode");document.getElementById("double-page-btn")?.classList.add("active");document.getElementById("single-page-btn")?.classList.remove("active");document.getElementById("rotate-btn")?.classList.remove("active");requestAnimationFrame(updateDisplay)}
        function setRotatedView(){if(document.body.classList.contains("rotated-mode"))return;updateStatus("Switching to Rotated View");book.isDoublePageView=!1;document.body.classList.add("rotated-mode");document.body.classList.remove("fullscreen-mode");document.getElementById("rotate-btn")?.classList.add("active");document.getElementById("single-page-btn")?.classList.remove("active");document.getElementById("double-page-btn")?.classList.remove("active");requestAnimationFrame(updateDisplay)}

        // --- UI Toggles (unchanged) ---
        function toggleElement(id,show){const e=document.getElementById(id);if(e){e.classList.toggle("visible",show);updateStatus(`${show?"Showing":"Hiding"} element: ${id}`)}}
        function showTableOfContents(){toggleElement("toc-panel",!0)}
        function hideTableOfContents(){toggleElement("toc-panel",!1)}
        function showLoading(msg='Processing...'){const o=document.getElementById("loading-overlay");if(o){o.querySelector(".loading-message").textContent=msg;toggleElement("loading-overlay",!0)}}
        function hideLoading(){toggleElement("loading-overlay",!1)}

        // --- Slider Logic (unchanged) ---
        function showPageSlider(){const s=document.getElementById("page-slider-container");s?.classList.add("visible");resetSliderHideTimer()}
        function hidePageSlider(){const s=document.getElementById("page-slider-container");s?.classList.remove("visible")}
        function resetSliderHideTimer(){clearTimeout(sliderHideTimeout);sliderHideTimeout=setTimeout(hidePageSlider,3e3)}
        function initPageSlider(){const s=document.getElementById("page-slider"),c=document.getElementById("page-slider-container");if(!s||!c)return;let isSliding=!1;s.addEventListener("input",()=>{showPageSlider();isSliding=!0;const p=parseInt(s.value);updateSliderPosition(p);updateSliderStyle(s,p)});s.addEventListener("change",()=>{isSliding=!1;const p=parseInt(s.value);jumpToPage(p);resetSliderHideTimer()});c.addEventListener("mouseenter",()=>clearTimeout(sliderHideTimeout));c.addEventListener("mouseleave",()=>{isSliding||resetSliderHideTimer()})}
        function updateSliderTotalPages(){const s=document.getElementById("page-slider"),t=document.getElementById("total-pages-display");if(s&&t){s.max=book.totalPages||1;t.textContent=book.totalPages||1;updateSliderPosition()}}
        function updateSliderPosition(p=book.currentPage){const s=document.getElementById("page-slider"),c=document.getElementById("current-page-display");if(s&&c){s.value=p;c.textContent=`Page ${p}`;updateSliderStyle(s,p)}}
        function updateSliderStyle(sEl,val){const percent=(val-sEl.min)/(sEl.max-sEl.min)*100;sEl.style.setProperty("--slider-percent",`${percent}%`)}

        // --- Load PDF (Improved Error Handling) ---
        async function loadPdf(source, filename = "Document") {
            updateStatus("loadPdf started");
            showLoading("Initializing PDF...");
            pageCache.clear(); currentViewports = {};
            keywordDefinitions = {}; pageKeywords = {};
            hideDefinitionPopup();

            if (book.pdfDocument) { try { book.pdfDocument.destroy(); } catch (e) { console.warn("PDF destroy error:", e); } book.pdfDocument = null; }

            try {
                let loadTask; let inferredFilename = filename; let overlayLoaded = false;
                let overlayErrorMsg = null; // Store potential overlay error

                if (typeof source === 'string') {
                    updateStatus(`Loading PDF from URL: ${source}`);
                    loadTask = pdfjsLib.getDocument(source);
                    if (filename === "Document") { try { inferredFilename = decodeURIComponent(source.split('/').pop()); } catch(e){} }

                    const overlayUrl = source.replace(/\.pdf$/i, '.overlay.json');
                    updateStatus(`Attempting to fetch overlay from: ${overlayUrl}`);
                    try {
                        const overlayResponse = await fetch(overlayUrl);
                        if (!overlayResponse.ok) {
                             throw new Error(`HTTP error! Status: ${overlayResponse.status}`);
                        }
                        const contentType = overlayResponse.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                             throw new Error(`Expected JSON, but received Content-Type: ${contentType || 'N/A'}`);
                        }
                        const overlayData = await overlayResponse.json();
                        if (!overlayData || typeof overlayData.keywords !== 'object' || typeof overlayData.pages !== 'object') {
                            throw new Error("Invalid overlay file structure.");
                        }
                        keywordDefinitions = overlayData.keywords || {};
                        pageKeywords = overlayData.pages || {};
                        overlayLoaded = true;
                        updateStatus(`Overlay loaded: ${Object.keys(keywordDefinitions).length} keywords, ${Object.keys(pageKeywords).length} pages.`);
                    } catch (overlayError) {
                        console.warn(`Could not load or parse overlay from ${overlayUrl}:`, overlayError);
                        overlayErrorMsg = overlayError.message; // Store message for later alert
                        keywordDefinitions = {}; pageKeywords = {};
                    }
                } else {
                     throw new Error("Invalid source type for loadPdf. Only URL loading is supported.");
                 }

                book.pdfDocument = await loadTask.promise;
                book.totalPages = book.pdfDocument.numPages; book.currentPage = 1; user.readingProgress.furthestPage = 1;
                book.title = inferredFilename.replace(/\.pdf$/i, '');
                updateStatus(`PDF loaded: ${book.title}, Pages: ${book.totalPages}`);
                document.title = `${book.title} - Heritage Historyâ„¢ Reader`;
                updateSliderTotalPages();
                showLoading("Processing metadata...");

                // Show overlay warning only if PDF load succeeded but overlay failed
                if (!overlayLoaded && overlayErrorMsg) {
                     const overlayUrl = source.replace(/\.pdf$/i, '.overlay.json');
                     alert(`Warning: PDF loaded, but overlay file (${overlayUrl}) could not be fetched or parsed. Definitions will not work.\nError: ${overlayErrorMsg}`);
                }

                try { book.outline = await book.pdfDocument.getOutline(); populateTOC(); }
                catch (oe) { console.warn("Could not get PDF outline:", oe); book.outline = []; populateTOC(); }

                if (window.innerWidth < 1000) { setSinglePageView(); } else { setDoublePageView(); }

                requestAnimationFrame(() => { updateStatus("Performing post-load display update."); updateDisplay(); });

            } catch (e) {
                console.error("Error loading PDF:", e);
                alert(`Failed to load PDF: ${e.message || e}`);
                book.pdfDocument = null; book.totalPages = 0; book.currentPage = 1; book.title = "No Document"; book.outline = [];
                keywordDefinitions = {}; pageKeywords = {};
                document.title = "Heritage Historyâ„¢ - Digital Book Reader";
                updateSliderTotalPages(); updateSliderPosition(); populateTOC();

                // **FIXED:** Safely clear display elements and show error message
                const lDiv = document.querySelector('.book-page.left');
                const rDiv = document.querySelector('.book-page.right');
                try { document.getElementById('left-page-canvas')?.getContext('2d').clearRect(0,0,1,1); } catch (err) {}
                try { document.getElementById('right-page-canvas')?.getContext('2d').clearRect(0,0,1,1); } catch (err) {}
                const lTextEl = document.getElementById('left-text-layer'); if (lTextEl) lTextEl.innerHTML = '';
                const rTextEl = document.getElementById('right-text-layer'); if (rTextEl) rTextEl.innerHTML = '';
                const lAnnEl = document.getElementById('left-annotation-layer'); if (lAnnEl) lAnnEl.innerHTML = '';
                const rAnnEl = document.getElementById('right-annotation-layer'); if (rAnnEl) rAnnEl.innerHTML = '';

                 if (lDiv) lDiv.style.visibility = 'hidden';
                 if (rDiv) {
                    rDiv.classList.add('placeholder-page');
                    rDiv.style.display = 'flex'; // Show placeholder area even in double view error
                 }
                 // Display error message in viewer area
                 const mainContainer = document.querySelector('.main-container .book-spread');
                 if (mainContainer) {
                     mainContainer.innerHTML = `<div style="color: var(--text-on-page); padding: 30px; text-align: center; width: 100%; max-width: var(--page-w); background: var(--page); border-radius: 5px; margin: auto;">Failed to load document. Please check the URL parameter and file path.<br>Error: ${e.message || 'Unknown error'}</div>`;
                 }

            } finally {
                hideLoading();
            }
        }


        // --- TOC population (unchanged) ---
        function populateTOC(){const t=document.getElementById("toc-list"),o=book.outline||[];t.innerHTML="";if(0===o.length){t.innerHTML="<li>No outline found in PDF.</li>";document.getElementById("toc-btn")?.setAttribute("disabled","");return}document.getElementById("toc-btn")?.removeAttribute("disabled");const c=d=>{const l=document.createElement("ul");l.className="toc-sections";return d.forEach(i=>{const s=document.createElement("li");s.className="toc-section";s.textContent=i.title;s.addEventListener("click",()=>(jumpToPage(i.pageIndex+1),hideTableOfContents()));l.appendChild(s)}),l},p=o=>{const l=document.createElement("ul");l.id="toc-chapter-list";return o.forEach(i=>{const c=document.createElement("li");c.className="toc-chapter";const t=document.createElement("div");t.className="toc-chapter-title";t.textContent=i.title;t.addEventListener("click",()=>{if(i.items&&i.items.length>0){const e=c.querySelector(".toc-sections");e?e.style.display="none"===e.style.display?"block":"none":c.appendChild(createSections(i.items))}i.dest&&linkService.navigateTo(i.dest)});c.appendChild(t);i.items&&i.items.length>0&&(t.style.cursor="pointer");l.appendChild(c)}),l};t.appendChild(p(o))}

        // --- Event Setup (unchanged) ---
        function setupEvents() {
            updateStatus("Setting up events");
            document.getElementById('new-toolbar')?.addEventListener('click', e => {
                const btn = e.target.closest('.new-btn'); if (!btn || btn.hasAttribute('disabled')) return;
                const id = btn.id; updateStatus(`Toolbar button clicked: ${id}`);
                switch (id) {
                    case 'single-page-btn': setSinglePageView(); break;
                    case 'double-page-btn': setDoublePageView(); break;
                    case 'rotate-btn': setRotatedView(); break;
                    case 'toc-btn': showTableOfContents(); break;
                }
                resetSliderHideTimer(); manageToolbar(!0); toolbarHover = !1; manageToolbar(!1);
            });
            document.getElementById('close-toc-btn')?.addEventListener('click', hideTableOfContents);
            document.getElementById('close-popup-btn')?.addEventListener('click', hideDefinitionPopup);
             document.querySelectorAll('.textLayer').forEach(layer => {
                 layer.addEventListener('mouseover', e => { if (e.target.classList.contains('keyword-interactive')) e.target.classList.add('keyword-hover-highlight'); });
                 layer.addEventListener('mouseout', e => { if (e.target.classList.contains('keyword-interactive')) e.target.classList.remove('keyword-hover-highlight'); });
                 layer.addEventListener('click', e => { if (e.target.classList.contains('keyword-interactive')) { e.stopPropagation(); const k = e.target.dataset.keyword, d = e.target.dataset.definition; if (k && d) { const r = e.target.getBoundingClientRect(); showDefinitionPopup(k, d, r.left, r.bottom); } } });
             });
            document.querySelectorAll('.page-edge-nav').forEach(el=>{el.addEventListener("click",()=>{el.classList.contains("page-edge-left")?prevPage():nextPage();showPageSlider()})});
            document.addEventListener('keydown', e => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || document.querySelector('.toc-panel.visible') || definitionPopup.classList.contains('visible')) return;
                if (e.ctrlKey || e.altKey || e.metaKey) return;
                let navAct = false;
                switch (e.key) {
                     case 'ArrowLeft': case 'PageUp': prevPage(); navAct = true; break;
                     case 'ArrowRight': case 'PageDown': nextPage(); navAct = true; break;
                     case 'Home': jumpToPage(1); navAct = true; break;
                     case 'End': jumpToPage(book.totalPages); navAct = true; break;
                     case 'f': case 'F': document.body.classList.contains('fullscreen-mode') || document.body.classList.contains('rotated-mode') ? setDoublePageView() : setSinglePageView(); navAct = true; break;
                     case 'Escape': hideDefinitionPopup(); navAct = true; break;
                 }
                if (navAct) { e.preventDefault(); showPageSlider(); manageToolbar(!1); }
            });
            window.addEventListener('resize', () => { clearTimeout(resizeTimer); resizeTimer = setTimeout(() => { updateStatus("Window resized, updating display."); requestAnimationFrame(updateDisplay); }, 250); });
            document.querySelector('.main-container').addEventListener('dblclick',e=>{if(e.target.closest(".book-page,.page-edge-nav,#new-toolbar,.toc-panel,#definition-popup"))return;if(document.fullscreenElement){try{document.exitFullscreen()}catch(e){console.warn("Exiting fullscreen failed:",e)}}else{try{document.documentElement.requestFullscreen()}catch(e){console.warn("Entering fullscreen failed:",e)}}});
             let tsX=0,tsY=0,tst=0; const SW_TH=50,SW_TL=500,SW_A=35;
             document.body.addEventListener('touchstart',e=>{if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .toc-panel, .page-edge-nav, .new-btn, button, input, a, #page-slider-trigger-zone, #definition-popup, .keyword-interactive, .linkAnnotation'))return;tsX=e.touches[0].clientX;tsY=e.touches[0].clientY;tst=Date.now()},{passive:!0});
             document.body.addEventListener('touchend',e=>{if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, .toc-panel, .page-edge-nav, .new-btn, button, input, a, #page-slider-trigger-zone, #definition-popup, .keyword-interactive, .linkAnnotation'))return;if(e.changedTouches.length>0){const tc=e.changedTouches[0],ex=tc.clientX,ey=tc.clientY,dx=ex-tsX,dy=ey-tsY,dt=Date.now()-tst;if(dt<SW_TL&&Math.abs(dx)>SW_TH&&Math.abs(Math.atan2(dy,dx)*180/Math.PI)<SW_A)handleSwipe(tsX,tsY,ex,ey),showPageSlider()}},{passive:!0});
             function handleSwipe(sx,sy,ex,ey){ex>sx?prevPage():nextPage()}
            const sliderTriggerZone = document.getElementById('page-slider-trigger-zone'),sliderContainer = document.getElementById('page-slider-container');
            if(sliderTriggerZone&&sliderContainer){let t=null;sliderTriggerZone.addEventListener("mouseenter",()=>{clearTimeout(t);showPageSlider()});sliderTriggerZone.addEventListener("mouseleave",()=>{t=setTimeout(hidePageSlider,500)})}else console.warn("Page slider trigger zone or container not found.");
            document.addEventListener('click', (event) => { if (definitionPopup.classList.contains('visible') && !definitionPopup.contains(event.target) && !event.target.classList.contains('keyword-interactive')) { hideDefinitionPopup(); } }, true);
            updateStatus("Events setup complete");
        }

        // --- Definition Popup Logic (unchanged) ---
        function showDefinitionPopup(word, definition, clickLeft, clickBottom) {
             if (!definitionPopup || !popupWord || !popupDefinition) return;
             popupWord.textContent = word.charAt(0).toUpperCase() + word.slice(1);
             popupDefinition.innerHTML = definition;
             let popupLeft = clickLeft, popupTop = clickBottom + 5;
             definitionPopup.style.left = `${popupLeft}px`; definitionPopup.style.top = `${popupTop}px`;
             definitionPopup.style.display = 'block'; definitionPopup.style.opacity = '0';
             definitionPopup.style.transform = 'scale(0.95)'; definitionPopup.style.pointerEvents = 'none';
             requestAnimationFrame(() => { // Use rAF for layout calculation
                 const popupRect = definitionPopup.getBoundingClientRect(), winWidth = window.innerWidth, winHeight = window.innerHeight;
                 if (popupLeft + popupRect.width > winWidth - 10) { popupLeft = clickLeft - popupRect.width - 5; } // Try left
                 if (popupLeft < 10) { popupLeft = 10; } // Keep on screen left
                 if (popupTop + popupRect.height > winHeight - 10) { popupTop = clickBottom - popupRect.height - 10; } // Try above
                 if (popupTop < 10) { popupTop = 10; } // Keep on screen top
                 definitionPopup.style.left = `${popupLeft}px`; definitionPopup.style.top = `${popupTop}px`;
                 definitionPopup.classList.add('visible'); definitionPopup.style.pointerEvents = 'auto';
                 updateStatus(`Popup shown for "${word}"`);
             });
         }
        function hideDefinitionPopup() { if (definitionPopup) { definitionPopup.classList.remove('visible'); definitionPopup.style.pointerEvents = 'none'; } }

        // --- Initialization (Improved Error Display) ---
        async function init() {
            updateStatus("Initializing app");
            try {
                try { PAGE_PADDING = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-padding')) || 15; }
                catch (ce) { PAGE_PADDING = 15; }
                updateStatus(`Page padding: ${PAGE_PADDING}px`);

                setupEvents();
                setupToolbarHover();
                initPageSlider();
                // Don't hide loading initially, loadPdf handles it

                const urlParams = new URLSearchParams(window.location.search);
                const pdfUrlParam = urlParams.get('pdf');

                if (pdfUrlParam) {
                     updateStatus(`Found PDF parameter in URL: ${pdfUrlParam}`);
                     await loadPdf(pdfUrlParam); // Let loadPdf manage loading state
                 } else {
                    updateStatus("No PDF specified in URL. Please load via URL parameter.");
                    // Display error message prominently
                    const mainContainer = document.querySelector('.main-container .book-spread');
                    if(mainContainer) {
                         mainContainer.innerHTML = `<div style="color: var(--text-on-page); padding: 30px; text-align: center; width: 100%; max-width: var(--page-w); background: var(--page); border-radius: 5px; margin: auto;">No document specified. Please load a document using the 'pdf' URL parameter.<br>Example: ?pdf=chapters/ancient-history/chapter-2.pdf</div>`;
                    }
                    const lDiv = document.querySelector('.book-page.left'), rDiv = document.querySelector('.book-page.right');
                    if(lDiv) lDiv.style.visibility = 'hidden';
                    if(rDiv) rDiv.style.display = 'none';
                    hideLoading(); // Hide loading if no PDF param
                }

                window.addEventListener('beforeunload', () => { if (book.pdfDocument) localStorage.setItem(`${book.title}_progress`, JSON.stringify({ currentPage: book.currentPage, furthestPage: user.readingProgress.furthestPage })); });
                updateStatus("Init complete.");

            } catch (e) {
                 console.error("Initialization failed:", e);
                 alert(`Application initialization failed: ${e.message}`);
                 hideLoading(); // Ensure loading is hidden on init failure
                 const mainContainer = document.querySelector('.main-container .book-spread');
                 if(mainContainer) {
                     mainContainer.innerHTML = `<div style="color: var(--text-on-page); padding: 30px; text-align: center; width: 100%; max-width: var(--page-w); background: var(--page); border-radius: 5px; margin: auto;">Initialization Error: ${e.message || 'Unknown error'}</div>`;
                 }
             }
        }

        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
