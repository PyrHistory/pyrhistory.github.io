<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heritage History™ - Digital Book Reader</title>
    <!-- Using PDF.js v2.5.207 as base for rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.min.js"></script>
    <!-- Viewer script still used for SimpleLinkService and CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf_viewer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf_viewer.css">
    <style>
:root{
    --primary:#4a90e2;
    --secondary:#50e3c2;
    --accent:#f5a623; /* Amber/Orange */
    --fiery-orange: #f97316; /* Fiery orange (Tailwind Orange 600) */
    --lab-blue:#080e1c;
    --page:#fff;
    --text-on-dark:rgba(255,255,255,.9);
    --text-on-page:#333;
    --header-h:60px;
    --page-w:650px;
    --page-h:842px;
    --page-padding:15px;
    --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
}
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family: 'Georgia', serif;
    background-color:var(--lab-blue);
    color:var(--text-on-dark);
    height:100vh; width:100vw;
    overflow:hidden; display:flex; flex-direction:column; position:fixed;
    line-height:1.6
}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background-image:radial-gradient(circle at 15% 15%,rgba(249,115,22,.12) 0,transparent 45%),radial-gradient(circle at 85% 85%,rgba(197,83,235,.12) 0,transparent 45%),radial-gradient(circle at 85% 15%,rgba(56,189,248,.05) 0,transparent 40%),radial-gradient(circle at 15% 85%,rgba(251,191,36,.08) 0,transparent 40%);animation:ambient-shift 30s ease infinite alternate}
@keyframes ambient-shift{0%{background-position:0 0,0 0,0 0,0 0}100%{background-position:5% 10%,-5% -5%,10% -5%,-10% 5%}}
@media (prefers-reduced-motion:reduce){body::before{animation:none!important}}
#new-toolbar{position:fixed!important;top:15px!important;right:-60px!important;z-index:9999!important;display:flex!important;flex-direction:column!important;gap:10px!important;transition:right .3s ease,bottom .3s ease,transform .3s ease!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);padding:5px!important;border-radius:8px 0 0 8px!important;box-shadow:-2px 2px 10px rgba(0,0,0,.4)!important;width:58px;border:1px solid rgba(255,255,255,.1)}
#new-toolbar::before{content:"≡";position:absolute;left:-25px;top:50%;transform:translateY(-50%);background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);width:25px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;color:var(--text-on-dark);font-size:20px;box-shadow:-2px 2px 5px rgba(0,0,0,.3);transition:all .3s ease;border:1px solid rgba(255,255,255,.1);border-right:none;cursor:pointer}
.toolbar-trigger-area{position:fixed;top:0;right:0;width:30px;height:100%;z-index:9998;transition:all .3s ease}
#new-toolbar.visible{right:0!important;transform:none!important}
.new-btn{background:rgba(44,62,80,.8)!important;border:1px solid rgba(255,255,255,.15)!important;color:var(--text-on-dark)!important;width:48px!important;height:48px!important;border-radius:4px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:25px!important;cursor:pointer!important;transition:all .2s!important;box-shadow:0 2px 5px rgba(0,0,0,.2)!important;user-select:none!important;flex-shrink:0}
.new-btn:hover{background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;transform:translateY(-2px)!important}
.new-btn:active{transform:translateY(1px)!important}
.new-btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
.rotated-mode #new-toolbar{top:auto!important;right:50%!important;bottom:-60px!important;transform:translateX(50%)!important;flex-direction:row!important;width:auto!important;height:58px!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:8px 8px 0 0!important;padding:5px 10px!important;box-shadow:0 -2px 10px rgba(0,0,0,.4)!important;border:1px solid rgba(255,255,255,.1);border-bottom:none}
.rotated-mode #new-toolbar.visible{bottom:0!important;transform:translateX(50%)!important}
.rotated-mode #new-toolbar::before{left:50%!important;transform:translateX(-50%)!important;top:-25px!important;width:40px!important;height:25px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:4px 4px 0 0!important;content:"≡";padding-bottom:5px;color:var(--text-on-dark);border:1px solid rgba(255,255,255,.1);border-bottom:none;cursor:pointer}
.rotated-mode .toolbar-trigger-area{top:auto!important;bottom:0!important;left:0!important;transform:none!important;right:auto!important;width:100%!important;height:30px!important}
.rotated-mode #new-toolbar .new-btn{width:40px!important;height:40px!important;font-size:20px!important;transform: rotate(90deg)}
.rotated-mode .new-btn:hover {transform: rotate(90deg) scale(1.1);background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}
.rotated-mode .new-btn:active {transform: rotate(90deg) scale(0.95)}
.main-container{flex:1;display:flex;justify-content:center!important;align-items:center!important;padding:0;height:100%;width:100%;overflow:hidden;position:relative;background:transparent}
.book-spread{display:flex;box-shadow:0 10px 35px rgba(0,0,0,.5);position:fixed!important;top:50%!important;left:50%!important;transform-origin:center center;width:auto!important;height:auto!important;transition:transform .3s ease; transform: translate(-50%, -50%)}
.book-page{width:var(--page-w);height:var(--page-h);background-color:var(--page);position:relative;overflow:hidden; flex-shrink:0;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08);padding:0;}
.book-page.left{border-right:1px solid rgba(255,255,255,.15);border-radius:3px 0 0 3px}
.book-page.right{border-left:1px solid rgba(255,255,255,.15);border-radius:0 3px 3px 0}
.fullscreen-mode:not(.rotated-mode) .book-page.left{border-right:1px solid rgba(255,255,255,.08)!important}
.canvas-container {
    position: relative; /* Important for positioning layers */
    width: calc(100% - 2 * var(--page-padding));
    height: calc(100% - 2 * var(--page-padding));
    margin: var(--page-padding);
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* Clip layers */
}
.pdf-canvas{max-width:100%;max-height:100%;display:block;object-fit:contain;box-shadow: none; position: absolute; top: 0; left: 0; z-index: 1; } /* Canvas layer */
.page-number{display:none}
.page-loading-overlay{position:absolute;inset:var(--page-padding);background:rgba(255,255,255,.6);z-index:50;display:none;justify-content:center;align-items:center;border-radius:3px}
.page-loading-spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(0,0,0,.1);border-top-color:var(--primary);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-edge-nav{position:absolute;top:0;height:100%;width:50px;cursor:pointer;z-index:10;transition:background-color .2s;-webkit-tap-highlight-color:transparent}
.page-edge-nav:hover{background-color:rgba(0,0,0,.03)}
.page-edge-left{left:0;border-radius:3px 0 0 3px}
.page-edge-right{right:0;border-radius:0 3px 3px 0}
.page-edge-left:hover::after,.page-edge-right:hover::after{content:"";position:absolute;top:50%;width:12px;height:12px;border-style:solid;border-color:rgba(0,0,0,.6);border-width:2px 2px 0 0;opacity:.8}
.page-edge-left:hover::after{left:18px;transform:translateY(-50%) rotate(-135deg)}
.page-edge-right:hover::after{right:18px;transform:translateY(-50%) rotate(45deg)}
.fullscreen-mode .book-page.right{display:none!important}
.fullscreen-mode .book-page.left{max-width:95vw;max-height:95vh;width:auto;height:auto;border-radius:5px!important;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08)!important;padding:0;}
.fullscreen-mode .canvas-container { margin: var(--page-padding); }
.fullscreen-mode .pdf-canvas{max-width:100%;max-height:100%;object-fit:contain; position:relative; z-index: 1; }
.rotated-mode .book-page.left{width:var(--page-w)!important;height:var(--page-h)!important;border-radius:0!important;border:none!important;padding:0 !important;background-color:var(--page);display:flex;justify-content:center;align-items:center}
.rotated-mode .canvas-container { margin: 10px !important; width: calc(100% - 20px); height: calc(100% - 20px); }
.rotated-mode .book-page.right{display:none!important}
.rotated-mode .pdf-canvas{box-shadow:none;max-width:100%;max-height:100%;object-fit:contain; position: relative; z-index: 1;}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page{width:var(--page-w);height:var(--page-h)}
.book-page.right.placeholder-page{background-color:var(--page)!important;border-left:1px solid rgba(0,0,0,.1);position:relative;display:flex!important;justify-content:center;align-items:center}
.book-page.right.placeholder-page::after{content:"End of document";font-size:14px;font-style:italic;color:rgba(0,0,0,.5)}
.book-page.right.placeholder-page .canvas-container,.book-page.right.placeholder-page .page-edge-nav,.book-page.right.placeholder-page .page-loading-overlay{display:none}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left .canvas-container::after { content: ''; position: absolute; top: 0; right: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to left, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 0 2px 2px 0; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) .canvas-container::before { content: ''; position: absolute; top: 0; left: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to right, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 2px 0 0 2px; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right.placeholder-page { border-left: 1px solid rgba(0,0,0,.1) !important; }
.toc-panel{position:fixed;z-index:10000;display:none;color:var(--text-on-page); left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;height:80vh;background:#f0f4f8;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,.5);flex-direction:column;overflow:hidden; font-family: var(--font-sans);}
.toc-panel.visible,.loading-overlay.visible{display:flex!important}
.toc-header{padding:15px 20px;background:var(--primary);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.toc-header .notes-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0 5px;line-height:1}
.toc-content{flex:1;padding:10px 20px;overflow-y:auto}
.toc-chapter{padding:8px 0;border-bottom:1px solid #d8dfe6}
.toc-chapter-title{font-weight:700;color:var(--primary);cursor:pointer;padding:5px 0}
.toc-chapter-title:hover,.toc-section:hover{color:var(--accent)}
.toc-sections{padding-left:20px;margin-top:5px}
.toc-section{padding:4px 0;cursor:pointer;color:#4a5568;font-size:.95em}
.loading-overlay{position:fixed;inset:0;background:rgba(8,14,28,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:10001;display:none;justify-content:center;align-items:center;flex-direction:column}
.loading-spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:15px}
.loading-message{font-size:16px;color:var(--text-on-dark)}
#status-indicator{display:none}
.page-slider-container{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:700px;padding:14px 20px;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-bottom:none;box-shadow:0 -4px 20px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;z-index:9998;transition:bottom .35s cubic-bezier(.2,.9,.3,1),transform .35s cubic-bezier(.2,.9,.3,1), left .35s cubic-bezier(.2,.9,.3,1);border-radius:16px 16px 0 0}
.page-slider-container.visible{bottom:0}
.page-slider-track{width:100%;margin-bottom:8px;padding:0 10px}
.page-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);outline:none;border-radius:3px;overflow:visible;cursor:pointer;transition:height .2s}
.page-slider:hover{height:8px}
.page-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition:all .2s ease;margin-top:-7px}
.page-slider::-webkit-slider-thumb:hover{width:24px;height:24px;margin-top:-8px}
.page-slider::-webkit-slider-runnable-track{height:100%;background:linear-gradient(to right,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%));border-radius:3px}
.page-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4)}
.page-slider::-moz-range-thumb:hover{width:24px;height:24px}
.page-slider::-moz-range-progress{background-color:var(--accent);height:100%;border-radius:3px}
.page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);height:100%;border-radius:3px}
.page-slider-info{font-size:12px;color:var(--text-on-dark);font-weight:500;letter-spacing:.3px;opacity:.8}
.rotated-mode .page-slider-container{bottom:50%!important;left:-80px!important;top:auto!important;transform:translateY(50%)!important;width:60px!important;height:70vh!important;max-width:none!important;max-height:500px;flex-direction:column-reverse!important;padding:10px 5px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 12px 12px 0!important;box-shadow:2px 0 20px rgba(0,0,0,.4)!important}
.rotated-mode .page-slider-container.visible{left:0!important}
.rotated-mode .page-slider-track{width:100%!important;height:100%!important;margin-bottom:0!important;padding:10px 0!important;display:flex;align-items:center;flex:1}
.rotated-mode .page-slider{width:6px!important;height:100%!important;writing-mode:vertical-lr!important;-webkit-appearance:slider-vertical!important;appearance:slider-vertical;margin:0 auto!important;padding:0!important;background:rgba(255,255,255,.1)!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-runnable-track{width:6px!important;height:100%;background:linear-gradient(to top,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%))!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width:20px!important;height:20px!important;border-radius: 50%;background: var(--accent);cursor: pointer;border: 3px solid rgba(28,37,54,.9)!important;box-shadow: 0 1px 6px rgba(0,0,0,.4);transition: all .2s ease;margin-top:0!important;margin-left:-7px!important}
.rotated-mode .page-slider:hover::-webkit-slider-thumb {width: 24px !important;height: 24px !important;margin-left: -9px !important}
.rotated-mode .page-slider::-moz-range-thumb{width: 20px;height: 20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition: all .2s ease}
.rotated-mode .page-slider:hover::-moz-range-thumb {width: 24px;height: 24px}
.rotated-mode .page-slider::-moz-range-progress{background-color:var(--accent)!important;width:6px!important;border-radius:3px}
.rotated-mode .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);width:6px!important;border-radius:3px}
.rotated-mode .page-slider-info{transform:rotate(90deg);white-space:nowrap;margin-bottom:15px;padding-top:10px;color:var(--text-on-dark)}
#page-slider-trigger-zone {position: fixed;bottom: 0;left: 0;width: 100%;height: 30px;z-index: 9997;pointer-events: auto}
.rotated-mode #page-slider-trigger-zone {bottom: auto;top: 50%;left: 0;width: 30px;height: 100%;transform: translateY(-50%);pointer-events: auto;}

/* --- Base Text Layer (Hidden) & Annotation Layer Styles --- */
.textLayer {
    position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden;
    opacity: 1; line-height: 1.0; color: transparent !important;
    user-select: none; -webkit-user-select: none; pointer-events: none !important;
    z-index: 2;
}
.textLayer > div {
    position: absolute; white-space: pre; cursor: default; transform-origin: 0% 0%;
    pointer-events: none !important; border-radius: 2px;
}
.annotationLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; pointer-events: none; z-index: 3; }
.annotationLayer section { position: absolute; pointer-events: auto; }
.annotationLayer .linkAnnotation > a { position: absolute; font-size: 1em; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid transparent; transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out; }
.annotationLayer .linkAnnotation > a:hover { cursor: pointer; background-color: rgba(255, 255, 0, 0.2); border: 1px solid rgba(255, 255, 0, 0.5); box-shadow: 0px 0px 2px rgba(255, 255, 0, 0.5); }

/* --- START: Custom Keyword Overlay & Popup Styles (UPDATED) --- */
.keyword-overlay-container {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 4; overflow: hidden;
}

.keyword-highlight {
  position: relative; /* Needed for ::before */
  overflow: visible; /* Allow pseudo-element blur to show */
  z-index: 5; /* Ensure highlight is clickable */
  /* --- Base style --- */
  display: inline-block; /* Treat like text span */
  position: absolute; /* Still position absolutely */
  background: transparent;
  pointer-events: auto;
  cursor: pointer;
  box-sizing: border-box;
  border-radius: 3px;
  /* No transition on base element needed if only pseudo changes */
}

.keyword-highlight::before {
    content: "";
    position: absolute;
    z-index: -1; /* Behind the (invisible) text content */
    /* Make slightly larger for glow */
    top: -2px; left: -2px; right: -2px; bottom: -2px;
    /* Gradient definition */
    background: linear-gradient(90deg, var(--fiery-orange), var(--accent), var(--fiery-orange));
    background-size: 300% 300%;
    border-radius: 4px; /* Slightly larger radius than parent */
    filter: blur(2px); /* Initial blur */
    opacity: 0; /* Start invisible */
    transition: opacity 0.3s ease-out, filter 0.3s ease-out; /* Transition for hover */
    animation: hazyGradientAnimation 6s linear infinite; /* Apply animation */
}

.keyword-highlight:hover::before {
    opacity: 0.8; /* Fade in */
    filter: blur(4px); /* Increase blur slightly */
}

/* Definition Popup - Modern Styling */
#definition-popup {
  position: fixed; background: #ffffff; border-radius: 8px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
  padding: 14px 18px; max-width: 320px; min-width: 180px;
  font-family: var(--font-sans); color: #2d3748; z-index: 10002;
  transform-origin: top center; transform: translateY(6px) scale(0.97);
  opacity: 0; visibility: hidden;
  transition: transform 0.18s cubic-bezier(0.4, 0, 0.2, 1),
              opacity 0.18s cubic-bezier(0.4, 0, 0.2, 1),
              visibility 0s linear 0.18s;
  pointer-events: none;
}
#definition-popup.visible {
  transform: translateY(0) scale(1); opacity: 1; visibility: visible;
  transition: transform 0.18s cubic-bezier(0.4, 0, 0.2, 1),
              opacity 0.18s cubic-bezier(0.4, 0, 0.2, 1),
              visibility 0s linear 0s;
   pointer-events: auto;
}
#popup-word { /* Title */
  font-weight: 600; font-size: 15px; margin: 0 0 10px 0;
  color: var(--primary); border-bottom: 1px solid #e2e8f0; padding: 0 0 8px 0;
}
#popup-definition { /* Content */
  font-size: 14px; line-height: 1.6; max-height: 180px; overflow-y: auto;
  color: #4a5568; padding-right: 5px; margin-right: -5px;
}
#popup-definition::-webkit-scrollbar { width: 5px; }
#popup-definition::-webkit-scrollbar-track { background: #edf2f7; border-radius: 3px;}
#popup-definition::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 3px;}
#popup-definition::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
#close-popup-btn { /* Close button */
  position: absolute; top: 6px; right: 6px; cursor: pointer; font-size: 20px; font-weight: 300;
  color: #a0aec0; transition: color 0.2s, background-color 0.2s; background: none; border: none;
  padding: 0; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%; line-height: 1;
}
#close-popup-btn:hover { color: #4a5568; background-color: #edf2f7; }
/* --- END: Custom Keyword Overlay & Popup Styles --- */

/* --- Hazy Gradient Animation Keyframes --- */
@keyframes hazyGradientAnimation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

    </style>
</head>
<body>
    <!-- Toolbar, Trigger Area, Status Indicator -->
    <div id="new-toolbar"></div>
    <div class="toolbar-trigger-area" id="toolbar-trigger-area"></div>
    <div id="status-indicator">Status: Initializing...</div>

    <!-- Main Content Area -->
    <div class="main-container">
        <div class="book-spread">
            <!-- Left Page -->
            <div class="book-page left">
                <div class="canvas-container">
                    <canvas id="left-page-canvas" class="pdf-canvas"></canvas>
                    <div class="textLayer" id="left-text-layer"></div>
                    <div class="annotationLayer" id="left-annotation-layer"></div>
                    {/* *** Custom Keyword Overlay *** */}
                    <div class="keyword-overlay-container" id="left-keyword-overlay"></div>
                </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="left-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
            <!-- Right Page -->
            <div class="book-page right placeholder-page">
                 <div class="canvas-container">
                    <canvas id="right-page-canvas" class="pdf-canvas"></canvas>
                     <div class="textLayer" id="right-text-layer"></div>
                     <div class="annotationLayer" id="right-annotation-layer"></div>
                     {/* *** Custom Keyword Overlay *** */}
                     <div class="keyword-overlay-container" id="right-keyword-overlay"></div>
                 </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="right-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
        </div>
    </div>

    <!-- Modals and Overlays -->
    <div class="toc-panel" id="toc-panel"></div>
    <div class="loading-overlay" id="loading-overlay"></div>
    <div class="page-slider-container" id="page-slider-container"></div>
    <div id="page-slider-trigger-zone"></div>

    <!-- *** Custom Definition Popup Structure *** -->
    <div class="definition-popup" id="definition-popup">
        <button class="definition-popup-close" id="close-popup-btn" title="Close (Esc)">×</button>
        <div class="definition-popup-title" id="popup-word">Keyword</div>
        <div class="definition-popup-content" id="popup-definition">Loading definition...</div>
    </div>

<script>
    // Populate Inner HTML directly (Toolbar, TOC, Loading, Slider) - Unchanged
    document.getElementById('new-toolbar').innerHTML = `<button class="new-btn" id="single-page-btn" title="Single Page View">☰</button><button class="new-btn" id="double-page-btn" title="Double Page View">◫</button><button class="new-btn" id="rotate-btn" title="Rotate View">📱</button><button class="new-btn" id="toc-btn" title="Table of Contents" disabled>📑</button>`;
    document.getElementById('toc-panel').innerHTML = `<div class="toc-header"><span>Table of Contents</span><button class="notes-close" id="close-toc-btn">×</button></div><div class="toc-content"><div id="toc-list">Loading...</div></div>`;
    document.getElementById('loading-overlay').innerHTML = `<div class="loading-spinner"></div><div class="loading-message">Processing...</div>`;
    document.getElementById('page-slider-container').innerHTML = `<div class="page-slider-track"><input type="range" id="page-slider" class="page-slider" min="1" max="1" value="1" style="--slider-percent: 0%"></div><div class="page-slider-info"><span id="current-page-display">Page 1</span> of <span id="total-pages-display">1</span></div>`;
</script>
<script>
    // --- UI Elements ---
    const definitionPopup = document.getElementById('definition-popup');
    const popupWord = document.getElementById('popup-word');
    const popupDefinition = document.getElementById('popup-definition');
    const closePopupBtn = document.getElementById('close-popup-btn');
    const statusIndicator = document.getElementById('status-indicator');

    // --- State Variables ---
    let keywordDefinitions = {};
    let pageKeywords = {};
    let currentViewports = {};

    // --- PDF.js Setup (Using v2.5.207) ---
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    const pdfjsViewer = window['pdfjs-dist/web/pdf_viewer'];
    pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.5.207/pdf.worker.min.js';

    const book={title:"No Document",totalPages:0,currentPage:1,isDoublePageView:true,pdfDocument:null,outline:[]};
    const user={readingProgress:{furthestPage:1}};

    let toolbarTimer=null;
    let toolbarHover=!1;
    const pageCache=new Map();
    const MAX_CACHE_SIZE=20;
    let PAGE_PADDING=15;
    let resizeTimer;
    let sliderHideTimeout=null;

    const linkService = new pdfjsViewer.SimpleLinkService();
    const eventBus = new pdfjsViewer.EventBus();

    const updateStatus=m=>console.log(`[Viewer Status] ${m}`);
    // const updateStatus = () => {}; // Production

    // --- Toolbar Logic (Unchanged) ---
    function manageToolbar(s=null){/* ... */} function setupToolbarHover(){/* ... */}

    // --- Caching & Page Loading (Unchanged) ---
    function trimCache(){/* ... */} function showPageLoading(canvasId){/* ... */} function hidePageLoading(canvasId){/* ... */}

    // --- Custom Keyword Overlay Creation (Unchanged from previous step) ---
    async function createKeywordOverlays(pageNum, pageElement, viewport) {
        const overlayContainerId = pageElement.classList.contains('left') ? 'left-keyword-overlay' : 'right-keyword-overlay';
        const overlayContainer = document.getElementById(overlayContainerId);
        const canvasContainer = pageElement.querySelector('.canvas-container');

        if (!book.pdfDocument || !overlayContainer || !canvasContainer) { console.warn(`Skipping keyword overlay for page ${pageNum}: Missing elements.`); return; }
        overlayContainer.innerHTML = '';

        const keywordsForPage = pageKeywords[pageNum.toString()] || [];
        if (keywordsForPage.length === 0) return;

        const lowerCaseKeywords = keywordsForPage.map(k => k.toLowerCase());
        const lowerCaseDefs = {};
        for (const key in keywordDefinitions) { lowerCaseDefs[key.toLowerCase()] = keywordDefinitions[key]; }

        try {
            const page = await book.pdfDocument.getPage(pageNum);
            const textContent = await page.getTextContent({ normalizeWhitespace: true });

            textContent.items.forEach(item => {
                const itemText = item.str;
                if (!itemText || itemText.trim().length === 0) return;

                keywordsForPage.forEach((originalKeyword, index) => {
                    const keywordLower = lowerCaseKeywords[index];
                    const definition = lowerCaseDefs[keywordLower];
                    if (!definition) return;

                    const escapedKeyword = originalKeyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                    const regex = new RegExp(`\\b(${escapedKeyword})\\b`, 'gi');
                    let match;

                    while ((match = regex.exec(itemText)) !== null) {
                        const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                        const itemWidth = item.width; const itemHeight = item.height;
                        let left = tx[4]; let top = tx[5] - itemHeight;
                        if (left < 0) left = 0; if (top < 0) top = 0;

                        const highlightDiv = document.createElement('div');
                        highlightDiv.className = 'keyword-highlight';
                        highlightDiv.style.left = `${left}px`; highlightDiv.style.top = `${top}px`;
                        highlightDiv.style.width = `${itemWidth}px`; highlightDiv.style.height = `${itemHeight}px`;
                        highlightDiv.dataset.keyword = originalKeyword; highlightDiv.dataset.definition = definition;
                        highlightDiv.title = `Definition: ${originalKeyword}`;

                        highlightDiv.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const rect = highlightDiv.getBoundingClientRect();
                            showDefinitionPopup(originalKeyword, definition, rect.left, rect.bottom, rect.top);
                        });

                        overlayContainer.appendChild(highlightDiv);
                        return;
                    }
                });
            });
        } catch (error) {
            console.error(`Error processing text content for keyword overlays on page ${pageNum}:`, error);
            overlayContainer.innerHTML = '';
        }
    }

    // --- Simplified Base Text Layer Rendering (Unchanged) ---
    async function renderAndEnhanceTextLayer(page, container, viewport) {
      if (!page || !container || !viewport) return;
      container.innerHTML = ''; container.style.pointerEvents = 'none'; container.style.color = 'transparent';
      try {
        const textContent = await page.getTextContent({normalizeWhitespace: true});
        const renderTask = pdfjsLib.renderTextLayer({ textContent: textContent, container: container, viewport: viewport });
        await renderTask.promise;
      } catch (error) { console.error(`Error rendering base text layer for page ${page.pageNumber}:`, error); container.innerHTML = ''; }
    }

    // --- Annotation Layer Rendering (Unchanged) ---
    async function renderAnnotationLayer(page, container, viewport) {
        if (!page || !container || !viewport) { console.warn("Skipping annotation layer: params missing."); return }
        container.innerHTML = '';
        try {
            const annotations = await page.getAnnotations(); if (annotations.length === 0) return;
            pdfjsLib.AnnotationLayer.render({ viewport: viewport.clone({ dontFlip: true }), div: container, annotations: annotations, page: page, linkService: linkService });
        } catch (error) { console.error(`Error rendering annotation layer for page ${page.pageNumber}:`, error); container.innerHTML = ''; }
    }

    // --- renderPage function (Unchanged) ---
    async function renderPage(pageNum, canvasId) {
        const canvas = document.getElementById(canvasId); const ctx = canvas?.getContext('2d');
        const canvasContainer = canvas?.closest('.canvas-container');
        const textLayerContainer = canvasContainer?.querySelector('.textLayer');
        const annotationLayerContainer = canvasContainer?.querySelector('.annotationLayer');
        const keywordOverlayContainer = canvasContainer?.querySelector('.keyword-overlay-container');
        const pageElement = canvas?.closest('.book-page');

        delete currentViewports[canvasId];
        if (textLayerContainer) textLayerContainer.innerHTML = '';
        if (annotationLayerContainer) annotationLayerContainer.innerHTML = '';
        if (keywordOverlayContainer) keywordOverlayContainer.innerHTML = '';

        if (!book.pdfDocument || !canvas || !ctx || !canvasContainer || !textLayerContainer || !annotationLayerContainer || !keywordOverlayContainer || !pageElement || pageNum < 1 || pageNum > book.totalPages) {
            if (canvas && ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (pageElement) pageElement.classList.add('placeholder-page');
            hidePageLoading(canvasId); return;
        }

        showPageLoading(canvasId); pageElement.classList.remove('placeholder-page');
        let page; let viewport;

        try {
            if (pageCache.has(pageNum)) { /* ... load from cache ... */
                const cachedData = pageCache.get(pageNum); canvas.width = cachedData.width; canvas.height = cachedData.height; canvas.style.width = `${cachedData.styleWidth}px`; canvas.style.height = `${cachedData.styleHeight}px`; ctx.putImageData(cachedData.imageData, 0, 0); page = await book.pdfDocument.getPage(pageNum); viewport = cachedData.viewport; currentViewports[canvasId] = viewport; pageCache.delete(pageNum); pageCache.set(pageNum, cachedData); hidePageLoading(canvasId);
            } else { /* ... render new ... */
                page = await book.pdfDocument.getPage(pageNum); const containerStyle = getComputedStyle(canvasContainer); const availableWidth = parseFloat(containerStyle.width); const availableHeight = parseFloat(containerStyle.height); if (availableWidth <= 0 || availableHeight <= 0) { console.warn(`Canvas container ${canvasId} zero dimensions.`); hidePageLoading(canvasId); return; } const defaultViewport = page.getViewport({ scale: 1 }); const scale = Math.min(availableWidth / defaultViewport.width, availableHeight / defaultViewport.height); viewport = page.getViewport({ scale: scale }); currentViewports[canvasId] = viewport; const outputScale = window.devicePixelRatio || 1; canvas.width = Math.floor(viewport.width * outputScale); canvas.height = Math.floor(viewport.height * outputScale); canvas.style.width = `${Math.floor(viewport.width)}px`; canvas.style.height = `${Math.floor(viewport.height)}px`; const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null; await page.render({ canvasContext: ctx, transform: transform, viewport: viewport }).promise; const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height); pageCache.set(pageNum, { imageData, width: canvas.width, height: canvas.height, styleWidth: Math.floor(viewport.width), styleHeight: Math.floor(viewport.height), viewport }); trimCache(); hidePageLoading(canvasId);
            }
            await renderAndEnhanceTextLayer(page, textLayerContainer, viewport);
            await renderAnnotationLayer(page, annotationLayerContainer, viewport);
            await createKeywordOverlays(pageNum, pageElement, viewport);
        } catch (error) { console.error(`Error rendering page ${pageNum} on ${canvasId}:`, error); if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height); hidePageLoading(canvasId); pageElement?.classList.add('placeholder-page'); }
    }

    // --- Update Display (Unchanged) ---
    async function updateDisplay() { /* ... */ }

    // --- Preloading (Unchanged) ---
     function preloadAdjacentPages(currentPage) { /* ... */ }

    // --- Navigation (Unchanged) ---
    function nextPage(){ /* ... */ } function prevPage(){ /* ... */ } function jumpToPage(pageNum){ /* ... */ }

    // --- View Modes (Unchanged) ---
    function applyCurrentViewModeStyles() { /* ... */ } function setSinglePageView(){ /* ... */ } function setDoublePageView(){ /* ... */ } function setRotatedView() { /* ... */ }

    // --- UI Toggles (Unchanged) ---
    function toggleElement(id,show){/* ... */} function showTableOfContents(){/* ... */} function hideTableOfContents(){/* ... */} function showLoading(msg='Processing...'){/* ... */} function hideLoading(){/* ... */}

    // --- Slider Logic (Unchanged) ---
    function showPageSlider(){/* ... */} function hidePageSlider(){/* ... */} function resetSliderHideTimer(){/* ... */} function initPageSlider(){/* ... */} function updateSliderTotalPages(){/* ... */} function updateSliderPosition(){/* ... */} function updateSliderStyle(s,v){/* ... */}

    // --- Overlay Data Loading (Unchanged) ---
    async function loadOverlayData(pdfUrl) { /* ... */ }

    // --- PDF Loading (Unchanged) ---
    async function loadPdf(pdfUrl) { /* ... */ }

    // --- TOC population (Unchanged) ---
    function populateTOC() { /* ... */ }

    // --- Popup Handling Functions (Updated Positioning Logic) ---
    function showDefinitionPopup(word, definition, clickLeft, clickBottom, clickTop) {
        if (!definitionPopup || !popupWord || !popupDefinition || !closePopupBtn) return;
        popupWord.textContent = word; popupDefinition.innerHTML = definition || `<span class="error-message">Definition not available.</span>`; popupDefinition.scrollTop = 0;
        const popupRect = definitionPopup.getBoundingClientRect(); const vpW = window.innerWidth; const vpH = window.innerHeight; const margin = 10;
        const estWidth = Math.min(popupRect.width || 320, 320); const estHeight = Math.min(popupRect.height || 250, 250);
        const clickCenterX = clickLeft + (estWidth / 2); // Approx center of clicked element
        let posX = clickCenterX - (estWidth / 2); let posY = clickTop - estHeight - 10; let transformOrigin = 'bottom center';
        if (posX < margin) { posX = margin; } else if (posX + estWidth > vpW - margin) { posX = vpW - estWidth - margin; }
        if (posY < margin) { posY = clickBottom + 10; transformOrigin = 'top center'; }
        if (posY + estHeight > vpH - margin) { posY = vpH - estHeight - margin; }
        if (posY < margin) { posY = margin; }
        definitionPopup.style.left = `${posX}px`; definitionPopup.style.top = `${posY}px`; definitionPopup.style.transformOrigin = transformOrigin;
        definitionPopup.classList.add('visible');
    }
    function hideDefinitionPopup() { if (definitionPopup) { definitionPopup.classList.remove('visible'); } }

    // --- Event Setup (Unchanged) ---
    function setupEvents() {
        updateStatus("Setting up events");
        const toolbar = document.getElementById('new-toolbar'); const mainContainer = document.querySelector('.main-container'); const bookSpread = mainContainer?.querySelector('.book-spread');
        toolbar?.addEventListener('click', e => { const btn = e.target.closest('.new-btn'); if (!btn || btn.disabled) return; const id = btn.id; switch (id) { case 'single-page-btn': setSinglePageView(); break; case 'double-page-btn': setDoublePageView(); break; case 'rotate-btn': setRotatedView(); break; case 'toc-btn': showTableOfContents(); break; } resetSliderHideTimer(); toolbarHover = false; manageToolbar(false); });
        document.getElementById('close-toc-btn')?.addEventListener('click', hideTableOfContents);
        closePopupBtn?.addEventListener('click', hideDefinitionPopup);
        bookSpread?.addEventListener('click', e => { if (e.target.classList.contains('page-edge-nav')) { const pageDiv = e.target.closest('.book-page'); if (!pageDiv || pageDiv.classList.contains('placeholder-page')) return; if (e.target.classList.contains('page-edge-left')) { prevPage(); } else { nextPage(); } showPageSlider(); manageToolbar(false); } });
        document.addEventListener('keydown', e => { if (document.getElementById('toc-panel')?.classList.contains('visible') || (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return; if (e.key === 'Escape' && definitionPopup.classList.contains('visible')) { hideDefinitionPopup(); e.preventDefault(); return; } if (definitionPopup.classList.contains('visible') || e.ctrlKey || e.altKey || e.metaKey) return; let navAction = false; switch(e.key){ case 'ArrowRight': case 'PageDown': nextPage(); navAction = true; break; case 'ArrowLeft': case 'PageUp': prevPage(); navAction = true; break; case 'Home': if(book.totalPages > 0) jumpToPage(1); navAction = true; break; case 'End': if(book.totalPages > 0) jumpToPage(book.totalPages); navAction = true; break; } if(navAction){ e.preventDefault(); showPageSlider(); manageToolbar(false); } });
        window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(()=>{ updateStatus("Resize detected."); hideDefinitionPopup(); if(document.body.classList.contains('rotated-mode') || document.body.classList.contains('fullscreen-mode')) { applyCurrentViewModeStyles(); updateDisplay(); } else { applyCurrentViewModeStyles(); updateDisplay(); } manageToolbar(); }, 250); });
        let tX=0,tY=0,tS=0; const SW=50,ST=500,SV=70; document.body.addEventListener('touchstart',e=>{if(e.target.closest('#new-toolbar,.toolbar-trigger-area,#page-slider-container,#page-slider-trigger-zone,.toc-panel,.page-edge-nav,.new-btn,button,input,a,#definition-popup,.keyword-highlight,.annotationLayer section')){tX=0;tY=0;return}if(e.touches.length===1){tX=e.touches[0].screenX;tY=e.touches[0].screenY;tS=Date.now()}else{tX=0;tY=0}},{passive:true}); document.body.addEventListener('touchend',e=>{if(tX===0&&tY===0)return;if(e.changedTouches.length===1){const eX=e.changedTouches[0].screenX,eY=e.changedTouches[0].screenY,tE=Date.now()-tS;if(tE<ST){const dX=eX-tX,dY=eY-tY,aX=Math.abs(dX),aY=Math.abs(dY);if(aX>SW&&aY<SV){if(dX>0){prevPage()}else{nextPage()}showPageSlider();manageToolbar(false)}}}tX=0;tY=0;tS=0});
        const stz=document.getElementById('page-slider-trigger-zone'),slc=document.getElementById('page-slider-container');if(stz&&slc){const et=()=>{if(book.pdfDocument&&book.totalPages>0){showPageSlider();clearTimeout(sliderHideTimeout)}};const lts=e=>{const rt=e.relatedTarget;if(!slc.contains(rt)&&!stz.contains(rt)){resetSliderHideTimer()}};stz.addEventListener('mouseenter',et);slc.addEventListener('mouseenter',et);stz.addEventListener('mouseleave',lts);slc.addEventListener('mouseleave',lts)}
        document.addEventListener('click', e => { if (definitionPopup.classList.contains('visible') && !definitionPopup.contains(e.target) && !e.target.closest('.keyword-highlight')) { hideDefinitionPopup(); } }, true);
        updateStatus("Events setup complete");
    }

    // --- Initialization (Unchanged) ---
    async function init() {
        updateStatus("Initializing application...");
        try {
            try { PAGE_PADDING = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-padding')) || 15; } catch(e){ PAGE_PADDING=15; console.warn("CSS var --page-padding read failed.") }
            setupEvents(); setupToolbarHover(); initPageSlider(); hideLoading();
            const urlParams = new URLSearchParams(window.location.search); const pdfUrlParam = urlParams.get('pdf');
            if (pdfUrlParam) { updateStatus(`PDF URL parameter found: ${pdfUrlParam}`); await loadPdf(pdfUrlParam); }
            else {
                updateStatus("No PDF specified in URL parameter (?pdf=...)."); const sc = document.querySelector('.main-container .book-spread'); if(sc) sc.innerHTML = `<div style="color: var(--text-on-dark); background: rgba(28,37,54,.8); border-radius: 8px; padding: 40px; text-align: center; max-width: 500px; margin: auto;"><h2>Interactive Reader</h2><p style="margin-top: 15px;">Add <code>?pdf=URL_TO_PDF</code> to the address bar.</p></div>`; document.querySelector('.book-page.left')?.style.setProperty('visibility','hidden'); document.querySelector('.book-page.right')?.style.setProperty('display','none'); document.getElementById('page-slider-container')?.classList.remove('visible'); document.getElementById('new-toolbar')?.classList.remove('visible');
            }
            window.addEventListener('beforeunload', () => { updateStatus("Unloading - Cleanup."); pageCache.clear(); if (book.pdfDocument) { try { book.pdfDocument.destroy(); } catch(e){} book.pdfDocument = null; } });
            updateStatus("Initialization complete.");
        } catch (initError) { console.error("Initialization failed:", initError); document.body.innerHTML = `<div style="color: red; background: white; padding: 20px; border: 2px solid red; font-family: monospace;"><pre>App Init Error:\n${initError.stack || initError}</pre></div>`; }
    }

    // --- Start the application ---
    document.addEventListener('DOMContentLoaded', init);

</script>
</body>
</html>
