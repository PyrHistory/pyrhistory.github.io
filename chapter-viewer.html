<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heritage History™ - Digital Book Reader</title>
    {/* Core PDFJS library */}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    {/* Full PDF Viewer library (includes TextLayer, AnnotationLayer builders, PDFPageView) */}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.js"></script>
    {/* CSS for PDF Viewer components */}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.css">
    <style>
:root{--primary:#4a90e2;--secondary:#50e3c2;--accent:#f5a623;--lab-blue:#080e1c;--page:#fff;--text-on-dark:rgba(255,255,255,.9);--text-on-page:#333;--header-h:60px;--page-w:650px;--page-h:842px;--page-padding:15px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Georgia',serif;background-color:var(--lab-blue);color:var(--text-on-dark);height:100vh;width:100vw;overflow:hidden;display:flex;flex-direction:column;position:fixed;line-height:1.6}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background-image:radial-gradient(circle at 15% 15%,rgba(249,115,22,.12) 0,transparent 45%),radial-gradient(circle at 85% 85%,rgba(197,83,235,.12) 0,transparent 45%),radial-gradient(circle at 85% 15%,rgba(56,189,248,.05) 0,transparent 40%),radial-gradient(circle at 15% 85%,rgba(251,191,36,.08) 0,transparent 40%);animation:ambient-shift 30s ease infinite alternate}
@keyframes ambient-shift{0%{background-position:0 0,0 0,0 0,0 0}100%{background-position:5% 10%,-5% -5%,10% -5%,-10% 5%}}
@media (prefers-reduced-motion:reduce){body::before{animation:none!important}}
#new-toolbar{position:fixed!important;top:15px!important;right:-60px!important;z-index:9999!important;display:flex!important;flex-direction:column!important;gap:10px!important;transition:right .3s ease,bottom .3s ease,transform .3s ease!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);padding:5px!important;border-radius:8px 0 0 8px!important;box-shadow:-2px 2px 10px rgba(0,0,0,.4)!important;width:58px;border:1px solid rgba(255,255,255,.1)}
#new-toolbar::before{content:"≡";position:absolute;left:-25px;top:50%;transform:translateY(-50%);background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);width:25px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;color:var(--text-on-dark);font-size:20px;box-shadow:-2px 2px 5px rgba(0,0,0,.3);transition:all .3s ease;border:1px solid rgba(255,255,255,.1);border-right:none;cursor:pointer}
.toolbar-trigger-area{position:fixed;top:0;right:0;width:30px;height:100%;z-index:9998;transition:all .3s ease}
#new-toolbar.visible{right:0!important;transform:none!important}
.new-btn{background:rgba(44,62,80,.8)!important;border:1px solid rgba(255,255,255,.15)!important;color:var(--text-on-dark)!important;width:48px!important;height:48px!important;border-radius:4px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:25px!important;cursor:pointer!important;transition:all .2s!important;box-shadow:0 2px 5px rgba(0,0,0,.2)!important;user-select:none!important;flex-shrink:0}
.new-btn:hover{background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;transform:translateY(-2px)!important}
.new-btn:active{transform:translateY(1px)!important}
.new-btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
.rotated-mode #new-toolbar{top:auto!important;right:50%!important;bottom:-60px!important;transform:translateX(50%)!important;flex-direction:row!important;width:auto!important;height:58px!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:8px 8px 0 0!important;padding:5px 10px!important;box-shadow:0 -2px 10px rgba(0,0,0,.4)!important;border:1px solid rgba(255,255,255,.1);border-bottom:none}
.rotated-mode #new-toolbar.visible{bottom:0!important;transform:translateX(50%)!important}
.rotated-mode #new-toolbar::before{left:50%!important;transform:translateX(-50%)!important;top:-25px!important;width:40px!important;height:25px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:4px 4px 0 0!important;content:"≡";padding-bottom:5px;color:var(--text-on-dark);border:1px solid rgba(255,255,255,.1);border-bottom:none;cursor:pointer}
.rotated-mode .toolbar-trigger-area{top:auto!important;bottom:0!important;left:0!important;transform:none!important;right:auto!important;width:100%!important;height:30px!important}
.rotated-mode #new-toolbar .new-btn{width:40px!important;height:40px!important;font-size:20px!important;transform: rotate(90deg)}
.rotated-mode .new-btn:hover {transform: rotate(90deg) scale(1.1);background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}
.rotated-mode .new-btn:active {transform: rotate(90deg) scale(0.95)}
.main-container{flex:1;display:flex;justify-content:center!important;align-items:center!important;padding:0;height:100%;width:100%;overflow:hidden;position:relative;background:transparent}
.book-spread{display:flex;box-shadow:0 10px 35px rgba(0,0,0,.5);position:fixed!important;top:50%!important;left:50%!important;transform-origin:center center;width:auto!important;height:auto!important;transition:transform .3s ease; transform: translate(-50%, -50%)}
.book-page{width:var(--page-w);height:var(--page-h);background-color:transparent;position:relative;overflow:hidden; flex-shrink:0;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08);padding:0;}
.book-page.left{border-right:1px solid rgba(255,255,255,.15);border-radius:3px 0 0 3px}
.book-page.right{border-left:1px solid rgba(255,255,255,.15);border-radius:0 3px 3px 0}
.fullscreen-mode:not(.rotated-mode) .book-page.left{border-right:1px solid rgba(255,255,255,.08)!important}

/* --- Styles for PDFPageView container --- */
.page-view-container {
    width: calc(100% - 2 * var(--page-padding));
    height: calc(100% - 2 * var(--page-padding));
    margin: var(--page-padding);
    position: relative; /* Needed for PDFPageView layers */
    background-color: var(--page); /* Background is now on this container */
    overflow: hidden; /* Clip layers */
    border-radius: 2px; /* Optional: slight rounding */
}
/* PDFPageView adds a 'page' class to its main div */
.page {
    position: absolute !important; /* PDFPageView manages positioning */
    top: 0; left: 0; width: 100%; height: 100%;
}
.canvasWrapper { /* Added by PDFPageView */
    overflow: hidden;
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    z-index: 1;
}
.pdf-canvas{ /* Canvas itself, still absolute */
    display: block;
    position: absolute; top: 0; left: 0;
    /* width/height set by PDFPageView */
}
.textLayer { /* Relative to .page div */
    position: absolute; left: 0; top: 0; right: 0; bottom: 0;
    color: transparent; overflow: hidden; line-height: 1.0;
    user-select: none; -webkit-user-select: none;
    pointer-events: none; /* Layer doesn't capture */
    z-index: 2; /* Above canvas, below annotation */
    opacity: 1; /* Make visible for interactions */
}
.annotationLayer { /* Relative to .page div */
    position: absolute; left: 0; top: 0; right: 0; bottom: 0;
    overflow: hidden; pointer-events: none; /* Layer doesn't capture */
    z-index: 3; /* Above text layer */
}
/* --- End PDFPageView styles --- */

.page-number{display:none}
.page-loading-overlay{position:absolute;inset:var(--page-padding);background:rgba(255,255,255,.6);z-index:50;display:none;justify-content:center;align-items:center;border-radius:3px}
.page-loading-spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(0,0,0,.1);border-top-color:var(--primary);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-edge-nav{position:absolute;top:0;height:100%;width:50px;cursor:pointer;z-index:10;transition:background-color .2s;-webkit-tap-highlight-color:transparent}
.page-edge-nav:hover{background-color:rgba(0,0,0,.03)}
.page-edge-left{left:0;border-radius:3px 0 0 3px}
.page-edge-right{right:0;border-radius:0 3px 3px 0}
.page-edge-left:hover::after,.page-edge-right:hover::after{content:"";position:absolute;top:50%;width:12px;height:12px;border-style:solid;border-color:rgba(0,0,0,.6);border-width:2px 2px 0 0;opacity:.8}
.page-edge-left:hover::after{left:18px;transform:translateY(-50%) rotate(-135deg)}
.page-edge-right:hover::after{right:18px;transform:translateY(-50%) rotate(45deg)}
.fullscreen-mode .book-page.right{display:none!important}
.fullscreen-mode .book-page.left{max-width:95vw;max-height:95vh;width:auto;height:auto;border-radius:5px!important;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08)!important;padding:0;}
.fullscreen-mode .page-view-container { margin: var(--page-padding); }
.rotated-mode .book-page.left{width:var(--page-w)!important;height:var(--page-h)!important;border-radius:0!important;border:none!important;padding:0 !important;background-color:transparent;display:flex;justify-content:center;align-items:center}
.rotated-mode .page-view-container { margin: 10px !important; width: calc(100% - 20px); height: calc(100% - 20px); }
.rotated-mode .book-page.right{display:none!important}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page{width:var(--page-w);height:var(--page-h)}
.book-page.right.placeholder-page{background-color:var(--page)!important;border-left:1px solid rgba(0,0,0,.1);position:relative;display:flex!important;justify-content:center;align-items:center}
.book-page.right.placeholder-page::after{content:"End of document";font-size:14px;font-style:italic;color:rgba(0,0,0,.5)}
.book-page.right.placeholder-page .page-view-container,.book-page.right.placeholder-page .page-edge-nav,.book-page.right.placeholder-page .page-loading-overlay{display:none}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left,
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) { position: relative; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left { border-right: none !important; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) { border-left: none !important; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left .page-view-container::after { content: ''; position: absolute; top: 0; right: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to left, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 0 2px 2px 0; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) .page-view-container::before { content: ''; position: absolute; top: 0; left: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to right, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 2px 0 0 2px; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right.placeholder-page { border-left: 1px solid rgba(0,0,0,.1) !important; }
.toc-panel{position:fixed;z-index:10000;display:none;color:var(--text-on-page); left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;height:80vh;background:#f0f4f8;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,.5);flex-direction:column;overflow:hidden}
.toc-panel.visible,.loading-overlay.visible{display:flex!important}
.toc-header{padding:15px 20px;background:var(--primary);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.toc-header .notes-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0 5px;line-height:1}
.toc-content{flex:1;padding:10px 20px;overflow-y:auto}
.toc-chapter{padding:8px 0;border-bottom:1px solid #d8dfe6}
.toc-chapter-title{font-weight:700;color:var(--primary);cursor:pointer;padding:5px 0}
.toc-chapter-title:hover,.toc-section:hover{color:var(--accent)}
.toc-sections{padding-left:20px;margin-top:5px}
.toc-section{padding:4px 0;cursor:pointer;color:#4a5568;font-size:.95em}
.loading-overlay{position:fixed;inset:0;background:rgba(8,14,28,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:10001;display:none;justify-content:center;align-items:center;flex-direction:column}
.loading-spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:15px}
.loading-message{font-size:16px;color:var(--text-on-dark)}
#status-indicator{display:none}
.page-slider-container{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:700px;padding:14px 20px;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-bottom:none;box-shadow:0 -4px 20px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;z-index:9998;transition:bottom .35s cubic-bezier(.2,.9,.3,1),transform .35s cubic-bezier(.2,.9,.3,1), left .35s cubic-bezier(.2,.9,.3,1);border-radius:16px 16px 0 0}
.page-slider-container.visible{bottom:0}
.page-slider-track{width:100%;margin-bottom:8px;padding:0 10px}
.page-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);outline:none;border-radius:3px;overflow:visible;cursor:pointer;transition:height .2s}
.page-slider:hover{height:8px}
.page-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition:all .2s ease;margin-top:-7px}
.page-slider::-webkit-slider-thumb:hover{width:24px;height:24px;margin-top:-8px}
.page-slider::-webkit-slider-runnable-track{height:100%;background:linear-gradient(to right,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%));border-radius:3px}
.page-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4)}
.page-slider::-moz-range-thumb:hover{width:24px;height:24px}
.page-slider::-moz-range-progress{background-color:var(--accent);height:100%;border-radius:3px}
.page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);height:100%;border-radius:3px}
.page-slider-info{font-size:12px;color:var(--text-on-dark);font-weight:500;letter-spacing:.3px;opacity:.8}
.rotated-mode .page-slider-container{bottom:50%!important;left:-80px!important;top:auto!important;transform:translateY(50%)!important;width:60px!important;height:70vh!important;max-width:none!important;max-height:500px;flex-direction:column-reverse!important;padding:10px 5px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 12px 12px 0!important;box-shadow:2px 0 20px rgba(0,0,0,.4)!important}
.rotated-mode .page-slider-container.visible{left:0!important}
.rotated-mode .page-slider-track{width:100%!important;height:100%!important;margin-bottom:0!important;padding:10px 0!important;display:flex;align-items:center;flex:1}
.rotated-mode .page-slider{width:6px!important;height:100%!important;writing-mode:vertical-lr!important;-webkit-appearance:slider-vertical!important;appearance:slider-vertical;margin:0 auto!important;padding:0!important;background:rgba(255,255,255,.1)!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-runnable-track{width:6px!important;height:100%;background:linear-gradient(to top,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%))!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width:20px!important;height:20px!important;border-radius: 50%;background: var(--accent);cursor: pointer;border: 3px solid rgba(28,37,54,.9)!important;box-shadow: 0 1px 6px rgba(0,0,0,.4);transition: all .2s ease;margin-top:0!important;margin-left:-7px!important}
.rotated-mode .page-slider:hover::-webkit-slider-thumb {width: 24px !important;height: 24px !important;margin-left: -9px !important}
.rotated-mode .page-slider::-moz-range-thumb{width: 20px;height: 20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition: all .2s ease}
.rotated-mode .page-slider:hover::-moz-range-thumb {width: 24px;height: 24px}
.rotated-mode .page-slider::-moz-range-progress{background-color:var(--accent)!important;width:6px!important;border-radius:3px}
.rotated-mode .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);width:6px!important;border-radius:3px}
.rotated-mode .page-slider-info{transform:rotate(90deg);white-space:nowrap;margin-bottom:15px;padding-top:10px;color:var(--text-on-dark)}
#page-slider-trigger-zone {position: fixed;bottom: 0;left: 0;width: 100%;height: 30px;z-index: 9997;pointer-events: auto}
.rotated-mode #page-slider-trigger-zone {bottom: auto;top: 50%;left: 0;width: 60px;height: 50%}

/* --- START: Text Layer & Keyword Styles --- */
/* .textLayer styles are now within .page-view-container context */
.textLayer > span {
    position: absolute;
    white-space: pre;
    cursor: text;
    transform-origin: 0% 0%;
    pointer-events: none; /* Individual spans off by default */
    border-radius: 2px;
}
.textLayer .keyword-interactive {
    pointer-events: auto; /* Keywords ARE interactive */
    cursor: pointer;
    transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.textLayer .keyword-hover-highlight {
    background: linear-gradient(to right, rgba(255, 100, 0, 0.4), rgba(255, 191, 36, 0.4));
    box-shadow: 0 0 3px rgba(255, 165, 0, 0.5);
}
/* --- END: Text Layer & Keyword Styles --- */

/* --- START: Annotation Layer Styles (for Links) --- */
/* .annotationLayer styles are now within .page-view-container context */
.annotationLayer section { /* Styles from pdf_viewer.css */
    position: absolute;
    pointer-events: auto; /* Annotations ARE interactive */
}
.annotationLayer .linkAnnotation > a { /* Styles from pdf_viewer.css, slightly adapted */
    position: absolute;
    font-size: 1em;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 1px solid transparent;
    transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out;
}
.annotationLayer .linkAnnotation > a:hover {
    cursor: pointer;
    background-color: rgba(255, 255, 0, 0.2); /* Standard yellow highlight */
    border: 1px solid rgba(255, 255, 0, 0.5);
    box-shadow: 0px 0px 2px rgba(255, 255, 0, 0.5);
}
/* --- END: Annotation Layer Styles --- */

/* --- START: Dictionary Pop-up Styles --- */
#definition-popup { display: none; position: fixed; z-index: 10002; background: white; border: 1px solid #ccc; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); padding: 10px 15px; max-width: 300px; min-width: 150px; font-family: sans-serif; font-size: 14px; color: #333; line-height: 1.4; transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; transform: scale(0.95); opacity: 0; pointer-events: none; }
#definition-popup.visible { display: block; transform: scale(1); opacity: 1; pointer-events: auto; }
#close-popup-btn { position: absolute; top: 3px; right: 3px; background: none; border: none; font-size: 18px; cursor: pointer; color: #888; padding: 0 5px; line-height: 1; }
#close-popup-btn:hover { color: #333; }
#popup-word { display: block; margin-bottom: 5px; color: var(--primary); font-weight: bold; }
#popup-definition { max-height: 150px; overflow-y: auto; }
#popup-definition i { color: #777; }
#popup-definition span.error-message { color: #e74c3c; }
/* --- END: Dictionary Pop-up Styles --- */
    </style>
</head>
<body>
    <div id="new-toolbar"></div>
    <div class="toolbar-trigger-area" id="toolbar-trigger-area"></div>
    <div id="status-indicator">Status: Initializing...</div>
    <div class="main-container">
        <div class="book-spread">
            <div class="book-page left">
                <!-- Container for PDFPageView -->
                <div class="page-view-container" id="left-page-view-container"></div>
                <!-- End Container -->
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="left-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
            <div class="book-page right placeholder-page">
                 <!-- Container for PDFPageView -->
                 <div class="page-view-container" id="right-page-view-container"></div>
                 <!-- End Container -->
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="right-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
        </div>
    </div>
    <div class="toc-panel" id="toc-panel"></div>
    <div class="loading-overlay" id="loading-overlay"></div>
    <div class="page-slider-container" id="page-slider-container"></div>
    <div id="page-slider-trigger-zone"></div>

    <div id="definition-popup">
        <button id="close-popup-btn">×</button>
        <strong id="popup-word">Word</strong>
        <div id="popup-definition">Definition</div>
    </div>

    <script>
        // Populate Inner HTML directly (Toolbar, TOC, Loading, Slider)
        document.getElementById('new-toolbar').innerHTML = `<button class="new-btn" id="single-page-btn" title="Single Page View">☰</button><button class="new-btn" id="double-page-btn" title="Double Page View">◫</button><button class="new-btn" id="rotate-btn" title="Rotate View">📱</button><button class="new-btn" id="toc-btn" title="Table of Contents" disabled>📑</button>`;
        document.getElementById('toc-panel').innerHTML = `<div class="toc-header"><span>Table of Contents</span><button class="notes-close" id="close-toc-btn">×</button></div><div class="toc-content"><div id="toc-list">Loading...</div></div>`;
        document.getElementById('loading-overlay').innerHTML = `<div class="loading-spinner"></div><div class="loading-message">Processing...</div>`;
        document.getElementById('page-slider-container').innerHTML = `<div class="page-slider-track"><input type="range" id="page-slider" class="page-slider" min="1" max="1" value="1" style="--slider-percent: 0%"></div><div class="page-slider-info"><span id="current-page-display">Page 1</span> of <span id="total-pages-display">1</span></div>`;
    </script>
    <script>
        // --- UI Elements ---
        const definitionPopup = document.getElementById('definition-popup');
        const popupWord = document.getElementById('popup-word');
        const popupDefinition = document.getElementById('popup-definition');
        const closePopupBtn = document.getElementById('close-popup-btn');

        // --- State Variables ---
        let currentViewports = {};
        let keywordDefinitions = {};
        let pageKeywords = {};
        let pageViews = {};

        // Use the pdfjsViewer library namespace
        const pdfjsLib = window['pdfjs-dist/build/pdf'];
        const pdfjsViewer = window['pdfjs-dist/web/pdf_viewer'];

        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        const book={title:"No Document",totalPages:0,currentPage:1,isDoublePageView:true,pdfDocument:null,outline:[]};
        const user={readingProgress:{furthestPage:1}};
        let toolbarTimer=null;
        let toolbarHover=!1;
        let PAGE_PADDING=15;
        let resizeTimer;
        let sliderHideTimeout=null;
        const updateStatus=m=>console.log("Status:",m);

        // --- Basic Link Service and Event Bus ---
        const linkService = new pdfjsViewer.SimpleLinkService();
        const eventBus = new pdfjsViewer.EventBus();

        // --- Layer Factories (REMOVED) ---
        // Removed: const textLayerFactory = new pdfjsViewer.DefaultTextLayerFactory();
        // Removed: const annotationLayerFactory = new pdfjsViewer.DefaultAnnotationLayerFactory();


        // --- Toolbar Logic (unchanged) ---
        function manageToolbar(s=null){/*...*/}
        function setupToolbarHover(){/*...*/}

        // --- Caching & Page Loading (Simplified) ---
        function showPageLoading(containerId){document.getElementById(containerId)?.closest('.book-page')?.querySelector('.page-loading-overlay')?.style.setProperty('display','flex')}
        function hidePageLoading(containerId){document.getElementById(containerId)?.closest('.book-page')?.querySelector('.page-loading-overlay')?.style.setProperty('display','none')}

        // --- NEW: Render Page using PDFPageView ---
        async function renderPage(pageNum, containerId) {
            const pageViewContainer = document.getElementById(containerId);
            const pageElement = pageViewContainer?.closest('.book-page');

            if (pageViews[pageNum]) {
                 updateStatus(`Destroying existing PDFPageView for page ${pageNum}`);
                pageViews[pageNum].destroy();
                delete pageViews[pageNum];
            }
            if (pageViewContainer) pageViewContainer.innerHTML = '';

            if (!book.pdfDocument || !pageViewContainer || !pageElement || pageNum < 1 || pageNum > book.totalPages) {
                if (pageViewContainer) pageViewContainer.innerHTML = '';
                 hidePageLoading(containerId);
                return;
            }
            showPageLoading(containerId);
            pageElement.classList.remove('placeholder-page');

            try {
                const page = await book.pdfDocument.getPage(pageNum);
                 const containerStyle = getComputedStyle(pageViewContainer);
                 const availableWidth = parseFloat(containerStyle.width);
                 const availableHeight = parseFloat(containerStyle.height);
                 const defaultViewport = page.getViewport({ scale: 1 });
                 const scale = Math.min(availableWidth / defaultViewport.width, availableHeight / defaultViewport.height);
                 const viewport = page.getViewport({ scale: scale });


                const pageView = new pdfjsViewer.PDFPageView({
                    container: pageViewContainer,
                    id: pageNum,
                    scale: scale,
                    defaultViewport: viewport,
                    eventBus: eventBus,
                    // textLayerFactory: textLayerFactory, // REMOVED
                    textLayerMode: 2, // Use Mode 2 (Visible + Enhance)
                    // annotationLayerFactory: annotationLayerFactory, // REMOVED
                    annotationMode: 1, // ADDED: Enable annotation layer (e.g., for links)
                    linkService: linkService,
                    useOnlyCssZoom: false,
                    renderInteractiveForms: false,
                    enableScripting: false,
                });

                pageViews[pageNum] = pageView;

                pageView.setPdfPage(page);
                await pageView.draw();

                updateStatus(`PDFPageView drawn for page ${pageNum}`);
                hidePageLoading(containerId);

            } catch (e) {
                 console.error(`Error rendering page ${pageNum} with PDFPageView:`, e);
                 if (pageViews[pageNum]) {
                     pageViews[pageNum].destroy();
                     delete pageViews[pageNum];
                 }
                 if (pageViewContainer) pageViewContainer.innerHTML = '<div style="color:red; padding: 10px;">Error rendering page.</div>';
                 hidePageLoading(containerId);
            }
        }

        // --- Enhance Text Layer (unchanged from previous) ---
        function enhanceTextLayerKeywords(pageNum) { /* ... */ }

        // --- Listen for text layer rendering event (unchanged) ---
        eventBus.on('textlayerrendered', function(event) { /* ... */ });

        // --- Preloading (Keep simple) ---
        function preloadAdjacentPages(cp){ /* ... */ }

        // --- Update Display (unchanged from previous) ---
        async function updateDisplay() { /* ... */ }

        // --- Navigation (unchanged) ---
        function nextPage(){/*...*/}
        function prevPage(){/*...*/}
        function jumpToPage(pn){/*...*/}

        // --- View Modes (unchanged) ---
        function setSinglePageView(){/*... calls updateDisplay ...*/}
        function setDoublePageView(){/*... calls updateDisplay ...*/}
        function setRotatedView() {/*... calls updateDisplay then scales ...*/}

        // --- UI Toggles (unchanged) ---
        function toggleElement(id,show){/*...*/}
        function showTableOfContents(){/*...*/}
        function hideTableOfContents(){/*...*/}
        function showLoading(msg='Processing...'){/*...*/}
        function hideLoading(){/*...*/}

        // --- Slider Logic (unchanged) ---
        function showPageSlider(){/*...*/}
        function hidePageSlider(){/*...*/}
        function resetSliderHideTimer(){/*...*/}
        function initPageSlider(){/*...*/}
        function updateSliderTotalPages(){/*...*/}
        function updateSliderPosition(){/*...*/}
        function updateSliderStyle(sEl,val){/*...*/}

        // --- Load PDF (unchanged) ---
        async function loadPdf(source) { /* ... */ }

        // --- TOC population (unchanged) ---
        function populateTOC(){/* ... */}

        // --- Event Setup (unchanged) ---
        function setupEvents() { /* ... */ }

        // --- Definition Popup (unchanged) ---
        function showDefinitionPopup(word, definition, clickLeft, clickBottom) { /* ... */ }
        function hideDefinitionPopup() { /* ... */ }

        // --- Initialization (unchanged) ---
        async function init() { /* ... */ }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
