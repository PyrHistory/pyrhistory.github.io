<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Heritage History™ - Digital Book Reader</title>
    <!-- Use PDF.js v3.4.120 as specified -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf_viewer.css">
    <style>
:root{--primary:#4a90e2;--secondary:#50e3c2;--accent:#f5a623;--lab-blue:#080e1c;--page:#fff;--text-on-dark:rgba(255,255,255,.9);--text-on-page:#333;--header-h:60px;--page-w:650px;--page-h:842px;--page-padding:15px}
*{margin:0;padding:0;box-sizing:border-box}
html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; }
body{font-family:'Georgia',serif;background-color:var(--lab-blue);color:var(--text-on-dark);height:100vh;width:100vw;overflow:hidden;display:flex;flex-direction:column;position:fixed;line-height:1.6}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background-image:radial-gradient(circle at 15% 15%,rgba(249,115,22,.12) 0,transparent 45%),radial-gradient(circle at 85% 85%,rgba(197,83,235,.12) 0,transparent 45%),radial-gradient(circle at 85% 15%,rgba(56,189,248,.05) 0,transparent 40%),radial-gradient(circle at 15% 85%,rgba(251,191,36,.08) 0,transparent 40%);animation:ambient-shift 30s ease infinite alternate}
@keyframes ambient-shift{0%{background-position:0 0,0 0,0 0,0 0}100%{background-position:5% 10%,-5% -5%,10% -5%,-10% 5%}}
@media (prefers-reduced-motion:reduce){body::before{animation:none!important}}
#new-toolbar{position:fixed!important;top:15px!important;right:-60px!important;z-index:9999!important;display:flex!important;flex-direction:column!important;gap:10px!important;transition:right .3s ease,bottom .3s ease,transform .3s ease!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);padding:5px!important;border-radius:8px 0 0 8px!important;box-shadow:-2px 2px 10px rgba(0,0,0,.4)!important;width:58px;border:1px solid rgba(255,255,255,.1)}
#new-toolbar::before{content:"≡";position:absolute;left:-25px;top:50%;transform:translateY(-50%);background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);width:25px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:4px 0 0 4px;color:var(--text-on-dark);font-size:20px;box-shadow:-2px 2px 5px rgba(0,0,0,.3);transition:all .3s ease;border:1px solid rgba(255,255,255,.1);border-right:none;cursor:pointer}
.toolbar-trigger-area{position:fixed;top:0;right:0;width:30px;height:100%;z-index:9998;transition:all .3s ease}
#new-toolbar.visible{right:0!important;transform:none!important}
.new-btn{background:rgba(44,62,80,.8)!important;border:1px solid rgba(255,255,255,.15)!important;color:var(--text-on-dark)!important;width:48px!important;height:48px!important;border-radius:4px!important;display:flex!important;align-items:center!important;justify-content:center!important;font-size:25px!important;cursor:pointer!important;transition:all .2s!important;box-shadow:0 2px 5px rgba(0,0,0,.2)!important;user-select:none!important;flex-shrink:0}
.new-btn:hover{background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important;transform:translateY(-2px)!important}
.new-btn:active{transform:translateY(1px)!important}
.new-btn[disabled]{opacity:.5;cursor:not-allowed;pointer-events:none}
.rotated-mode #new-toolbar{top:auto!important;right:50%!important;bottom:-60px!important;transform:translateX(50%)!important;flex-direction:row!important;width:auto!important;height:58px!important;background:rgba(28,37,54,.9)!important;backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:8px 8px 0 0!important;padding:5px 10px!important;box-shadow:0 -2px 10px rgba(0,0,0,.4)!important;border:1px solid rgba(255,255,255,.1);border-bottom:none}
.rotated-mode #new-toolbar.visible{bottom:0!important;transform:translateX(50%)!important}
.rotated-mode #new-toolbar::before{left:50%!important;transform:translateX(-50%)!important;top:-25px!important;width:40px!important;height:25px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border-radius:4px 4px 0 0!important;content:"≡";padding-bottom:5px;color:var(--text-on-dark);border:1px solid rgba(255,255,255,.1);border-bottom:none;cursor:pointer}
.rotated-mode .toolbar-trigger-area{top:auto!important;bottom:0!important;left:0!important;transform:none!important;right:auto!important;width:100%!important;height:30px!important}
.rotated-mode #new-toolbar .new-btn{width:40px!important;height:40px!important;font-size:20px!important;transform: rotate(90deg)}
.rotated-mode .new-btn:hover {transform: rotate(90deg) scale(1.1);background:rgba(52,73,94,.9)!important;border-color:rgba(255,255,255,.25)!important;box-shadow:0 2px 8px rgba(0,0,0,.3)!important}
.rotated-mode .new-btn:active {transform: rotate(90deg) scale(0.95)}
.main-container{flex:1;display:flex;justify-content:center!important;align-items:center!important;padding:0;height:100%;width:100%;overflow:hidden;position:relative;background:transparent}
.book-spread{display:flex;box-shadow:0 10px 35px rgba(0,0,0,.5);position:fixed!important;top:50%!important;left:50%!important;transform-origin:center center;width:auto!important;height:auto!important;transition:transform .3s ease; transform: translate(-50%, -50%)}
.book-page{width:var(--page-w);height:var(--page-h);background-color:var(--page);position:relative;overflow:hidden; flex-shrink:0;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08);padding:0;}
.book-page.left{border-right:1px solid rgba(255,255,255,.15);border-radius:3px 0 0 3px}
.book-page.right{border-left:1px solid rgba(255,255,255,.15);border-radius:0 3px 3px 0}
.fullscreen-mode:not(.rotated-mode) .book-page.left{border-right:1px solid rgba(255,255,255,.08)!important}
.canvas-container { position: relative; width: calc(100% - 2 * var(--page-padding)); height: calc(100% - 2 * var(--page-padding)); margin: var(--page-padding); display: flex; justify-content: center; align-items: center; overflow: hidden; }
.pdf-canvas{max-width:100%;max-height:100%;display:block;object-fit:contain;box-shadow: none; position: absolute; top: 0; left: 0; z-index: 1; }
.page-number{display:none}
.page-loading-overlay{position:absolute;inset:var(--page-padding);background:rgba(255,255,255,.6);z-index:50;display:none;justify-content:center;align-items:center;border-radius:3px}
.page-loading-spinner{width:32px;height:32px;border-radius:50%;border:3px solid rgba(0,0,0,.1);border-top-color:var(--primary);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.page-edge-nav{position:absolute;top:0;height:100%;width:50px;cursor:pointer;z-index:10;transition:background-color .2s;-webkit-tap-highlight-color:transparent}
.page-edge-nav:hover{background-color:rgba(0,0,0,.03)}
.page-edge-left{left:0;border-radius:3px 0 0 3px}
.page-edge-right{right:0;border-radius:0 3px 3px 0}
.page-edge-left:hover::after,.page-edge-right:hover::after{content:"";position:absolute;top:50%;width:12px;height:12px;border-style:solid;border-color:rgba(0,0,0,.6);border-width:2px 2px 0 0;opacity:.8}
.page-edge-left:hover::after{left:18px;transform:translateY(-50%) rotate(-135deg)}
.page-edge-right:hover::after{right:18px;transform:translateY(-50%) rotate(45deg)}
.fullscreen-mode .book-page.right{display:none!important}
.fullscreen-mode .book-page.left{max-width:95vw;max-height:95vh;width:auto;height:auto;border-radius:5px!important;display:flex;justify-content:center;align-items:center;border:1px solid rgba(255,255,255,.08)!important;padding:0;}
.fullscreen-mode .canvas-container { margin: var(--page-padding); }
.fullscreen-mode .pdf-canvas{max-width:100%;max-height:100%;object-fit:contain; position:relative; z-index: 1; }
.rotated-mode .book-page.left{width:var(--page-w)!important;height:var(--page-h)!important;border-radius:0!important;border:none!important;padding:0 !important;background-color:var(--page);display:flex;justify-content:center;align-items:center}
.rotated-mode .canvas-container { margin: 10px !important; width: calc(100% - 20px); height: calc(100% - 20px); }
.rotated-mode .book-page.right{display:none!important}
.rotated-mode .pdf-canvas{box-shadow:none;max-width:100%;max-height:100%;object-fit:contain; position: relative; z-index: 1;}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page{width:var(--page-w);height:var(--page-h)}
.book-page.right.placeholder-page{background-color:var(--page)!important;border-left:1px solid rgba(0,0,0,.1);position:relative;display:flex!important;justify-content:center;align-items:center}
.book-page.right.placeholder-page::after{content:"End of document";font-size:14px;font-style:italic;color:rgba(0,0,0,.5)}
.book-page.right.placeholder-page .canvas-container,.book-page.right.placeholder-page .page-edge-nav,.book-page.right.placeholder-page .page-loading-overlay{display:none}
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.left .canvas-container::after { content: ''; position: absolute; top: 0; right: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to left, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 0 2px 2px 0; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right:not(.placeholder-page) .canvas-container::before { content: ''; position: absolute; top: 0; left: calc(0px - var(--page-padding)); width: 15px; height: 100%; background: linear-gradient(to right, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0)); pointer-events: none; z-index: 5; border-radius: 2px 0 0 2px; }
body:not(.fullscreen-mode):not(.rotated-mode) .book-page.right.placeholder-page { border-left: 1px solid rgba(0,0,0,.1) !important; }
.toc-panel{position:fixed;z-index:10000;display:none;color:var(--text-on-page); left:50%;top:50%;transform:translate(-50%,-50%);width:90%;max-width:500px;height:80vh;background:#f0f4f8;border-radius:8px;box-shadow:0 5px 25px rgba(0,0,0,.5);flex-direction:column;overflow:hidden}
.toc-panel.visible,.loading-overlay.visible{display:flex!important}
.toc-header{padding:15px 20px;background:var(--primary);color:#fff;font-weight:700;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.toc-header .notes-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer;padding:0 5px;line-height:1}
.toc-content{flex:1;padding:10px 20px;overflow-y:auto}
.toc-chapter{padding:8px 0;border-bottom:1px solid #d8dfe6}
.toc-chapter-title{font-weight:700;color:var(--primary);cursor:pointer;padding:5px 0}
.toc-chapter-title:hover,.toc-section:hover{color:var(--accent)}
.toc-sections{padding-left:20px;margin-top:5px}
.toc-section{padding:4px 0;cursor:pointer;color:#4a5568;font-size:.95em}
.loading-overlay{position:fixed;inset:0;background:rgba(8,14,28,.85);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);z-index:10001;display:none;justify-content:center;align-items:center;flex-direction:column}
.loading-spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.2);border-top-color:var(--accent);animation:spin 1s linear infinite;margin-bottom:15px}
.loading-message{font-size:16px;color:var(--text-on-dark)}
#status-indicator{display:none}
.page-slider-container{position:fixed;bottom:-80px;left:50%;transform:translateX(-50%);width:90%;max-width:700px;padding:14px 20px;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-bottom:none;box-shadow:0 -4px 20px rgba(0,0,0,.4);display:flex;flex-direction:column;align-items:center;z-index:9998;transition:bottom .35s cubic-bezier(.2,.9,.3,1),transform .35s cubic-bezier(.2,.9,.3,1), left .35s cubic-bezier(.2,.9,.3,1);border-radius:16px 16px 0 0}
.page-slider-container.visible{bottom:0}
.page-slider-track{width:100%;margin-bottom:8px;padding:0 10px}
.page-slider{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);outline:none;border-radius:3px;overflow:visible;cursor:pointer;transition:height .2s}
.page-slider:hover{height:8px}
.page-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition:all .2s ease;margin-top:-7px}
.page-slider::-webkit-slider-thumb:hover{width:24px;height:24px;margin-top:-8px}
.page-slider::-webkit-slider-runnable-track{height:100%;background:linear-gradient(to right,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%));border-radius:3px}
.page-slider::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4)}
.page-slider::-moz-range-thumb:hover{width:24px;height:24px}
.page-slider::-moz-range-progress{background-color:var(--accent);height:100%;border-radius:3px}
.page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);height:100%;border-radius:3px}
.page-slider-info{font-size:12px;color:var(--text-on-dark);font-weight:500;letter-spacing:.3px;opacity:.8}
.rotated-mode .page-slider-container{bottom:50%!important;left:-80px!important;top:auto!important;transform:translateY(50%)!important;width:60px!important;height:70vh!important;max-width:none!important;max-height:500px;flex-direction:column-reverse!important;padding:10px 5px!important;background:rgba(28,37,54,.9);backdrop-filter:blur(5px);-webkit-backdrop-filter:blur(5px);border:1px solid rgba(255,255,255,.1);border-left:none;border-radius:0 12px 12px 0!important;box-shadow:2px 0 20px rgba(0,0,0,.4)!important}
.rotated-mode .page-slider-container.visible{left:0!important}
.rotated-mode .page-slider-track{width:100%!important;height:100%!important;margin-bottom:0!important;padding:10px 0!important;display:flex;align-items:center;flex:1}
.rotated-mode .page-slider{width:6px!important;height:100%!important;writing-mode:vertical-lr!important;-webkit-appearance:slider-vertical!important;appearance:slider-vertical;margin:0 auto!important;padding:0!important;background:rgba(255,255,255,.1)!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-runnable-track{width:6px!important;height:100%;background:linear-gradient(to top,var(--accent) var(--slider-percent,0%),rgba(255,255,255,.1) var(--slider-percent,0%))!important;border-radius:3px}
.rotated-mode .page-slider::-webkit-slider-thumb{-webkit-appearance: none;appearance: none;width:20px!important;height:20px!important;border-radius: 50%;background: var(--accent);cursor: pointer;border: 3px solid rgba(28,37,54,.9)!important;box-shadow: 0 1px 6px rgba(0,0,0,.4);transition: all .2s ease;margin-top:0!important;margin-left:-7px!important}
.rotated-mode .page-slider:hover::-webkit-slider-thumb {width: 24px !important;height: 24px !important;margin-left: -9px !important}
.rotated-mode .page-slider::-moz-range-thumb{width: 20px;height: 20px;border-radius:50%;background:var(--accent);cursor:pointer;border:3px solid rgba(28,37,54,.9);box-shadow:0 1px 6px rgba(0,0,0,.4);transition: all .2s ease}
.rotated-mode .page-slider:hover::-moz-range-thumb {width: 24px;height: 24px}
.rotated-mode .page-slider::-moz-range-progress{background-color:var(--accent)!important;width:6px!important;border-radius:3px}
.rotated-mode .page-slider::-moz-range-track{background-color:rgba(255,255,255,.1);width:6px!important;border-radius:3px}
.rotated-mode .page-slider-info{transform:rotate(90deg);white-space:nowrap;margin-bottom:15px;padding-top:10px;color:var(--text-on-dark)}
#page-slider-trigger-zone {position: fixed;bottom: 0;left: 0;width: 100%;height: 30px;z-index: 9997;pointer-events: auto}
.rotated-mode #page-slider-trigger-zone {bottom: auto;top: 50%;left: 0;width: 30px;height: 100%;transform: translateY(-50%);pointer-events: auto;}

/* Text Layer & Keyword Styles */
.textLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; opacity: 1; line-height: 1.0; color: transparent; user-select: none; -webkit-user-select: none; pointer-events: none; z-index: 2; }
.textLayer > span[role="presentation"] { position: absolute; white-space: pre; cursor: text; transform-origin: 0% 0%; pointer-events: none; border-radius: 2px; color: transparent; }
.textLayer .keyword-interactive { pointer-events: auto !important; cursor: help !important; transition: background 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
.textLayer .keyword-hover-highlight { background: rgba(245, 166, 35, 0.35); box-shadow: 0 0 5px rgba(245, 166, 35, 0.3); }
/* Style for error message shown in text layer */
.textLayer .error-message { color: red; background: white; border: 1px solid red; padding: 5px; font-size: 12px; position: absolute; top: 5px; left: 5px; z-index: 10; pointer-events: none; }

/* Annotation Layer Styles */
.annotationLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; pointer-events: none; z-index: 3; }
.annotationLayer section { position: absolute; pointer-events: auto; }
.annotationLayer .linkAnnotation > a { position: absolute; font-size: 1em; top: 0; left: 0; width: 100%; height: 100%; border: 1px solid transparent; transition: border-color 0.2s ease-in-out, background-color 0.2s ease-in-out; }
.annotationLayer .linkAnnotation > a:hover { cursor: pointer; background-color: rgba(74, 144, 226, 0.2); border: 1px solid rgba(74, 144, 226, 0.4); box-shadow: 0px 0px 2px rgba(74, 144, 226, 0.3); }
/* Style for error message shown in annotation layer */
.annotationLayer .error-message { color: orange; background: white; border: 1px solid orange; padding: 5px; font-size: 12px; position: absolute; top: 5px; left: 5px; z-index: 10; pointer-events: none; }


/* Definition Pop-up Styles */
#definition-popup { display: none; position: fixed; z-index: 10002; background: white; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.25); padding: 12px 18px; max-width: 320px; min-width: 180px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; color: #333; line-height: 1.5; transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out; transform: scale(0.95) translateY(5px); opacity: 0; pointer-events: none; }
#definition-popup.visible { display: block; transform: scale(1) translateY(0); opacity: 1; pointer-events: auto; }
#close-popup-btn { position: absolute; top: 4px; right: 4px; background: none; border: none; font-size: 20px; font-weight: bold; cursor: pointer; color: #aaa; padding: 0 6px; line-height: 1; }
#close-popup-btn:hover { color: #555; }
#popup-word { display: block; margin-bottom: 8px; color: var(--primary); font-weight: bold; font-size: 15px; border-bottom: 1px solid #eee; padding-bottom: 6px; }
#popup-definition { max-height: 180px; overflow-y: auto; padding-right: 5px; margin-right: -5px; }
#popup-definition i { color: #777; }
#popup-definition span.error-message { color: #e74c3c; font-style: italic; }
#popup-definition::-webkit-scrollbar { width: 6px; }
#popup-definition::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px;}
#popup-definition::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px;}
#popup-definition::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body>
    <!-- HTML Structure remains the same -->
    <div id="new-toolbar"></div>
    <div class="toolbar-trigger-area" id="toolbar-trigger-area"></div>
    <div id="status-indicator">Status: Initializing...</div>
    <div class="main-container">
        <div class="book-spread">
            <div class="book-page left">
                <div class="canvas-container">
                    <canvas id="left-page-canvas" class="pdf-canvas"></canvas>
                    <div class="textLayer" id="left-text-layer"></div>
                    <div class="annotationLayer" id="left-annotation-layer"></div>
                </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="left-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
            <div class="book-page right placeholder-page">
                 <div class="canvas-container">
                    <canvas id="right-page-canvas" class="pdf-canvas"></canvas>
                     <div class="textLayer" id="right-text-layer"></div>
                     <div class="annotationLayer" id="right-annotation-layer"></div>
                 </div>
                <div class="page-edge-nav page-edge-left"></div>
                <div class="page-edge-nav page-edge-right"></div>
                <div class="page-number" id="right-page-number"></div>
                <div class="page-loading-overlay"><div class="page-loading-spinner"></div></div>
            </div>
        </div>
    </div>
    <div class="toc-panel" id="toc-panel"></div>
    <div class="loading-overlay" id="loading-overlay"></div>
    <div class="page-slider-container" id="page-slider-container"></div>
    <div id="page-slider-trigger-zone"></div>
    <div id="definition-popup">
        <button id="close-popup-btn" title="Close (Esc)">×</button>
        <strong id="popup-word">Word</strong>
        <div id="popup-definition">Definition</div>
    </div>

<script>
    // Populate Inner HTML directly
    document.getElementById('new-toolbar').innerHTML = `<button class="new-btn" id="single-page-btn" title="Single Page View">☰</button><button class="new-btn" id="double-page-btn" title="Double Page View">◫</button><button class="new-btn" id="rotate-btn" title="Rotate View">📱</button><button class="new-btn" id="toc-btn" title="Table of Contents" disabled>📑</button>`;
    document.getElementById('toc-panel').innerHTML = `<div class="toc-header"><span>Table of Contents</span><button class="notes-close" id="close-toc-btn">×</button></div><div class="toc-content"><div id="toc-list">Loading...</div></div>`;
    document.getElementById('loading-overlay').innerHTML = `<div class="loading-spinner"></div><div class="loading-message">Processing...</div>`;
    document.getElementById('page-slider-container').innerHTML = `<div class="page-slider-track"><input type="range" id="page-slider" class="page-slider" min="1" max="1" value="1" style="--slider-percent: 0%"></div><div class="page-slider-info"><span id="current-page-display">Page 1</span> of <span id="total-pages-display">1</span></div>`;
</script>
<script>
    'use strict'; // Enable Strict Mode

    // --- UI Elements ---
    const definitionPopup = document.getElementById('definition-popup');
    const popupWord = document.getElementById('popup-word');
    const popupDefinition = document.getElementById('popup-definition');
    const closePopupBtn = document.getElementById('close-popup-btn');
    const statusIndicator = document.getElementById('status-indicator');

    // --- State Variables ---
    let keywordDefinitions = {};
    let pageKeywords = {};
    let currentViewports = {};

    // --- ** DEBUG: Verify Library Objects ** ---
    console.log("Checking PDF.js library objects immediately after script load:");
    console.log("pdfjsLib (window['pdfjs-dist/build/pdf']):", window['pdfjs-dist/build/pdf']);
    console.log("pdfjsViewer (window['pdfjs-dist/web/pdf_viewer']):", window['pdfjs-dist/web/pdf_viewer']);
    // --- END DEBUG ---

    // Use the pdfjsViewer library namespace (assign AFTER logging to ensure they exist)
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    const pdfjsViewer = window['pdfjs-dist/web/pdf_viewer'];

    // Set worker source only if pdfjsLib is valid
    if (pdfjsLib) {
        pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    } else {
        console.error("FATAL: pdfjsLib is not available. PDF rendering cannot proceed.");
        // Display error to user?
    }

    // Global book state
    const book={title:"No Document",totalPages:0,currentPage:1,isDoublePageView:true,pdfDocument:null,outline:[]};
    const user={readingProgress:{furthestPage:1}};

    // Internal state variables
    let toolbarTimer=null;
    let toolbarHover=!1;
    const pageCache=new Map();
    const MAX_CACHE_SIZE=20;
    let PAGE_PADDING=15;
    let resizeTimer;
    let sliderHideTimeout=null;

    // Basic Link Service & Event Bus - check if pdfjsViewer is available
    const linkService = pdfjsViewer ? new pdfjsViewer.SimpleLinkService() : null;
    const eventBus = pdfjsViewer ? new pdfjsViewer.EventBus() : null;

    if (!linkService || !eventBus) {
        console.error("FATAL: pdfjsViewer components (SimpleLinkService or EventBus) are missing. Annotation/Text Layers may fail.");
    }

    // Helper function for logging status
    const updateStatus=m=>console.log(`[Viewer Status] ${m}`);
    // const updateStatus = () => {}; // Production version

    // --- Toolbar Logic ---
    function manageToolbar(s=null){const t=document.getElementById('new-toolbar');if(!t)return;clearTimeout(toolbarTimer);const show=s??toolbarHover;if(show){t.classList.add('visible')}else{toolbarTimer=setTimeout(()=>{if(!toolbarHover)t.classList.remove('visible')},500)}}
    function setupToolbarHover(){const t=document.getElementById('new-toolbar'),a=document.getElementById('toolbar-trigger-area'),h=t;if(!t||!a){console.error("Toolbar/trigger missing");return}const enter=()=>{toolbarHover=true;manageToolbar(true)};const leave=()=>{toolbarHover=false;manageToolbar(false)};a.addEventListener('mouseenter',enter);t.addEventListener('mouseenter',enter);a.addEventListener('mouseleave',leave);t.addEventListener('mouseleave',leave);h.addEventListener('click',e=>{if(e.target.closest('.new-btn'))return;const r=h.getBoundingClientRect(),i=document.body.classList.contains('rotated-mode');let c=false;const w=25,rh=25;if(i){if(e.clientX>=r.left&&e.clientX<=r.right&&e.clientY<r.top&&e.clientY>=r.top-rh)c=true}else{if(e.clientY>=r.top&&e.clientY<=r.bottom&&e.clientX<r.left&&e.clientX>=r.left-w)c=true}if(c){toolbarHover=!t.classList.contains('visible');manageToolbar()}});/*updateStatus("Toolbar setup.")*/} // Less verbose

    // --- Caching & Page Loading ---
    function trimCache(){while(pageCache.size>MAX_CACHE_SIZE){const keyToDelete = pageCache.keys().next().value; pageCache.delete(keyToDelete); /*updateStatus(`Cache trimmed, removed page ${keyToDelete}, size: ${pageCache.size}`)*/}}
    function showPageLoading(canvasId){ const overlay = document.getElementById(canvasId)?.closest('.book-page')?.querySelector('.page-loading-overlay'); if (overlay) overlay.style.display = 'flex'; }
    function hidePageLoading(canvasId){ const overlay = document.getElementById(canvasId)?.closest('.book-page')?.querySelector('.page-loading-overlay'); if (overlay) overlay.style.display = 'none'; }

    // --- Render Page Function ---
    async function renderPage(pageNum, canvasId) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas?.getContext('2d');
        const canvasContainer = canvas?.closest('.canvas-container');
        const textLayerContainer = canvasContainer?.querySelector('.textLayer');
        const annotationLayerContainer = canvasContainer?.querySelector('.annotationLayer');
        const pageElement = canvas?.closest('.book-page');

        delete currentViewports[canvasId];
        if (textLayerContainer) textLayerContainer.innerHTML = '';
        if (annotationLayerContainer) annotationLayerContainer.innerHTML = '';

        if (!book.pdfDocument || !canvas || !ctx || !canvasContainer || !textLayerContainer || !annotationLayerContainer || !pageElement || pageNum < 1 || pageNum > book.totalPages) {
            if (canvas && ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (pageElement) pageElement.classList.add('placeholder-page');
            hidePageLoading(canvasId);
            return;
        }

        showPageLoading(canvasId);
        pageElement.classList.remove('placeholder-page');

        let page;
        let viewport;

        try {
            const containerStyle = getComputedStyle(canvasContainer);
            const availableWidth = parseFloat(containerStyle.width);
            const availableHeight = parseFloat(containerStyle.height);

            if (availableWidth <= 0 || availableHeight <= 0) { console.warn(`Canvas container ${canvasId} has zero dimensions. Skipping render.`); hidePageLoading(canvasId); return; }

            page = await book.pdfDocument.getPage(pageNum);
            const defaultViewport = page.getViewport({ scale: 1 });
            const scale = Math.min(availableWidth / defaultViewport.width, availableHeight / defaultViewport.height);
            viewport = page.getViewport({ scale: scale });
            currentViewports[canvasId] = viewport;

            if (pageCache.has(pageNum)) {
                const cachedData = pageCache.get(pageNum);
                canvas.width = cachedData.width; canvas.height = cachedData.height;
                canvas.style.width = `${cachedData.styleWidth}px`; canvas.style.height = `${cachedData.styleHeight}px`;
                ctx.putImageData(cachedData.imageData, 0, 0);
                pageCache.delete(pageNum); pageCache.set(pageNum, cachedData); // LRU
                hidePageLoading(canvasId);
                // updateStatus(`Rendered canvas page ${pageNum} from cache`);
            } else {
                const outputScale = window.devicePixelRatio || 1;
                canvas.width = Math.floor(viewport.width * outputScale);
                canvas.height = Math.floor(viewport.height * outputScale);
                canvas.style.width = `${Math.floor(viewport.width)}px`;
                canvas.style.height = `${Math.floor(viewport.height)}px`;
                const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

                await page.render({ canvasContext: ctx, transform: transform, viewport: viewport }).promise;

                setTimeout(() => { // Defer caching
                    try {
                         const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                         pageCache.set(pageNum, {
                             imageData: imageData, width: canvas.width, height: canvas.height,
                             styleWidth: Math.floor(viewport.width), styleHeight: Math.floor(viewport.height),
                         });
                         trimCache();
                         // updateStatus(`Rendered canvas page ${pageNum} and cached`);
                     } catch(cacheError) { console.error(`Error caching page ${pageNum}:`, cacheError); if (pageCache.has(pageNum)) { pageCache.delete(pageNum); } }
                }, 50); // Increased defer slightly
                hidePageLoading(canvasId);
            }

            // Render layers using the CURRENT viewport
            await renderAndEnhanceTextLayer(page, textLayerContainer, viewport);
            await renderAnnotationLayer(page, annotationLayerContainer, viewport);

        } catch (error) {
            console.error(`Error rendering page ${pageNum} on ${canvasId}:`, error);
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
            hidePageLoading(canvasId);
            if (pageElement) pageElement.classList.add('placeholder-page');
        }
    }

    // --- ** REVISED renderAndEnhanceTextLayer with DEBUGGING ** ---
    async function renderAndEnhanceTextLayer(page, container, viewport) {
        const pageNum = page.pageNumber; // Get page number early for logging
        if (!page || !container || !viewport) {
            console.warn(`[Page ${pageNum}] Skipping text layer render: missing page, container, or viewport.`);
            return;
        }
        const keywordsForPage = pageKeywords[String(pageNum)] || [];
        container.innerHTML = ''; // Clear previous content

        let textLayerBuilder; // Declare builder variable outside try block

        try {
            // --- ** DEBUG: Check pdfjsViewer and TextLayerBuilder availability ** ---
            if (!pdfjsViewer) {
                throw new Error("pdfjsViewer namespace is not available.");
            }
             if (typeof pdfjsViewer.TextLayerBuilder !== 'function') {
                console.error(`[Page ${pageNum}] pdfjsViewer.TextLayerBuilder is NOT a function. Value:`, pdfjsViewer.TextLayerBuilder);
                throw new Error("pdfjsViewer.TextLayerBuilder is not a constructor.");
            }
             // --- END DEBUG ---

            const textContent = await page.getTextContent({ normalizeWhitespace: true });
             if (!textContent || !textContent.items || !Array.isArray(textContent.items)) {
                throw new Error("Invalid textContent received (missing items array).");
            }
            // console.log(`[Page ${pageNum}] Text Content Items:`, textContent.items); // Optional: log items if needed

            // --- Try Instantiating the Builder ---
            try {
                 textLayerBuilder = new pdfjsViewer.TextLayerBuilder({
                     textLayerDiv: container,
                     eventBus: eventBus, // Ensure eventBus is valid
                     pageIndex: page.pageIndex,
                     viewport: viewport,
                 });
                 // console.log(`[Page ${pageNum}] TextLayerBuilder Instantiated:`, textLayerBuilder); // Log successful instantiation
             } catch (instantiationError) {
                console.error(`[Page ${pageNum}] Failed to instantiate TextLayerBuilder:`, instantiationError);
                throw new Error(`TextLayerBuilder constructor failed: ${instantiationError.message}`);
            }


            // --- Use setTextContentItems (primary expectation for v3+) ---
             if (textLayerBuilder && typeof textLayerBuilder.setTextContentItems === 'function') {
                 textLayerBuilder.setTextContentItems(textContent.items);
             }
             // --- Fallback (Removed - caused confusion, focusing on why builder might be wrong) ---
             // else if (textLayerBuilder && typeof textLayerBuilder.setTextContent === 'function') {
             //     console.warn(`[Page ${pageNum}] setTextContentItems not found, attempting fallback to setTextContent.`);
             //     textLayerBuilder.setTextContent(textContent);
             // }
             else {
                 // This case implies instantiation succeeded but the method is missing - less likely now
                 console.error(`[Page ${pageNum}] TextLayerBuilder object instantiated but lacks setTextContentItems method.`, textLayerBuilder);
                 throw new Error("TextLayerBuilder instance is missing the setTextContentItems method.");
             }

            textLayerBuilder.render(); // Render the spans

            // --- Keyword Enhancement ---
            if (keywordsForPage.length > 0 && Object.keys(keywordDefinitions).length > 0) {
                const renderedSpans = container.querySelectorAll('span[role="presentation"]');
                let interactiveCount = 0;
                renderedSpans.forEach(span => {
                    if (!span.textContent?.trim()) return;
                    const spanText = span.textContent;
                    for (const originalKeyword of keywordsForPage) {
                        const lowerKeyword = originalKeyword.toLowerCase();
                        const escapedKeyword = originalKeyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const regex = new RegExp(`\\b(${escapedKeyword})\\b`, 'i');
                        if (regex.test(spanText)) {
                            const definition = keywordDefinitions[lowerKeyword];
                            if (definition) {
                                span.classList.add('keyword-interactive');
                                span.dataset.keyword = originalKeyword;
                                span.dataset.definition = definition;
                                span.title = `Click for definition of "${originalKeyword}"`;
                                interactiveCount++;
                                break;
                            }
                        }
                    }
                });
                // updateStatus(`Text layer rendered for page ${pageNum}. ${interactiveCount} interactive keywords found.`);
            }

        } catch (error) {
            console.error(`Error rendering/enhancing text layer for page ${pageNum}:`, error);
            // Display clear error message within the layer div itself
             container.innerHTML = `<div class="error-message">Text Layer Error (Page ${pageNum}):<br>${error.message}<br>Check console for details.</div>`;
        }
    }

    // --- Annotation Layer (minor debug improvement) ---
    async function renderAnnotationLayer(page, container, viewport) {
        const pageNum = page.pageNumber; // Get page number early
        if (!page || !container || !viewport) { console.warn(`[Page ${pageNum}] Skipping annotation layer render: missing page, container, or viewport.`); return; }
        container.innerHTML = '';
        try {
            // --- DEBUG: Check for AnnotationLayerBuilder ---
            if (!pdfjsViewer || typeof pdfjsViewer.AnnotationLayerBuilder !== 'function') {
                 console.error(`[Page ${pageNum}] pdfjsViewer.AnnotationLayerBuilder is NOT available. Value:`, pdfjsViewer?.AnnotationLayerBuilder);
                 throw new Error("pdfjsViewer.AnnotationLayerBuilder is not a constructor or pdfjsViewer is missing.");
             }
             if (!linkService) {
                 throw new Error("SimpleLinkService is not available for AnnotationLayerBuilder.");
             }
             // --- END DEBUG ---

            const annotations = await page.getAnnotations({ intent: 'display' });
            if (annotations.length === 0) { /* updateStatus(`Annotation layer: No annotations found on page ${pageNum}.`); */ return; }

            const annotationLayerBuilder = new pdfjsViewer.AnnotationLayerBuilder({
                pageDiv: container, pdfPage: page, linkService: linkService,
                downloadManager: null, annotationStorage: null, renderForms: false, enableScripting: false,
            });
            annotationLayerBuilder.render(viewport.clone({ dontFlip: true }));
            // updateStatus(`Annotation layer rendered for page ${pageNum} with ${annotations.length} annotations.`);
        } catch (error) {
            console.error(`Error rendering annotation layer for page ${pageNum}:`, error);
            container.innerHTML = `<div class="error-message" style="border-color:orange; color:orange;">Annotation Layer Error (Page ${pageNum}):<br>${error.message}</div>`;
        }
    }

    // --- Update Display (No changes needed) ---
    async function updateDisplay() { if (!book.pdfDocument) { /*updateStatus("UpdateDisplay skipped: No PDF loaded.");*/ return; } const lpNum = book.currentPage; const rpNum = book.isDoublePageView ? book.currentPage + 1 : 0; /*updateStatus(`Updating display for page(s): ${lpNum}${rpNum > 0 ? ' & ' + rpNum : ''}`);*/ const lDiv = document.querySelector('.book-page.left'); const rDiv = document.querySelector('.book-page.right'); const lNum = document.getElementById('left-page-number'); const rNum = document.getElementById('right-page-number'); if (!lDiv || !rDiv || !lNum || !rNum) { console.error("Critical page elements missing!"); return; } lDiv.style.visibility = 'hidden'; rDiv.style.display = 'none'; rDiv.classList.remove('placeholder-page'); const rCanvas = document.getElementById('right-page-canvas'), rCtx = rCanvas?.getContext('2d'); if (rCtx) rCtx.clearRect(0, 0, rCanvas.width, rCanvas.height); const rText = document.getElementById('right-text-layer'); if(rText) rText.innerHTML = ''; const rAnn = document.getElementById('right-annotation-layer'); if(rAnn) rAnn.innerHTML = ''; rNum.textContent = ''; if (lpNum >= 1 && lpNum <= book.totalPages) { lNum.textContent = String(lpNum); await renderPage(lpNum, 'left-page-canvas'); lDiv.style.visibility = 'visible'; } else { lDiv.style.visibility = 'hidden'; lNum.textContent = ''; const lCanvas = document.getElementById('left-page-canvas'), lCtx = lCanvas?.getContext('2d'); if (lCtx) lCtx.clearRect(0, 0, lCanvas.width, lCanvas.height); const lText = document.getElementById('left-text-layer'); if(lText) lText.innerHTML = ''; const lAnn = document.getElementById('left-annotation-layer'); if(lAnn) lAnn.innerHTML = ''; } if (book.isDoublePageView) { if (rpNum >= 1 && rpNum <= book.totalPages) { rNum.textContent = String(rpNum); rDiv.style.display = 'flex'; await renderPage(rpNum, 'right-page-canvas'); } else if (lpNum >= 1 && lpNum <= book.totalPages) { rDiv.style.display = 'flex'; rDiv.classList.add('placeholder-page'); rNum.textContent = ''; } else { rDiv.style.display = 'none'; } } updateSliderPosition(); setTimeout(() => preloadAdjacentPages(book.currentPage), 100); /*updateStatus("Display update complete.");*/ }

     // --- Preloading (No changes needed) ---
     function preloadAdjacentPages(currentPage) { if (!book.pdfDocument) return; const pL = []; const la = book.isDoublePageView ? 2 : 1; for (let i = 1; i <= la; i++) { const nps = currentPage + (book.isDoublePageView ? i * 2 : i); if (nps <= book.totalPages) pL.push(nps); if (book.isDoublePageView && nps + 1 <= book.totalPages) pL.push(nps + 1); const pps = currentPage - (book.isDoublePageView ? i * 2 : i); if (pps >= 1) pL.push(pps); if (book.isDoublePageView && pps + 1 >= 1 && pps + 1 < currentPage ) pL.push(pps + 1); } const uP = [...new Set(pL)].filter(p => p > 0 && p <= book.totalPages && !pageCache.has(p)); if (uP.length === 0) return; /*updateStatus(`Preloading pages: ${uP.join(', ')}`);*/ uP.forEach(pn => { (async () => { try { const pg = await book.pdfDocument.getPage(pn); const dV = pg.getViewport({ scale: 1 }); const sW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-w')) - (2 * PAGE_PADDING); const sH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-h')) - (2 * PAGE_PADDING); const sc = Math.min(sW / dV.width, sH / dV.height, 1.0); const vp = pg.getViewport({ scale: sc }); const tC = document.createElement('canvas'); const tX = tC.getContext('2d'); const oS = window.devicePixelRatio || 1; tC.width = Math.floor(vp.width * oS); tC.height = Math.floor(vp.height * oS); const tf = oS !== 1 ? [oS, 0, 0, oS, 0, 0] : null; await pg.render({ canvasContext: tX, transform: tf, viewport: vp }).promise; if (!pageCache.has(pn)) { const iD = tX.getImageData(0, 0, tC.width, tC.height); pageCache.set(pn, { imageData: iD, width: tC.width, height: tC.height, styleWidth: Math.floor(vp.width), styleHeight: Math.floor(vp.height) }); trimCache(); } } catch (err) { console.warn(`Preloading page ${pn} failed: ${err.message}`); if(pageCache.has(pn)) pageCache.delete(pn); } })(); }); }

    // --- Navigation ---
    function nextPage(){ const i = book.isDoublePageView ? 2 : 1; const t = book.currentPage + i; if (t <= book.totalPages) { jumpToPage(t); } else if (!book.isDoublePageView && book.currentPage < book.totalPages) { jumpToPage(book.totalPages); } }
    function prevPage(){ const d = book.isDoublePageView ? 2 : 1; const t = book.currentPage - d; if (t >= 1) { jumpToPage(t); } }
    function jumpToPage(pageNum){ if (!book.pdfDocument || pageNum < 1 || pageNum > book.totalPages) { /*console.warn(`Jump to page ${pageNum} out of bounds`);*/ return; } let targetPage = pageNum; if (book.isDoublePageView && targetPage > 1 && targetPage % 2 === 0) { targetPage--; } if (targetPage === book.currentPage) { return; } /*updateStatus(`Jumping to page ${targetPage}`);*/ book.currentPage = targetPage; if (targetPage > user.readingProgress.furthestPage) { user.readingProgress.furthestPage = targetPage; } hideDefinitionPopup(); updateDisplay(); showPageSlider(); manageToolbar(false); }

    // --- View Modes ---
    function applyCurrentViewModeStyles() { const i = document.body.classList.contains('rotated-mode'); const s = document.querySelector('.book-spread'); if (!s) return; if (i) { const w = window.innerWidth, h = window.innerHeight; const bW = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-w')), bH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-h')); const sX = w / bH, sY = h / bW; const sc = Math.min(sX, sY) * 0.95; s.style.transformOrigin = 'center center'; s.style.transform = `translate(-50%, -50%) rotate(90deg) scale(${sc})`; } else { s.style.transformOrigin = 'center center'; s.style.transform = 'translate(-50%, -50%)'; } }
    function setSinglePageView(){ if(!book.isDoublePageView && !document.body.classList.contains('rotated-mode')) return; /*updateStatus("Setting Single Page View");*/ book.isDoublePageView=false; document.body.classList.remove('rotated-mode'); document.body.classList.add('fullscreen-mode'); hideDefinitionPopup(); applyCurrentViewModeStyles(); updateDisplay().then(() => { manageToolbar(); updateSliderTotalPages(); updateSliderPosition(); }); }
    function setDoublePageView(){ if(book.isDoublePageView && !document.body.classList.contains('rotated-mode')) return; /*updateStatus("Setting Double Page View");*/ book.isDoublePageView=true; document.body.classList.remove('rotated-mode','fullscreen-mode'); if(book.currentPage > 1 && book.currentPage % 2 === 0) { book.currentPage--; } hideDefinitionPopup(); applyCurrentViewModeStyles(); updateDisplay().then(() => { manageToolbar(); updateSliderTotalPages(); updateSliderPosition(); }); }
    function setRotatedView() { if(document.body.classList.contains('rotated-mode')) return; /*updateStatus("Setting Rotated View");*/ book.isDoublePageView=false; document.body.classList.remove('fullscreen-mode'); document.body.classList.add('rotated-mode'); hideDefinitionPopup(); applyCurrentViewModeStyles(); updateDisplay().then(() => { manageToolbar(); updateSliderTotalPages(); updateSliderPosition(); }); }

    // --- UI Toggles ---
    function toggleElement(id,show){const el = document.getElementById(id); if(el) el.classList.toggle('visible',show)}
    function showTableOfContents(){if(!document.getElementById('toc-btn')?.disabled){toggleElement('toc-panel',true);manageToolbar(false)}}
    function hideTableOfContents(){toggleElement('toc-panel',false)}
    function showLoading(msg='Processing...'){const lo=document.getElementById('loading-overlay'),lm=lo?.querySelector('.loading-message');if(lo&&lm){lm.textContent=msg;lo.classList.add('visible')}}
    function hideLoading(){toggleElement('loading-overlay',false)}

    // --- Slider Logic ---
    function showPageSlider(){const s=document.getElementById('page-slider-container');if(s&&book.totalPages>0){s.classList.add('visible');resetSliderHideTimer()}}
    function hidePageSlider(){document.getElementById('page-slider-container')?.classList.remove('visible')}
    function resetSliderHideTimer(){clearTimeout(sliderHideTimeout);sliderHideTimeout=setTimeout(hidePageSlider,3500)}
    function initPageSlider(){const s=document.getElementById('page-slider'),sc=document.getElementById('page-slider-container');if(!s||!sc)return; let isDragging = false; s.addEventListener('input',()=>{ if (!isDragging) return; const pn=parseInt(s.value,10),d=document.getElementById('current-page-display'); if(d){ let pt=`Page ${pn}`; if(book.isDoublePageView && pn+1<=book.totalPages) pt+=`-${pn+1}`; d.textContent=pt; } updateSliderStyle(s,pn); resetSliderHideTimer(); }); s.addEventListener('pointerdown', () => { isDragging = true; clearTimeout(sliderHideTimeout); }); s.addEventListener('pointerup', () => { isDragging = false; resetSliderHideTimer(); }); s.addEventListener('change',()=>{ if (!isDragging) { jumpToPage(parseInt(s.value,10)); resetSliderHideTimer(); } }); sc.addEventListener('mouseenter',()=>clearTimeout(sliderHideTimeout)); sc.addEventListener('mouseleave',resetSliderHideTimer); updateSliderTotalPages(); updateSliderPosition(); }
    function updateSliderTotalPages(){const s=document.getElementById('page-slider'),d=document.getElementById('total-pages-display');if(s&&d){const t=book.totalPages>0?book.totalPages:1;s.max=t;d.textContent=t;updateSliderStyle(s,s.value)}}
    function updateSliderPosition(){const s=document.getElementById('page-slider'),d=document.getElementById('current-page-display');if(s&&d){const cp=book.currentPage>0?book.currentPage:1,tt=book.totalPages>0?book.totalPages:1;s.value=cp;let pt=`Page ${cp}`;if(book.isDoublePageView&&cp+1<=tt)pt+=`-${cp+1}`;d.textContent=pt;updateSliderStyle(s,cp)}}
    function updateSliderStyle(sEl,val){if(!sEl) return; const min=parseInt(sEl.min||1),max=parseInt(sEl.max||1),range=(max>min)?(max-min):1; const p=((parseInt(val)-min)/range)*100; sEl.style.setProperty('--slider-percent',`${Math.max(0,Math.min(100,p))}%`)}

    // --- Load PDF & Overlay ---
    async function loadPdf(pdfUrl) { updateStatus(`loadPdf started for: ${pdfUrl}`); showLoading("Initializing PDF..."); pageCache.clear(); currentViewports={}; keywordDefinitions={}; pageKeywords={}; if(book.pdfDocument){try{book.pdfDocument.destroy()}catch(e){console.warn("Error destroying previous PDF doc:", e)}} book.pdfDocument=null; book.totalPages=0; book.currentPage=1; book.title="No Document"; book.outline=[]; hideDefinitionPopup(); document.title = "Heritage History™ Reader"; document.getElementById('toc-btn').disabled = true; let filename = "Document"; try { filename = decodeURIComponent(pdfUrl.split('/').pop() || filename).replace(/\.pdf$/i, ''); } catch(e){} book.title = filename; try { const overlayUrl = pdfUrl.replace(/\.pdf$/i, '.overlay.json'); /*updateStatus(`Attempting to fetch overlay: ${overlayUrl}`);*/ const overlayPromise = fetch(overlayUrl) .then(response => { if (!response.ok) { throw new Error(`HTTP ${response.status} (${response.statusText}) fetching overlay`); } return response.json(); }) .then(data => { if (!data || typeof data.keywords !== 'object' || typeof data.pages !== 'object') { throw new Error("Invalid overlay JSON structure"); } keywordDefinitions = data.keywords || {}; pageKeywords = data.pages || {}; /*updateStatus(`Overlay loaded: ${Object.keys(keywordDefinitions).length} keywords, ${Object.keys(pageKeywords).length} pages defined.`);*/ return true; }) .catch(err => { console.warn(`Overlay file warning: ${err.message}. Interactive keywords will be disabled.`); keywordDefinitions = {}; pageKeywords = {}; return false; }); /*updateStatus("Starting PDF document loading...");*/ const loadingTask = pdfjsLib.getDocument(pdfUrl); book.pdfDocument = await loadingTask.promise; book.totalPages = book.pdfDocument.numPages; book.currentPage = 1; user.readingProgress.furthestPage = 1; /*updateStatus(`PDF loaded: ${book.title}, Pages: ${book.totalPages}`);*/ document.title = `${book.title} - Heritage History™ Reader`; await overlayPromise; showLoading("Processing metadata..."); /*updateStatus("Fetching outline...");*/ try { book.outline = await book.pdfDocument.getOutline(); populateTOC(); } catch (outlineError) { console.warn("Could not get PDF outline:", outlineError); book.outline = []; populateTOC(); } updateSliderTotalPages(); if (window.innerWidth < 1000) { setSinglePageView(); } else { setDoublePageView(); } } catch (error) { console.error("FATAL: Error loading PDF document:", error); alert(`Failed to load PDF: ${error.message || error}`); book.pdfDocument=null; book.totalPages=0; book.currentPage=1; book.title="Error Loading"; book.outline=[]; keywordDefinitions={}; pageKeywords={}; document.title="Heritage History™ Reader - Error"; updateSliderTotalPages(); updateSliderPosition(); populateTOC(); const spreadContainer = document.querySelector('.main-container .book-spread'); if (spreadContainer) { spreadContainer.innerHTML = `<div style="color: red; background: white; padding: 30px; text-align: center; width: 100%; border: 1px solid red; border-radius: 5px;">Failed to load document: ${error.message}</div>`; } } finally { hideLoading(); /*updateStatus("loadPdf finished.");*/ } }

    // --- TOC population ---
    function populateTOC() { const tl=document.getElementById('toc-list'),tb=document.getElementById('toc-btn'); if(!tl||!tb)return; tl.innerHTML=''; tb.disabled=true; if(!book.outline||book.outline.length===0){ tl.innerHTML='<em>No table of contents found.</em>'; /*updateStatus("TOC: No outline found.");*/ return; } /*updateStatus(`TOC: Populating with ${book.outline.length} top-level items.`);*/ const cTI=(item,level=0)=>{ const d=document.createElement('div'); d.className=level===0?'toc-chapter':'toc-section'; const ts=document.createElement('span'); ts.className=level===0?'toc-chapter-title':''; ts.textContent=item.title||'Untitled'; ts.style.cursor='pointer'; ts.title=`Go to: ${item.title||'Untitled'}`; ts.onclick=async(e)=>{ e.preventDefault(); /*updateStatus(`TOC Click: ${item.title}`);*/ try{ let pi=-1; if(typeof item.dest==='string'){ const dA=await book.pdfDocument.getDestination(item.dest); if(dA && typeof dA[0]==='object' && dA[0] !== null && 'num' in dA[0] && 'gen' in dA[0]){ pi=await book.pdfDocument.getPageIndex(dA[0]); } else { console.warn("Could not resolve named destination ref:", item.dest, dA); } } else if(Array.isArray(item.dest)&&typeof item.dest[0]==='object' && item.dest[0] !== null && 'num' in item.dest[0] && 'gen' in item.dest[0]){ pi=await book.pdfDocument.getPageIndex(item.dest[0]); } else { console.warn("Unknown/unsupported TOC dest format:", item.dest); } if(pi>=0){ jumpToPage(pi+1); hideTableOfContents(); } else { throw new Error(`Could not resolve page index for: ${item.title}`); } } catch(navError){ console.error("TOC nav error:", navError); alert(`Nav failed: ${navError.message}`); } }; d.appendChild(ts); if(item.items?.length>0){ const sl=document.createElement('div'); sl.style.paddingLeft='15px'; if(level===0) sl.className='toc-sections'; item.items.forEach(si=>{const se=cTI(si,level+1);if(se)sl.appendChild(se)}); if(sl.hasChildNodes()) d.appendChild(sl); } return d }; book.outline.forEach(ti=>{const te=cTI(ti);if(te)tl.appendChild(te)}); if(tl.hasChildNodes()){tb.disabled=false;} else {tl.innerHTML='<em>Error processing TOC.</em>';} }

    // --- Event Setup ---
    function setupEvents() { /*updateStatus("Setting up events");*/ const tbar=document.getElementById('new-toolbar'),mc=document.querySelector('.main-container'),bs=mc?.querySelector('.book-spread'); tbar?.addEventListener('click', e=>{ const b=e.target.closest('.new-btn'); if(!b||b.disabled)return; const i=b.id; /*updateStatus(`Toolbar click: ${i}`);*/ switch(i){ case 'single-page-btn': setSinglePageView(); break; case 'double-page-btn': setDoublePageView(); break; case 'rotate-btn': setRotatedView(); break; case 'toc-btn': showTableOfContents(); break; } toolbarHover=false; manageToolbar(false); }); document.getElementById('close-toc-btn')?.addEventListener('click', hideTableOfContents); closePopupBtn?.addEventListener('click', hideDefinitionPopup); if(bs){ bs.addEventListener('mouseover',e=>{ const kt=e.target.closest('.keyword-interactive'); if(kt) kt.classList.add('keyword-hover-highlight'); }); bs.addEventListener('mouseout',e=>{ const kt=e.target.closest('.keyword-interactive'); if(kt) kt.classList.remove('keyword-hover-highlight'); }); bs.addEventListener('click',e=>{ const tk=e.target.closest('.keyword-interactive'); if(tk){ e.stopPropagation(); const k=tk.dataset.keyword, d=tk.dataset.definition; if(k&&d){ const r=tk.getBoundingClientRect(); showDefinitionPopup(k,d,r.left,r.bottom,r.top); } return; } if(e.target.classList.contains('page-edge-nav')){ const p=e.target.closest('.book-page'); if(!p||p.classList.contains('placeholder-page'))return; if(e.target.classList.contains('page-edge-left')){prevPage();} else {nextPage();} showPageSlider(); manageToolbar(false); } }); } else { console.error("Book spread container not found for event delegation."); } document.addEventListener('keydown',e=>{ if(e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA'||document.getElementById('toc-panel')?.classList.contains('visible')||definitionPopup.classList.contains('visible')) return; if(e.ctrlKey||e.altKey||e.metaKey) return; let navAct=false; switch(e.key){ case 'ArrowRight': case 'PageDown': nextPage(); navAct=true; break; case 'ArrowLeft': case 'PageUp': prevPage(); navAct=true; break; case 'Home': if(book.totalPages>0) jumpToPage(1); navAct=true; break; case 'End': if(book.totalPages>0) jumpToPage(book.totalPages); navAct=true; break; case 'Escape': if(definitionPopup.classList.contains('visible')){hideDefinitionPopup();navAct=true;} else if(document.getElementById('toc-panel')?.classList.contains('visible')){hideTableOfContents();navAct=true;} break; } if(navAct){e.preventDefault();showPageSlider();manageToolbar(false)} }); window.addEventListener('resize',()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(()=>{ /*updateStatus("Resize detected.");*/ hideDefinitionPopup(); applyCurrentViewModeStyles(); updateDisplay(); manageToolbar(); },250); }); let tsX=0,tsY=0,tst=0; const SW_TH=50,SW_TL=500,SW_A=70; document.body.addEventListener('touchstart',e=>{ if(e.target.closest('#new-toolbar, .toolbar-trigger-area, #page-slider-container, #page-slider-trigger-zone, .toc-panel, .page-edge-nav, button, input, a, #definition-popup, .keyword-interactive, .annotationLayer section')){tsX=0;tsY=0;return;} if(e.touches.length===1){tsX=e.touches[0].screenX;tsY=e.touches[0].screenY;tst=Date.now();} else {tsX=0;tsY=0;} },{passive:true}); document.body.addEventListener('touchend',e=>{ if(tsX===0&&tsY===0||e.changedTouches.length!==1) return; const teX=e.changedTouches[0].screenX, teY=e.changedTouches[0].screenY; if(Date.now()-tst<SW_TL){ const dX=teX-tsX, dY=teY-tsY; if(Math.abs(dX)>SW_TH && Math.abs(dY)<SW_A){ if(dX>0){prevPage();} else {nextPage();} showPageSlider(); manageToolbar(false); } } tsX=0;tsY=0;tst=0; }); const sTrig=document.getElementById('page-slider-trigger-zone'),sCont=document.getElementById('page-slider-container'); if(sTrig&&sCont){ const enterTrig=()=>{if(book.pdfDocument&&book.totalPages>0){showPageSlider();clearTimeout(sliderHideTimeout);}}; const leaveTrigOrSlid=(ev)=>{const relT=ev.relatedTarget;if(!sCont.contains(relT)&&!sTrig.contains(relT)){resetSliderHideTimer();}}; sTrig.addEventListener('mouseenter',enterTrig); sCont.addEventListener('mouseenter',enterTrig); sTrig.addEventListener('mouseleave',leaveTrigOrSlid); sCont.addEventListener('mouseleave',leaveTrigOrSlid); } document.addEventListener('click',e=>{ if(definitionPopup.classList.contains('visible')&&!definitionPopup.contains(e.target)&&!e.target.closest('.keyword-interactive')) {hideDefinitionPopup();} },true); /*updateStatus("Events setup complete");*/ }

    // --- Definition Popup ---
    function showDefinitionPopup(word, definition, clickLeft, clickBottom, clickTop) { if (!definitionPopup || !popupWord || !popupDefinition || !closePopupBtn) return; const cleanDefinition = definition; popupWord.textContent = word; popupDefinition.innerHTML = cleanDefinition; let popupLeft = clickLeft; let popupTop = clickBottom + 8; definitionPopup.style.left = `0px`; definitionPopup.style.top = `0px`; definitionPopup.style.transform = 'scale(0.95) translateY(5px)'; definitionPopup.style.opacity = '0'; definitionPopup.classList.add('visible'); definitionPopup.style.pointerEvents = 'none'; requestAnimationFrame(() => { const popupRect = definitionPopup.getBoundingClientRect(); const winWidth = window.innerWidth; const winHeight = window.innerHeight; if (popupLeft + popupRect.width > winWidth - 10) { popupLeft = winWidth - popupRect.width - 10; } if (popupLeft < 10) { popupLeft = 10; } if (popupTop + popupRect.height > winHeight - 10) { popupTop = clickTop - popupRect.height - 8; definitionPopup.style.transform = 'scale(0.95) translateY(-5px)'; } if (popupTop < 10) { popupTop = 10; } definitionPopup.style.left = `${Math.max(5, popupLeft)}px`; definitionPopup.style.top = `${Math.max(5, popupTop)}px`; requestAnimationFrame(() => { definitionPopup.style.opacity = '1'; definitionPopup.style.transform = 'scale(1) translateY(0)'; definitionPopup.style.pointerEvents = 'auto'; }); }); }
    function hideDefinitionPopup() { if (definitionPopup && definitionPopup.classList.contains('visible')) { definitionPopup.style.opacity = '0'; definitionPopup.style.transform = 'scale(0.95)'; definitionPopup.style.pointerEvents = 'none'; setTimeout(() => { if (definitionPopup.style.opacity === '0') { definitionPopup.classList.remove('visible'); } }, 200); } }

    // --- Initialization ---
    async function init() {
        updateStatus("Initializing application...");
        // Add initial check for core libraries
        if (!pdfjsLib || !pdfjsViewer) {
             console.error("FATAL: PDF.js core library (pdfjsLib) or viewer components (pdfjsViewer) failed to load. Cannot initialize.");
             document.body.innerHTML = `<div style="color: red; background: white; padding: 20px; border: 2px solid red; font-family: monospace;">Application Initialization Error:<br>Core PDF.js libraries did not load correctly. Check CDN links and browser console.</div>`;
             return; // Stop initialization
        }

        try {
            try { PAGE_PADDING = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--page-padding')) || 15; }
            catch (cssVarError) { PAGE_PADDING = 15; console.warn("Could not read --page-padding CSS var, using default 15px."); }

            setupEvents();
            setupToolbarHover();
            initPageSlider();
            hideLoading();

            const urlParams = new URLSearchParams(window.location.search);
            const pdfUrlParam = urlParams.get('pdf');

            if (pdfUrlParam) {
                updateStatus(`PDF URL parameter found: ${pdfUrlParam}`);
                await loadPdf(pdfUrlParam);
            } else {
                updateStatus("No PDF specified in URL parameter (?pdf=...).");
                const spreadContainer = document.querySelector('.main-container .book-spread');
                 if(spreadContainer) {
                     spreadContainer.innerHTML = `<div style="color: var(--text-on-dark); background: rgba(28,37,54,.8); border-radius: 8px; padding: 40px; text-align: center; max-width: 500px; margin: auto;"><h2>Welcome</h2><p style="margin-top: 15px;">Load a document using the <code>?pdf=</code> URL parameter.</p><p style="margin-top:10px;font-size:0.9em;">Example: <code>?pdf=path/to/doc.pdf</code></p></div>`;
                 }
                 document.querySelector('.book-page.left')?.style.setProperty('visibility','hidden');
                 document.querySelector('.book-page.right')?.style.setProperty('display','none');
                 document.getElementById('page-slider-container')?.classList.remove('visible');
                 document.getElementById('new-toolbar')?.classList.remove('visible');
            }

            window.addEventListener('beforeunload', () => {
                /*updateStatus("Unloading - Clearing cache and destroying PDF object.");*/
                pageCache.clear();
                if (book.pdfDocument) { try { book.pdfDocument.destroy(); } catch(e){} book.pdfDocument = null; }
            });

            updateStatus("Initialization complete.");
        } catch (initError) {
            console.error("Initialization failed:", initError);
            document.body.innerHTML = `<div style="color: red; background: white; padding: 20px; border: 2px solid red; font-family: monospace;"><pre>Application Initialization Error:\n${initError.stack || initError}</pre></div>`;
        }
    }

    // --- Start the application ---
    // Ensure PDF.js libraries are loaded before initializing
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        // DOMContentLoaded has already fired
        init();
    }

</script>
</body>
</html>
